(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[660],{163300:(e,t,i)=>{"use strict";i.r(t),i.d(t,{OrderViewController:()=>Et});var s=i(870122),r=i(650151),o=i(737538),n=i(947488),a=i(116217),l=i(138966),u=i(771035),d=i(177441);function h(e){return(0,a.operate)((function(t,i){(0,u.innerFrom)(e).subscribe(new l.OperatorSubscriber(i,(function(){return i.complete()}),d.noop)),!i.closed&&t.subscribe(i)}))}var c=i(173587),p=i(937778),_=i(440891),y=i(621575),b=i(609838),g=i(193080),v=i(914314),P=i(997345),k=i(275734),m=i(757604),f=i(312694),S=i(265728),C=i(815544);var $={connector:function(){return new o.Subject},resetOnDisconnect:!0};function T(e,t){void 0===t&&(t=$);var i=null,s=t.connector,r=t.resetOnDisconnect,o=void 0===r||r,n=s(),a=new C.Observable((function(e){return n.subscribe(e)}));return a.connect=function(){var t;return i&&!i.closed||(i=(t=function(){return e},new C.Observable((function(e){(0,u.innerFrom)(t()).subscribe(e)}))).subscribe(n),o&&i.add((function(){return n=s()}))),i},a}var M=i(958261),w=i(586639),V=i(446685),I=i(472484),O=i(595940);function B(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=(0,O.popResultSelector)(e);return(0,a.operate)((function(t,s){for(var r=e.length,o=new Array(r),n=e.map((function(){return!1})),a=!1,h=function(t){(0,u.innerFrom)(e[t]).subscribe(new l.OperatorSubscriber(s,(function(e){o[t]=e,a||n[t]||(n[t]=!0,(a=n.every(I.identity))&&(n=null))}),d.noop))},c=0;c<r;c++)h(c);t.subscribe(new l.OperatorSubscriber(s,(function(e){if(a){var t=(0,V.__spreadArray)([e],(0,V.__read)(o),!1);s.next(i?i.apply(void 0,(0,V.__spreadArray)([],(0,V.__read)(t),!1)):t)}})))}))}var D=i(46415),L=i(599016),E=i(363111),q=i(391431),R=i(806188),F=i(996038),x=i(924910),Q=i(329452),A=i(172912),z=i(41899),N=i(14654),W=i(466479),j=i(567704),U=i(233064),G=i(346502),H=Array.isArray;function K(e){return 1===e.length&&H(e[0])?e[0]:e}var Y=i(423869);function J(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=(0,O.popResultSelector)(e),s=K(e);return s.length?new C.Observable((function(e){var t=s.map((function(){return[]})),r=s.map((function(){return!1}));e.add((function(){t=r=null}));for(var o=function(o){(0,u.innerFrom)(s[o]).subscribe(new l.OperatorSubscriber(e,(function(s){if(t[o].push(s),t.every((function(e){return e.length}))){var n=t.map((function(e){return e.shift()}));e.next(i?i.apply(void 0,(0,V.__spreadArray)([],(0,V.__read)(n),!1)):n),t.some((function(e,t){return!e.length&&r[t]}))&&e.complete()}}),(function(){r[o]=!0,!t[o].length&&e.complete()})))},n=0;!e.closed&&n<s.length;n++)o(n);return function(){t=r=null}})):Y.EMPTY}var X=i(464051);function Z(e,t){let i,s=0,r=0,o=!1;return(...n)=>{if(i=()=>{e(...n),i=void 0,o=!1},!o)return r=performance.now(),o=!0,void(s=function(e,t){if(window.requestIdleCallback)return window.requestIdleCallback(e,t);const i=Date.now();return setTimeout((()=>{e({didTimeout:!1,timeRemaining:()=>Math.max(0,50-(Date.now()-i))})}),1)}((()=>null==i?void 0:i()),t))
;void 0!==(null==t?void 0:t.timeout)&&performance.now()-r>=t.timeout&&(!function(e){if(window.cancelIdleCallback)return window.cancelIdleCallback(e);clearTimeout(e)}(s),i())}}var ee,te=i(80118);!function(e){e.makeInitialPrice=e=>{var t,i;return Boolean(e.trailingStopPips)?null:Boolean(e.guaranteedStop)?null!==(t=e.guaranteedStop)&&void 0!==t?t:null:null!==(i=e.stopLoss)&&void 0!==i?i:null},e.makeInitialEnabled=e=>Boolean(e.trailingStopPips)||Boolean(e.guaranteedStop)||Boolean(e.stopLoss),e.makeInitialBracketType=e=>Boolean(e.trailingStopPips)||e.stopType===D.StopType.TrailingStop?L.BracketType.TrailingStop:Boolean(e.guaranteedStop)||e.stopType===D.StopType.GuaranteedStop?L.BracketType.GuaranteedStop:L.BracketType.StopLoss}(ee||(ee={}));class ie{constructor({initialPrice:e,initialEnabled:t,initialBracketType:s,formatter:r,equity$:o,quotes$:a,info:l,pipValue$:u,side$:d,amount$:h,parentPrice$:c,orderType$:p,currency:_,parentType:y,savedPips:g,settings$:v,orderWidgetStat:k,showRiskControlsAndInfo:m,status:f,validationRulesByType:S,supportTrailingStop:C,supportGuaranteedStop:$,supportModifyBrackets:T,supportModifyTrailingStop:w,supportCryptoBrackets:V,supportAddBracketsToExistingOrder:I,hasTrailingStopBracket:O}){this.onControlFocused=new Q.Delegate,this.roundToStopLimitPriceStepRequired=!1,this._value$=new n.BehaviorSubject(null),this._pips$=new n.BehaviorSubject(null),this._price$=new n.BehaviorSubject(null),this._riskInCurrency$=new n.BehaviorSubject(null),this._riskInPercent$=new n.BehaviorSubject(null),this._focusedControl$=new n.BehaviorSubject(1),this._error$=new n.BehaviorSubject({res:!1}),this._controlError$=new n.BehaviorSubject({res:!1}),this._isValuesInitialized$=new n.BehaviorSubject(!1),this._subscriptions=[],this.getValue=()=>this._value$.getValue(),this.getFocusedControl=()=>this._focusedControl$.getValue(),this.getEnabled=()=>this._enabled$.getValue(),this.getBracketType=()=>this._bracketType$.getValue(),this.getError=()=>this._error$.getValue(),this.setFocusedControl=e=>{this._focusedControl$.next(e)},this.setEnabled=e=>{this._enabled$.next(e)},this.setBracketType=e=>{this._bracketType$.next(e)},this.setControlError=(e,t)=>{this._controlError$.next({res:e,msg:t})},this._handleBracketsValuesChange=e=>{const{enabled:t,parentPrice:i,sideSign:s,pipValue:r,equity:o,amount:n,bracketValuesWithFocusedControl:a}=e,{focusedControl:l,pips:u,price:d,riskInCurrency:h,riskInPercent:c}=a,{pips:p,price:_,riskInCurrency:y,riskInPercent:b}=this._calculateBracketValues({sideSign:s,pipValue:r,equity:o,parentPrice:i,amount:n,focusedControl:l,pips:u,price:d,riskInCurrency:h,riskInPercent:c});!t&&null!==h||u===p&&d===_&&h===y&&c===b||this._setUnfocusedControlsValues(l,p,_,y,b)},this._bracketValuesWithFocusedControlObservable=()=>this._focusedControl$.pipe((0,U.switchMap)((e=>1===e?this._priceObservable(e):2===e?this._riskInCurrencyObservable(e):3===e?this._riskInPercentObservable(e):this._pipsObservable(e)))),this._updateFocusIfNeeded=e=>{
const t=this.getFocusedControl(),i=this._supportCryptoBrackets?"showCryptoBracketsInPercent":"showBracketsInPercent",s=this._supportCryptoBrackets?"showCryptoBracketsInCurrency":"showBracketsInCurrency";(3===t&&!e[i]||2===t&&!e[s])&&this.setFocusedControl(0)},this._getPips=()=>this._pips$.getValue(),this._getPrice=()=>this._price$.getValue(),this._getRiskInCurrency=()=>this._riskInCurrency$.getValue(),this._getRiskInPercent=()=>this._riskInPercent$.getValue(),this._setPips=e=>{this._pips$.next((0,q.applyRounding)(e,this._pipsFormatter))},this._setPrice=e=>{this._price$.next((0,q.applyRounding)(e,this._priceFormatter))},this._setRiskInCurrency=e=>{this._riskInCurrency$.next((0,q.applyRounding)(e,this._riskInCurrencyFormatter))},this._setRiskInPercent=e=>{this._riskInPercent$.next((0,q.applyRounding)(e,this._riskInPercentFormatter))},this._makeBracketPercentPriceRuleCheckers=()=>{var e;const t=[],i=null===(e=this._validationRulesByType)||void 0===e?void 0:e[this._bracketType$.value];if(void 0!==i)for(const e of i)t.push((0,X.makeBracketPercentPriceRuleChecker)(e.options.min,e.options.max));return t},this.stopLossTypes=function(e,t){const i=[L.BracketType.StopLoss];return e&&i.push(L.BracketType.TrailingStop),t&&i.push(L.BracketType.GuaranteedStop),i}(Boolean(C),Boolean($)),this._handleBracketsValuesChange=Z(this._handleBracketsValuesChange,{timeout:100}),this._enabled$=new n.BehaviorSubject(t),this._bracketType$=new n.BehaviorSubject(s),this._equity$=o,this._pipValue$=u,this._side$=d,this._sideSign$=d.pipe((0,P.map)((e=>(s!==L.BracketType.TakeProfit?-1:1)*e))),this._quotes$=a,this._amount$=h,this._pipSize=l.pipSize,this._lotSize=l.lotSize,this._settings$=v,this._parentType=y,this._priceType=s===L.BracketType.TakeProfit?1:2,this._supportCryptoBrackets=Boolean(V),this._isStatusEditing=1!==y||f===E.OrderPanelStatus.Editing,this._pipsFormatter=new A.PriceFormatter({priceScale:l.pipSize!==l.minTick?10:1}),this._priceFormatter=r,this._riskInCurrencyFormatter=new A.PriceFormatter({priceScale:100}),this._riskInPercentFormatter=new A.PriceFormatter({priceScale:100}),this._priceMagnifier=l.priceMagnifier||1,this._hasTrailingStopBracket=O,this._validationRulesByType=S,this._parentPrice$=(0,M.combineLatest)({parentPrice:c,orderType:p,bracketType:this._bracketType$,quotes:this._quotes$,parentSide:this._side$}).pipe((0,P.map)((e=>{const{parentPrice:t,orderType:i,bracketType:s,quotes:r,parentSide:o}=e;if(s===L.BracketType.TrailingStop){if(2===i)return 1===o?(0,q.getAsk)(r):(0,q.getBid)(r);if(1!==this._parentType)return 1===o?(0,q.getBid)(r):(0,q.getAsk)(r)}return t}))),this._priceStep=(0,q.getPriceStep)({priceType:this._priceType,minTick:l.minTick||l.pipSize,limitPriceStep:l.limitPriceStep,stopPriceStep:l.stopPriceStep}),this.roundToStopLimitPriceStepRequired=(0,q.roundToStepRequired)({priceType:this._priceType,minTick:l.minTick||l.pipSize,limitPriceStep:l.limitPriceStep,stopPriceStep:l.stopPriceStep}),(0,M.combineLatest)({parentPrice:this._parentPrice$,sideSign:this._sideSign$,pipValue:this._pipValue$,equity:this._equity$,
amount:this._amount$}).pipe((0,G.take)(1)).subscribe((t=>{const{parentPrice:i,sideSign:r,pipValue:o,equity:n,amount:a}=t;let l,u,d=0;null!==e?(d=1,l=null,u=e):(l=null!==g?g:this._getDefaultPips(s),u=null);const{pips:h,price:c,riskInCurrency:p,riskInPercent:_}=this._calculateBracketValues({sideSign:r,pipValue:o,equity:n,parentPrice:i,amount:a,focusedControl:d,pips:l,price:u,riskInCurrency:null,riskInPercent:null});this.setFocusedControl(d),this._setPips(h),this._setPrice(c),this._setRiskInCurrency(p),this._setRiskInPercent(_),this._isValuesInitialized$.next(!0)})),this._bracketValuesWithFocusedControl$=this._bracketValuesWithFocusedControlObservable(),this.pips={value$:this._pips$.asObservable(),step:1,getValue:this._getPips,setValue:this._setPips,onModifiedCallback:null!==k?()=>k.setBracketControlModifiedProperty(s,E.BracketSubControlType.Pips):()=>{}},this.price={value$:this._price$.asObservable(),step:this._priceStep,getValue:this._getPrice,setValue:this._setPrice,onModifiedCallback:null!==k?()=>k.setBracketControlModifiedProperty(s,E.BracketSubControlType.Price):()=>{}},this.riskInCurrency={value$:this._riskInCurrency$.asObservable(),step:.01,getValue:this._getRiskInCurrency,setValue:this._setRiskInCurrency,onModifiedCallback:null!==k?()=>k.setBracketControlModifiedProperty(s,E.BracketSubControlType.Money):()=>{}},this.riskInPercent={value$:this._riskInPercent$.asObservable(),step:.01,getValue:this._getRiskInPercent,setValue:this._setRiskInPercent,onModifiedCallback:null!==k?()=>k.setBracketControlModifiedProperty(s,E.BracketSubControlType.Percent):()=>{}},this.value$=this._value$.asObservable(),this.enabled$=this._enabled$.asObservable(),this.bracketType$=this._bracketType$.asObservable(),this.focusedControl$=this._focusedControl$.asObservable(),this.error$=this._error$.asObservable(),this.isValuesInitialized$=this._isValuesInitialized$.asObservable(),this.controlState=this._computeControlState(y,s,T,w,I),this.currency=_.length>0?_:b.t(null,void 0,i(808249)),this.showRiskControlsAndInfo=m,this.supportTrailingStop=C,this.supportGuaranteedStop=$}subscribe(){const e=this._settings$.subscribe(this._updateFocusIfNeeded),t=(0,M.combineLatest)({enabled:this._enabled$,parentPrice:this._parentPrice$,sideSign:this._sideSign$,pipValue:this._pipValue$,equity:this._equity$,amount:this._amount$,bracketValuesWithFocusedControl:this._bracketValuesWithFocusedControl$}).subscribe(this._handleBracketsValuesChange),i=(0,M.combineLatest)({pips:this._pips$,error:this._error$,enabled:this._enabled$}).subscribe((e=>{const{pips:t,error:i,enabled:s}=e;this._value$.next(i.res||!s||null===t?null:t)}));return this._subscriptions=[e,t,i],this._subscriptions.push(this._subscribeError()),this._subscriptions}unsubscribe(){this._subscriptions.forEach((e=>e.unsubscribe()))}isValueIncorrect(){const e=this.getEnabled(),t=this.getValue();return e&&null===t}_getDefaultPips(e){return e===L.BracketType.TakeProfit?E.BracketDefaultPips.TakeProfit:E.BracketDefaultPips.StopLoss}_setUnfocusedControlsValues(e,t,i,s,r){0!==e&&this._setPips(t),
1!==e&&this._setPrice(i),2!==e&&this._setRiskInCurrency(s),3!==e&&this._setRiskInPercent(r)}_subscribeError(){return(0,M.combineLatest)({side:this._side$,enabled:this._enabled$,controlError:this._controlError$,bracketValuesWithFocusedControl:this._bracketValuesWithFocusedControl$,parentPrice:this._parentPrice$,quotes:this._quotes$,bracketType:this._bracketType$}).subscribe((e=>{const{side:t,enabled:i,controlError:s,bracketValuesWithFocusedControl:r,parentPrice:o,quotes:n,bracketType:a}=e,{focusedControl:l,pips:u,price:d}=r;i&&this._setError({side:t,parentPrice:o,quotes:n,bracketType:a,controlError:s,focusedControl:l,pips:u,price:d})}))}_setError(e){const{side:t,parentPrice:i,quotes:s,bracketType:r,controlError:o,focusedControl:n,pips:a,price:l}=e;o.res?this._error$.next(o):this._error$.next((0,X.checkBracketError)({quotes:s,side:t,price:l,pips:a,priceType:this._priceType,priceStep:this._priceStep,parentPrice:i,parentType:this._parentType,bracketType:r,isStatusEditing:this._isStatusEditing,isEnabled:this.getEnabled(),bracketPercentPriceRuleCheckers:this._makeBracketPercentPriceRuleCheckers(),priceFormatter:this._priceFormatter,isRoundToPriceStep:this.roundToStopLimitPriceStepRequired&&1===n}))}_pipsObservable(e){return this._pips$.pipe((0,U.switchMap)((t=>J([this._price$,this._riskInCurrency$,this._riskInPercent$]).pipe((0,P.map)((i=>{const[s,r,o]=i;return{focusedControl:e,pips:t,price:s,riskInCurrency:r,riskInPercent:o}}))))))}_priceObservable(e){return this._price$.pipe((0,U.switchMap)((t=>J([this._pips$,this._riskInCurrency$,this._riskInPercent$]).pipe((0,P.map)((i=>{const[s,r,o]=i;return{focusedControl:e,pips:s,price:t,riskInCurrency:r,riskInPercent:o}}))))))}_riskInCurrencyObservable(e){return this._riskInCurrency$.pipe((0,U.switchMap)((t=>J([this._pips$,this._price$,this._riskInPercent$]).pipe((0,P.map)((i=>{const[s,r,o]=i;return{focusedControl:e,pips:s,price:r,riskInCurrency:t,riskInPercent:o}}))))))}_riskInPercentObservable(e){return this._riskInPercent$.pipe((0,U.switchMap)((t=>J([this._pips$,this._price$,this._riskInCurrency$]).pipe((0,P.map)((i=>{const[s,r,o]=i;return{focusedControl:e,pips:s,price:r,riskInCurrency:o,riskInPercent:t}}))))))}_calculateBracketValues(e){return{pips:(0,q.applyRounding)(this._calculatePips(e),this._pipsFormatter),price:(0,q.applyRounding)(this._calculatePrice(e),this._priceFormatter),riskInCurrency:(0,q.applyRounding)(this._calculateRiskInCurrency(e),this._riskInCurrencyFormatter),riskInPercent:(0,q.applyRounding)(this._calculateRiskInPercent(e),this._riskInPercentFormatter)}}_calculatePips(e){const{sideSign:t,pipValue:i,equity:s,parentPrice:r,amount:o,focusedControl:n,pips:a,price:l,riskInCurrency:u,riskInPercent:d}=e;switch(n){case 0:default:return a;case 1:return null===l?null:(0,te.priceToPips)(l,r,t,this._pipSize);case 2:return null===u||null===o?null:(0,te.riskInCurrencyToPips)(u,o,i,this._priceMagnifier,this._lotSize);case 3:return null===d||null===o?null:(0,te.riskInPercentToPips)(d,o,s,i,this._priceMagnifier,this._lotSize)}}_calculatePrice(e){
const{sideSign:t,pipValue:i,equity:s,parentPrice:r,amount:o,focusedControl:n,pips:a,price:l,riskInCurrency:u,riskInPercent:d}=e;let h,c;switch(n){case 0:default:if(null===a)return null;c=(0,te.pipsToPrice)(a,r,t,this._pipSize);break;case 1:return l;case 2:if(null===u||null===o)return null;h=(0,te.riskInCurrencyToPips)(u,o,i,this._priceMagnifier,this._lotSize),c=(0,te.pipsToPrice)(h,r,t,this._pipSize);break;case 3:if(null===d||null===o)return null;h=(0,te.riskInPercentToPips)(d,o,s,i,this._priceMagnifier,this._lotSize),c=(0,te.pipsToPrice)(h,r,t,this._pipSize)}return this.roundToStopLimitPriceStepRequired?(0,y.roundToStepByPriceTypeAndSide)(c,this._priceStep,this._priceType,t):c}_calculateRiskInCurrency(e){const{sideSign:t,pipValue:i,equity:s,parentPrice:r,amount:o,focusedControl:n,pips:a,price:l,riskInCurrency:u,riskInPercent:d}=e;let h;const c=null===a||null===o;switch(n){case 0:default:return c?null:(0,te.pipsToRiskInCurrency)(a,o,i,this._priceMagnifier,this._lotSize);case 1:return null===l||c?null:(h=(0,te.priceToPips)(l,r,t,this._pipSize),(0,te.pipsToRiskInCurrency)(h,o,i,this._priceMagnifier,this._lotSize));case 2:return u;case 3:return null===d||c?null:(h=(0,te.riskInPercentToPips)(d,o,s,i,this._priceMagnifier,this._lotSize),(0,te.pipsToRiskInCurrency)(h,o,i,this._priceMagnifier,this._lotSize))}}_calculateRiskInPercent(e){const{sideSign:t,pipValue:i,equity:s,parentPrice:r,amount:o,focusedControl:n,pips:a,price:l,riskInCurrency:u,riskInPercent:d}=e;let h;const c=null===a||null===o;switch(n){case 0:default:return c?null:(0,te.pipsToRiskInPercent)(a,o,s,i,this._priceMagnifier,this._lotSize);case 1:return null===l||c?null:(h=(0,te.priceToPips)(l,r,t,this._pipSize),(0,te.pipsToRiskInPercent)(h,o,s,i,this._priceMagnifier,this._lotSize));case 2:return null===u||null===o?null:(h=(0,te.riskInCurrencyToPips)(u,o,i,this._priceMagnifier,this._lotSize),(0,te.pipsToRiskInPercent)(h,o,s,i,this._priceMagnifier,this._lotSize));case 3:return d}}_computeControlState(e,t,i,s,r){const o=this._isStatusEditing&&t===L.BracketType.TrailingStop&&!s&&this._hasTrailingStopBracket,n=this._isStatusEditing&&t!==L.BracketType.TakeProfit&&this.getEnabled()&&!s&&this._hasTrailingStopBracket,a=this._isStatusEditing&&!i,l=Boolean(1===e&&this._isStatusEditing&&!this.getEnabled()&&!r);return{inputDisabled:o||a||l,labelDisabled:n||a||l,checkboxDisabled:a||l}}}class se{constructor({displaySymbolName:e,symbol:t,brokerName:i,quotes$:s,mode$:r,status$:n,parentType:a,isExistingOrder:l,isTradable:u,data:d,formatter:c,isBats:p=!1,informerMessage$:_,headerState:y,isOrderPresetsEnabled:b=!1,brokerId:g}){this._stopSubscriptions$=new o.Subject,this._pinButtonClicked=new Q.Delegate,this._backButtonClicked=new Q.Delegate,this._closeButtonClicked=new Q.Delegate,this._onStatusChanged=(e,t)=>{this._headerState.setTitle(this._title(e)),this._headerState.setDescription(this._text(e)),this._headerState.setCloseFunction(this._hasCloseButton(t)?()=>this.close():void 0),this._headerState.setBackFunction(this._hasBackButton(e,t)?()=>this.back():void 0),
this._headerState.setOrderPresets(this._hasPresetsButton(e)?[]:void 0),this._headerState.setBrokerId(this._brokerId)},this._onQuotes=e=>{this._headerState.setHasDelayedQuotes(Boolean(e.isDelayed))},this._headerState=y,this._data=d,this._displaySymbolName=e,this._formatter=c,this._brokerName=i,this._brokerId=g,this._parentType=a,this._isExistingOrder=l,this._isOrderPresetsEnabled=b,(0,M.combineLatest)({status:n,mode:r}).pipe(h(this._stopSubscriptions$)).subscribe((({status:e,mode:t})=>this._onStatusChanged(e,t))),(0,M.combineLatest)({status:n,mode:r}).pipe((0,G.take)(1)).subscribe((({status:e,mode:i})=>{this._onStatusChanged(e,i),this._headerState.setSymbol(t),this._headerState.setHasDelayedQuotes(!1),this._headerState.setHasBatsQuotes(p),this._headerState.setIsTradable(u)})),s&&s.pipe(h(this._stopSubscriptions$)).subscribe(this._onQuotes),void 0!==_&&_.pipe(h(this._stopSubscriptions$)).subscribe((e=>this._headerState.setInformerMessage(e)))}unsubscribe(){this._stopSubscriptions$.next(),this._stopSubscriptions$.complete()}back(){this._backButtonClicked.fire()}pin(){this._pinButtonClicked.fire()}close(){this._closeButtonClicked.fire()}pinButtonClicked(){return this._pinButtonClicked}backButtonClicked(){return this._backButtonClicked}closeButtonClicked(){return this._closeButtonClicked}_hasBackButton(e,t){return t===E.OrderEditorDisplayMode.Panel&&(this._isExistingOrder||1!==this._parentType||e===E.OrderPanelStatus.Preview)}_hasPresetsButton(e){return this._isOrderPresetsEnabled&&(e===E.OrderPanelStatus.Active||e===E.OrderPanelStatus.Wait)&&1===this._parentType}_hasCloseButton(e){return e!==E.OrderEditorDisplayMode.ResizableDrawer&&_.enabled("order_panel_close_button")}_title(e){return e===E.OrderPanelStatus.Preview?b.t(null,void 0,i(88346)):this._displaySymbolName}_text(e){if(e!==E.OrderPanelStatus.Preview){if(!this._isExistingOrder||void 0===this._data||void 0===this._formatter)return this._brokerName||void 0;if(1===this._parentType)return b.t(null,void 0,i(258063))+" "+this._data.id;if(2===this._parentType||3===this._parentType){const e=this._data.side,t=this._data.qty,s=this._formatter.format(this._data.price||this._data.avgPrice||this._data.limitPrice);return(1===e?b.t(null,void 0,i(728257)):b.t(null,void 0,i(13009)))+" "+t+" @ "+s}}}}var re=function(e){function t(t,i){return e.call(this)||this}return(0,V.__extends)(t,e),t.prototype.schedule=function(e,t){return void 0===t&&(t=0),this},t}(i(303448).Subscription),oe={setInterval:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=oe.delegate;return((null==i?void 0:i.setInterval)||setInterval).apply(void 0,(0,V.__spreadArray)([],(0,V.__read)(e),!1))},clearInterval:function(e){var t=oe.delegate;return((null==t?void 0:t.clearInterval)||clearInterval)(e)},delegate:void 0},ne=i(3955),ae=function(e){function t(t,i){var s=e.call(this,t,i)||this;return s.scheduler=t,s.work=i,s.pending=!1,s}return(0,V.__extends)(t,e),t.prototype.schedule=function(e,t){if(void 0===t&&(t=0),this.closed)return this;this.state=e;var i=this.id,s=this.scheduler
;return null!=i&&(this.id=this.recycleAsyncId(s,i,t)),this.pending=!0,this.delay=t,this.id=this.id||this.requestAsyncId(s,this.id,t),this},t.prototype.requestAsyncId=function(e,t,i){return void 0===i&&(i=0),oe.setInterval(e.flush.bind(e,this),i)},t.prototype.recycleAsyncId=function(e,t,i){if(void 0===i&&(i=0),null!=i&&this.delay===i&&!1===this.pending)return t;oe.clearInterval(t)},t.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var i=this._execute(e,t);if(i)return i;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},t.prototype._execute=function(e,t){var i,s=!1;try{this.work(e)}catch(e){s=!0,i=e||new Error("Scheduled action threw falsy error")}if(s)return this.unsubscribe(),i},t.prototype.unsubscribe=function(){if(!this.closed){var t=this.id,i=this.scheduler,s=i.actions;this.work=this.state=this.scheduler=null,this.pending=!1,(0,ne.arrRemove)(s,this),null!=t&&(this.id=this.recycleAsyncId(i,t,null)),this.delay=null,e.prototype.unsubscribe.call(this)}},t}(re),le=i(712813),ue=function(){function e(t,i){void 0===i&&(i=e.now),this.schedulerActionCtor=t,this.now=i}return e.prototype.schedule=function(e,t,i){return void 0===t&&(t=0),new this.schedulerActionCtor(this,e).schedule(i,t)},e.now=le.dateTimestampProvider.now,e}(),de=new(function(e){function t(t,i){void 0===i&&(i=ue.now);var s=e.call(this,t,i)||this;return s.actions=[],s._active=!1,s._scheduled=void 0,s}return(0,V.__extends)(t,e),t.prototype.flush=function(e){var t=this.actions;if(this._active)t.push(e);else{var i;this._active=!0;do{if(i=e.execute(e.state,e.delay))break}while(e=t.shift());if(this._active=!1,i){for(;e=t.shift();)e.unsubscribe();throw i}}},t}(ue))(ae),he=de,ce={leading:!0,trailing:!1};var pe=i(337160);function _e(e,t,i){void 0===e&&(e=0),void 0===i&&(i=he);var s=-1;return null!=t&&((0,pe.isScheduler)(t)?i=t:s=t),new C.Observable((function(t){var r,o=(r=e)instanceof Date&&!isNaN(r)?+e-i.now():e;o<0&&(o=0);var n=0;return i.schedule((function(){t.closed||(t.next(n++),0<=s?this.schedule(void 0,s):t.complete())}),o)}))}function ye(e,t,i){void 0===t&&(t=de),void 0===i&&(i=ce);var s,r,o,n,d,h=_e(e,t);return s=function(){return h},n=(o=void 0===(r=i)?ce:r).leading,d=o.trailing,(0,a.operate)((function(e,t){var i=!1,r=null,o=null,a=!1,h=function(){null==o||o.unsubscribe(),o=null,d&&(_(),a&&t.complete())},c=function(){o=null,a&&t.complete()},p=function(e){return o=(0,u.innerFrom)(s(e)).subscribe(new l.OperatorSubscriber(t,h,c))},_=function(){if(i){i=!1;var e=r;r=null,t.next(e),!a&&p(e)}};e.subscribe(new l.OperatorSubscriber(t,(function(e){i=!0,r=e,(!o||o.closed)&&(n?_():p(e))}),(function(){a=!0,(!(d&&i&&o)||o.closed)&&t.complete()})))}))}class be{constructor({initialSide:e,quotes$:t,priceFormatter:i,spreadFormatter:s,baseCurrency:r}){this.baseCurrency=null,this.onControlFocused=new Q.Delegate,this._formattedQuotes$=new n.BehaviorSubject({ask:" ",bid:" "}),this._restrictionTypes$=new n.BehaviorSubject([]),this._quotes={ask:0,bid:0},
this._waitQuotesTimeout=void 0,this._subscriptions=[],this.getValue=()=>this._value$.getValue(),this.setValue=e=>{this._value$.next(e)},this.getFormattedQuotes=()=>this._formattedQuotes$.getValue(),this.currentQuotes=()=>this._quotes,this.getRestrictionTypes=()=>this._restrictionTypes$.getValue(),this._value$=new n.BehaviorSubject(e),this.value$=this._value$.asObservable(),this.formattedQuotes$=this._formattedQuotes$.asObservable(),this.restrictionTypes$=this._restrictionTypes$.asObservable(),this.baseCurrency=r,this._quotes$=t,this._priceFormatter=i,this._spreadFormatter=s}subscribe(){this._waitQuotesTimeout=setTimeout((()=>{this._formattedQuotes$.next({}),this._quotes={}}),5e3);const e=this._quotes$.subscribe((e=>{this._formattedQuotes$.next(this._generateText(e)),this._quotes=e,clearTimeout(this._waitQuotesTimeout)})),t=this._quotes$.pipe(ye(2e3,de,{leading:!0,trailing:!0})).subscribe((e=>{this._restrictionTypes$.next(this._generateRestrictionTypes(e))}));return this._subscriptions=[e,t],this._subscriptions}unsubscribe(){this._subscriptions.forEach((e=>e.unsubscribe())),clearTimeout(this._waitQuotesTimeout)}_generateText(e){const t={},i=(0,q.getAsk)(e),s=(0,q.getBid)(e);return t.ask=this._priceFormatter.format(i),t.bid=this._priceFormatter.format(s),t.spread=(0,z.isNumber)(e.spread)?this._spreadFormatter.format(e.spread):this._priceFormatter.format(i-s),t}_generateRestrictionTypes(e){const t=[];return e.isHalted&&t.push(L.RestrictionType.Halted),e.isHardToBorrow&&t.push(L.RestrictionType.HardToBorrow),e.isNotShortable&&t.push(L.RestrictionType.NotShortable),t}}var ge,ve=i(218286),Pe=i(477071);!function(e){e.Ask="ask",e.Bid="bid",e.Stop="stop",e.None=""}(ge||(ge={}));const ke=b.t(null,void 0,i(402043));function me(e,t){return e.res===t.res&&e.msg===t.msg&&e.severity===t.severity}class fe{constructor(e){this._formatter=e}format(e,t){return this._formatter.format(e,{...t,ignoreLocaleNumberFormat:!0})}parse(e,t){return this._formatter.parse?this._formatter.parse(e,{...t,ignoreLocaleNumberFormat:!0}):{res:!1,error:"Formatter does not support parse"}}}class Se{constructor({priceType:e,quotes$:t,side$:s,info:r,status$:o,formatter:a,orderType$:l,settings$:u,brokerTitle:d,orderWidgetStat:h,getSettings:c,initialPrice:p,orderRules:_,forceAbsolutePriceUpdate:g,stopPriceControlData$:v,supportStopOrdersInBothDirections:k,supportStopLimitOrdersInBothDirections:m,supportStrictCheckingLimitOrderPrice:f}){var S,C;this.id=(0,x.randomHashN)(6),this.onControlFocused=new Q.Delegate,this._focusedControl$=new n.BehaviorSubject(0),this._priceControlData$=new n.BehaviorSubject(null),this._value$=new n.BehaviorSubject(null),this._error$=new n.BehaviorSubject({res:!1}),this._controlError$=new n.BehaviorSubject({res:!1}),this._subscriptions=[],this._symbolType="",this._priceRules=[],this._stopLimitPercentPriceRuleCheckers=[],this.getError=()=>this._error$.getValue(),this.setControlError=(e,t)=>{this._controlError$.next({res:e,severity:"error",msg:t})},this.setAbsolutePrice=e=>{var t;const i=(0,q.parseValue)(e,this.formatter);if(!i.res){
const i=null!==(t=this.getPriceControlData())&&void 0!==t?t:{index:0,value:0,absolutePrice:"",offset:0,base:"ask"};return void this._setPrice({...i,absolutePrice:e})}const s=i.value,r=this._priceToIndex(s);let o=0;(0,M.combineLatest)({focusedControl:this._focusedControl$,quotes:this.quotes$,stopPriceControlData:this._stopPriceControlData$,side:this.side$,orderType:this.orderType$}).pipe((0,G.take)(1)).subscribe((t=>{const{quotes:i,stopPriceControlData:n,side:a,orderType:l}=t,u=this._getBase(a,l);switch(u){case"stop":null!==n&&(o=Math.round(r-n.index));break;case"ask":const e=this._priceToIndex((0,q.getAsk)(i));o=Math.round(r-e);break;case"bid":const t=this._priceToIndex((0,q.getBid)(i));o=Math.round(r-t)}this._setPrice({index:r,value:s,absolutePrice:e,offset:o,base:u})}))},this.setPriceValue=(e,t=!1)=>{(0,M.combineLatest)({focusedControl:this._focusedControl$,quotes:this.quotes$,stopPriceControlData:this._stopPriceControlData$,side:this.side$,orderType:this.orderType$}).pipe((0,G.take)(1)).subscribe((i=>{const{quotes:s,stopPriceControlData:r,side:o,orderType:n}=i;(this._roundToStepRequired()||t)&&(e=(0,y.roundToStepByPriceTypeAndSide)(e,this.getStep(e),this.priceType,o));const a=this._priceToIndex(e),l=this._getBase(o,n);let u=0;switch(l){case"stop":null!==r&&(u=Math.round(a-r.index));break;case"ask":const e=this._priceToIndex((0,q.getAsk)(s));u=Math.round(a-e);break;case"bid":const t=this._priceToIndex((0,q.getBid)(s));u=Math.round(a-t)}this._setPrice({index:a,value:e,absolutePrice:this.formatter.format(e),offset:u,base:l})}))},this.setPriceOffset=e=>{(0,M.combineLatest)({focusedControl:this._focusedControl$,quotes:this.quotes$,stopPriceControlData:this._stopPriceControlData$,side:this.side$,orderType:this.orderType$}).pipe((0,G.take)(1)).subscribe((t=>{const{quotes:i,stopPriceControlData:s,side:r,orderType:o}=t;let n=0;const a=this._getBase(r,o);switch(a){case"stop":null!==s&&(n=Math.round(s.index+e));break;case"ask":const t=this._priceToIndex((0,q.getAsk)(i));n=Math.round(t+e);break;case"bid":const r=this._priceToIndex((0,q.getBid)(i));n=Math.round(r+e)}const l=this.indexToPrice(n);this._setPrice({index:n,value:l,absolutePrice:this.formatter.format(l),offset:e,base:a})}))},this.forcePriceUpdate=e=>{null!==e&&(this.setControlError(!1),this.setFocusedControl(0),this.setPriceValue(e,!0))},this.getPriceControlData=()=>this._priceControlData$.getValue(),this.getPrice=()=>{var e,t;return null!==(t=null===(e=this.getPriceControlData())||void 0===e?void 0:e.value)&&void 0!==t?t:null},this.getValue=()=>this._value$.getValue(),this.getFocusedControl=()=>this._focusedControl$.getValue(),this.getStep=e=>void 0===e?this._minTick:(0,q.getPriceStep)({price:e,priceType:this.priceType,minTick:this._minTick,variableMinTickData:this._variableMinTickData,limitPriceStep:this._instrumentInfo.limitPriceStep,stopPriceStep:this._instrumentInfo.stopPriceStep}),this.setFocusedControl=e=>{this._focusedControl$.next(e)},this._isPriceRules=e=>"limitPriceDistance"===e.id||"stopPriceDistance"===e.id,this._updateFocusIfNeeded=e=>{
1!==this.getFocusedControl()||!this.isRelativePriceControlHidden&&e.showRelativePriceControl||this.setFocusedControl(0)},this._setPrice=e=>{this._priceControlData$.next(e)},this._setError=e=>{const{priceControlData:t,quotes:s,side:r,orderType:o,controlError:n,status:a}=e;if(a===E.OrderPanelStatus.Wait)return void this._error$.next({res:!1});if(n.res)return void this._error$.next(n);let l={res:!1},u={res:!1};if(null===t)l={res:!0,severity:"error",msg:b.t(null,void 0,i(845542))};else{{const e=this.getStep(t.value);if(u=this._checkPriceWarning(t.value,s,r),null!==o&&2!==o){const i=(0,q.getQuotePrice)(s,r);l=(0,Pe.validatePrice)({price:t.value,askOrBid:i,orderType:o,side:r,priceType:this.priceType,isForex:"forex"===this._symbolType,formatter:this.formatter,stopLimitPercentPriceRuleCheckers:this._stopLimitPercentPriceRuleCheckers,supportStopOrdersInBothDirections:this.supportStopOrdersInBothDirections,supportStopLimitOrdersInBothDirections:this.supportStopLimitOrdersInBothDirections,supportStrictCheckingLimitOrderPrice:this.supportStrictCheckingLimitOrderPrice,step:e,isStatusEditing:a===E.OrderPanelStatus.Editing,roundedToStep:this._roundToStepRequired()})}}}l.res?this._error$.next(l):u.res?this._error$.next(u):this._error$.next({res:!1})},this.quotes$=t,this.side$=s,this._instrumentInfo=r,this._status$=o,this.formatter=new fe(a),this.orderType$=l,this.priceType=e,this._settings$=u,this._getSettings=c,this._brokerTitle=d,this.orderWidgetStat=h,this.supportStopOrdersInBothDirections=Boolean(k),this.supportStopLimitOrdersInBothDirections=Boolean(m),this.supportStrictCheckingLimitOrderPrice=Boolean(f),this._symbolType=r.type||"",this._pipSize=r.pipSize,this._minTick=r.minTick||r.pipSize,this._variableMinTickData=r.variableMinTick?(0,N.makeVariableMinTickData)(this._minTick,r.variableMinTick):void 0;const $=this.getStep();this.indexToPrice=(0,N.makePriceIndexToPriceConverter)($,this._variableMinTickData),this._priceToIndex=(0,N.makePriceToPriceIndexConverter)($,this._variableMinTickData),this.priceControlData$=this._priceControlData$.asObservable(),this.value$=this._value$.asObservable(),this.focusedControl$=this._focusedControl$.asObservable(),this.error$=this._error$.pipe((0,ve.distinctUntilChanged)(me)),this._stopPriceControlData$=(0,M.combineLatest)({stopPriceControlData:null!=v?v:(0,w.of)(null),orderType:this.orderType$}).pipe((0,P.map)((t=>{const{stopPriceControlData:i,orderType:s}=t;return 1===e&&4===s?i:null})),(0,ve.distinctUntilChanged)()),this.isRelativePriceControlHidden=this._roundToStepRequired(),g||this.isRelativePriceControlHidden||!c().showRelativePriceControl||this.setFocusedControl(1),this.modifiedAbsolutePriceControlStat=null!==h?()=>h.setPriceControlModifiedProperty(E.PriceSubControlType.Absolute):()=>{},this.modifiedRelativePriceControlStat=null!==h?()=>h.setPriceControlModifiedProperty(E.PriceSubControlType.Relative):()=>{},void 0!==p&&this.setPriceValue(p,!0);const T=null!=_?_:[];this._priceRules=null!==(S=T.filter(this._isPriceRules))&&void 0!==S?S:[]
;const V=null!==(C=T.filter(R.isStopLimitPercentValidationRule))&&void 0!==C?C:[],I=1===this.priceType?R.isLimitPercentValidationRule:R.isStopPercentValidationRule;V.filter(I).forEach((e=>{this._stopLimitPercentPriceRuleCheckers.push((0,Pe.makeStopLimitPercentPriceRuleChecker)(e.options.min,e.options.max))}))}subscribe(){const e=this._settings$.subscribe(this._updateFocusIfNeeded),t=(0,M.combineLatest)({quotes:this.quotes$,side:this.side$,focusedControl:this.focusedControl$,status:this._status$}).pipe(B(this._priceControlData$)).subscribe((([e,t])=>{const{quotes:i,side:s,focusedControl:r,status:o}=e;null!==t&&o!==E.OrderPanelStatus.Wait?0===r?this.setAbsolutePrice(t.absolutePrice):this.setPriceOffset(t.offset):this.setPriceValue(1===s?(0,q.getAsk)(i):(0,q.getBid)(i),!1)})),i=(0,M.combineLatest)({priceControlData:this._priceControlData$,quotes:this.quotes$,side:this.side$,orderType:this.orderType$,controlError:this._controlError$.pipe((0,ve.distinctUntilChanged)(me)),status:this._status$}).subscribe(this._setError),s=(0,M.combineLatest)({priceControlData:this._priceControlData$,error:this.error$}).subscribe((e=>{const{priceControlData:t,error:i}=e;let s=null===t?null:t.value;s=i.res&&"error"===i.severity?null:s,this._value$.next(s)}));this._subscriptions=[e,t,i,s]}unsubscribe(){this._subscriptions.map((e=>e.unsubscribe()))}resetPrice(){this.setControlError(!1),this.setFocusedControl(this._getSettings().showRelativePriceControl&&!this.isRelativePriceControlHidden?1:0),(0,M.combineLatest)([this.quotes$,this.side$]).pipe((0,G.take)(1)).subscribe((([e,t])=>{this.setPriceValue(1===t?(0,q.getAsk)(e):(0,q.getBid)(e),!1)}))}_checkPriceWarning(e,t,i){const s=this._priceRules.find((s=>this._isDistanceRuleViolated(e,t,s,i)));return s?{res:!0,severity:s.severity,msg:ke.format({brokerTitle:this._brokerTitle})}:{res:!1,msg:void 0}}_isDistanceRuleViolated(e,t,i,s){if("limitPriceDistance"===i.id&&2===this.priceType||"stopPriceDistance"===i.id&&1===this.priceType)return!1;const r=1===s,o=(0,q.getQuotePrice)(t,s);let n=null;if(r&&"buyDirectionPips"in i.options&&(n=i.options.buyDirectionPips),!r&&"sellDirectionPips"in i.options&&(n=i.options.sellDirectionPips),null===n)return!1;return Math.abs(o-e)<n*this._pipSize}_getBase(e,t){return 1===this.priceType&&4===t?"stop":1===e?"ask":"bid"}_roundToStepRequired(){return(0,q.roundToStepRequired)({priceType:this.priceType,minTick:this._minTick,limitPriceStep:this._instrumentInfo.limitPriceStep,stopPriceStep:this._instrumentInfo.stopPriceStep})}}var Ce=i(960521),$e=i.n(Ce);function Te(e,t){return(0,q.getLast)(e)||(0,q.getQuotePrice)(e,t)||0}class Me{constructor({stopPriceModel:e,limitPriceModel:t,orderType$:i,side$:s,quotes$:r}){this._subscriptions=[],this._calculateLimitModelPrice=e=>{const t=this._stopPriceModel.getPrice();if(null===t)return null;const i=this._limitPriceModel.getStep(t),s=1===e?1:-1;return new($e())(i).mul(s).plus(t).toNumber()},this._orderType$=i,this._side$=s,this._stopPriceModel=e,this._limitPriceModel=t,this.price$=(0,M.combineLatest)({orderType:i,side:s,quotes:r,
stopPrice:e.value$,limitPrice:t.value$}).pipe((0,P.map)((e=>{const{orderType:t,side:i,quotes:s,stopPrice:r,limitPrice:o}=e;switch(t){case 1:case 4:return o||Te(s,i);case 3:return r||Te(s,i);default:return(0,q.getQuotePrice)(s,i)}})),(0,ve.distinctUntilChanged)())}subscribe(){const e=this._orderType$.pipe((0,a.operate)((function(e,t){var i,s=!1;e.subscribe(new l.OperatorSubscriber(t,(function(e){var r=i;i=e,s&&t.next([r,e]),s=!0})))})),B(this._side$),(0,P.map)((([e,t])=>{const[i,s]=e,r=this._stopPriceModel.getPrice(),o=this._limitPriceModel.getPrice();if(1===s&&null!==i&&[3,4].includes(i))this._limitPriceModel.forcePriceUpdate(r);else if(3!==s||1!==i){if(4===s){1===i&&this._stopPriceModel.forcePriceUpdate(o);const e=this._calculateLimitModelPrice(t);this._limitPriceModel.forcePriceUpdate(e)}}else this._stopPriceModel.forcePriceUpdate(o)}))).subscribe();this._subscriptions.push(e)}unsubscribe(){this._subscriptions.map((e=>e.unsubscribe()))}}var we=i(316230),Ve=i(341086),Ie=i(50771),Oe=i(848062),Be=i(863582),De=i(499665);function Le(e,t,i,s,r){if(!t)return 0;return Fe((0,Ce.Big)(e).div(t).div(i).div(r||1),s).toNumber()}function Ee(e,t,i,s,r,o){if(!i)return 0;return Fe((0,Ce.Big)(e).mul(t).div(i).div(s).div(o||1).div(100),r).toNumber()}function qe(e,t,i,s){return(0,Ce.Big)(t).mul(i).mul(e).mul(s||1).toNumber()}function Re(e,t,i,s,r){return s&&e?(0,Ce.Big)(t).mul(i).mul(e).mul(r||1).mul(100).div(s).toNumber():0}function Fe(e,t){return e.div(t).round(0,0).mul(t)}class xe{constructor({stopLossAvailable$:e,stopLossPips$:t,equity$:i,pipValue$:s,settings$:o,initialQty:a,initialOrderSizeCalculatorQuantityType:l,initialOrderSizeCalculatorValue:u,initialLastRiskQuantityType:d,stopLossAvailableGetter:h,initialLastUsedQuantityType:c,info:p,currency:_,orderWidgetStat:y,showRiskControlsAndInfo:b}){var g;this.formatter=(0,Ve.numberFormattersParsersChain)({chain:[(0,Ie.prohibitNanOnParseStep)(),(0,Oe.decimalNumberMagnitudeStep)({standardNotationOnly:!0}),(0,Be.signumStep)({negativeSign:Be.longMinusSign})]}),this.riskInCurrencyFormatter=new A.PriceFormatter({priceScale:100}),this.riskInPercentFormatter=new A.PriceFormatter({priceScale:100}),this.convertedValues$=new S.ReplaySubject(1),this.riskStep=.01,this.onControlFocused=new Q.Delegate,this._subscriptions=[],this._value$=new n.BehaviorSubject(null),this._inputType$=new n.BehaviorSubject("units"),this._focusedControl$=new n.BehaviorSubject(0),this._error$=new n.BehaviorSubject({res:!1}),this._controlError$=new n.BehaviorSubject({res:!1}),this._isOrderSizeCalculatorEnabled=!1,this.setControlError=(e,t)=>{this._controlError$.next({res:e,msg:t})},this.setInputTypeAndValue=(e,t)=>{this._setInputType(e),"units"===e?this.quantity.setValue(t):this.orderSizeCalculator.setValue(t),this.setControlError(!1)},this.getInputType=()=>this._inputType$.getValue(),this.getOrderSizeCalculatorQuantityType=()=>this._orderSizeCalculatorQuantityType$.getValue(),this.setOrderSizeCalculatorQuantityType=e=>{this._orderSizeCalculatorQuantityType$.next(e)},
this.getLastRiskQuantityType=()=>this._lastRiskQuantityType$.getValue(),this.getLastUsedQuantityType=()=>this._lastUsedQuantityType$.getValue(),this.getFocusedControl=()=>this._focusedControl$.getValue(),this.getError=()=>this._error$.getValue(),this.getQuantityMetainfo=()=>this._quantityMetainfo$.getValue(),this.setFocusedControl=e=>{this._focusedControl$.next(e)},this.stopLossAvailable=()=>this._stopLossAvailableGetter(),this.setConvertedValues=e=>{this.convertedValues$.next(e)},this._setInputType=e=>{"riskInCurrency"!==e&&"riskInPercent"!==e||this._lastRiskQuantityType$.next(e),"units"!==e&&this.setOrderSizeCalculatorQuantityType(e),this._lastUsedQuantityType$.next(e),this._inputType$.next(e)},this._updateFocusIfNeeded=e=>{const t=this._focusedControl$.getValue(),i=1===t&&!e.showCurrencyRiskInQty,s=2===t&&!e.showPercentRiskInQty;(i||s)&&this.setFocusedControl(0)},this._setQuantity=e=>{this._quantity$.next((0,q.applyRounding)(e,this.formatter))},this._setOrderSizeCalculator=e=>{this._orderSizeCalculator$.next((0,q.applyRounding)(e,this.formatter))},this._setRiskInCurrency=e=>{var t;null===(t=this._riskInCurrency$)||void 0===t||t.next((0,q.applyRounding)(e,this.riskInCurrencyFormatter))},this._setRiskInPercent=e=>{var t;null===(t=this._riskInPercent$)||void 0===t||t.next((0,q.applyRounding)(e,this.riskInPercentFormatter))},this.qty=p.qty,this.units=p.units,this._lotSize=p.lotSize,this.showRiskControlsAndInfo=b,this.currency=_,this.stopLossAvailable$=e,this._equity$=i,this._pipValue$=s,this._stopLossPips$=t,this._settings$=o,this._stopLossAvailableGetter=h,this._quantity$=new n.BehaviorSubject(null!==(g=null!=a?a:this.qty.default)&&void 0!==g?g:null),this._orderSizeCalculator$=new n.BehaviorSubject(u),this._orderSizeCalculatorQuantityType$=new n.BehaviorSubject(l),this._lastRiskQuantityType$=new n.BehaviorSubject(d),this._lastUsedQuantityType$=new n.BehaviorSubject(null!=c?c:"units"),this._quantityMetainfo$=new n.BehaviorSubject(p.qty),this.value$=this._value$.asObservable(),this.inputType$=this._inputType$.asObservable(),this.orderSizeCalculatorQuantityType$=this._orderSizeCalculatorQuantityType$.asObservable(),this.lastRiskQuantityType$=this._lastRiskQuantityType$.asObservable(),this.lastUsedQuantityType$=this._lastUsedQuantityType$.asObservable(),this.focusedControl$=this._focusedControl$.asObservable(),this.error$=this._error$.asObservable(),this.quantityMetainfo$=this._quantityMetainfo$.asObservable();const v=()=>{if(null!==y&&!this._isOrderSizeCalculatorEnabled)return y.setQtyControlModifiedProperty(E.QuantitySubControlType.Units)};this.quantity={value$:this._quantity$.asObservable(),getValue:()=>this._quantity$.getValue(),setValue:this._setQuantity,onModifiedCallback:v,calculatorUsedStat:()=>null!==y?y.setCalculatorUsedProperty():()=>{}},this.orderSizeCalculator={value$:this._orderSizeCalculator$.asObservable(),getValue:()=>this._orderSizeCalculator$.getValue(),setValue:this._setOrderSizeCalculator,onModifiedCallback:v,calculatorUsedStat:()=>null!==y?y.setCalculatorUsedProperty():()=>{}},
h()||!u||c!==l||"money"!==c&&"equityPercent"!==c||this.setInputTypeAndValue(c,u),this._isOrderSizeCalculatorEnabled||(this._riskInCurrency$=new n.BehaviorSubject(null),this._riskInPercent$=new n.BehaviorSubject(null),this.riskInCurrency={value$:this._riskInCurrency$.asObservable(),getValue:()=>(0,r.ensureDefined)(this._riskInCurrency$).getValue(),setValue:this._setRiskInCurrency,onModifiedCallback:()=>null!==y?y.setQtyControlModifiedProperty(E.QuantitySubControlType.RiskInCurrency):()=>{},calculatorUsedStat:()=>null!==y?y.setCalculatorUsedProperty():()=>{}},this.riskInPercent={value$:this._riskInPercent$.asObservable(),getValue:()=>(0,r.ensureDefined)(this._riskInPercent$).getValue(),setValue:this._setRiskInPercent,onModifiedCallback:()=>null!==y?y.setQtyControlModifiedProperty(E.QuantitySubControlType.RiskInPercent):()=>{},calculatorUsedStat:()=>null!==y?y.setCalculatorUsedProperty():()=>{}},this._quantityValuesWithFocusedControl$=this._quantityValuesWithFocusedControlObservable())}subscribe(){const e=[];if(this._isOrderSizeCalculatorEnabled){const t=this._inputType$.subscribe((e=>{var t,i,s;this.setFocusedControl("units"===e?0:5),this._quantityMetainfo$.next(null!==(s=null===(i=null===(t=this._availableQuantityTypeInfos)||void 0===t?void 0:t[e])||void 0===i?void 0:i.quantityMetainfo)&&void 0!==s?s:this.qty)})),i=this._focusedControl$.pipe((0,U.switchMap)((e=>(0,M.combineLatest)([this.convertedValues$,this._orderSizeCalculatorQuantityType$]).pipe((0,P.map)((([t,i])=>({focusedControl:e,orderSizeCalculatorQuantityType:i,convertedValues:t}))))))).subscribe((e=>{const{focusedControl:t,orderSizeCalculatorQuantityType:i,convertedValues:s}=e;if(0===t&&null!==i){const e=s[i];void 0!==e&&e!==this._orderSizeCalculator$.value&&this._setOrderSizeCalculator(e)}5===t&&this._quantity$.value!==s.units&&this._setQuantity(s.units)})),s=this.stopLossAvailable$.pipe((0,ve.distinctUntilChanged)(),skip(1),withLatestFrom(this.convertedValues$,this._inputType$)).subscribe((([,e,t])=>{"units"!==t&&this.setInputTypeAndValue("units",e.units)})),r=this.stopLossAvailable$.pipe((0,ve.distinctUntilChanged)(),withLatestFrom(this._settings$,this._lastRiskQuantityType$,this._orderSizeCalculatorQuantityType$)).subscribe((([e,t,i,s])=>{var r;t.enableQuantityInRisk&&e&&null!==i&&void 0!==(null===(r=this.getAvailableQuantityTypeInfos())||void 0===r?void 0:r[i])&&"riskInCurrency"!==s&&"riskInPercent"!==s&&this.setOrderSizeCalculatorQuantityType(i)}));e.push(t,s,r,i)}else{const t=this._settings$.subscribe(this._updateFocusIfNeeded),i=this.stopLossAvailable$.subscribe((e=>{e||this.setFocusedControl(0)})),s=(0,M.combineLatest)({quantityValuesWithFocusedControl:(0,r.ensureDefined)(this._quantityValuesWithFocusedControl$),pipValue:this._pipValue$,stopLossPips:this._stopLossPips$,equity:this._equity$}).subscribe((({quantityValuesWithFocusedControl:e,pipValue:t,stopLossPips:i,equity:s})=>{const{focusedControl:r,quantity:o,riskInCurrency:n,riskInPercent:a}=e,{quantity:l,riskInCurrency:u,riskInPercent:d}=this._calculateQuantityValues({focusedControl:r,pipValue:t,
quantity:o,riskInCurrency:n,riskInPercent:a,stopLossPips:i,equity:s});o===l&&n===u&&a===d||this._setUnfocusedControlsValues(r,l,u,d)}));e.push(t,i,s)}const t=(0,M.combineLatest)({units:this._quantity$,controlError:this._controlError$,focus:this._focusedControl$,orderSizeCalculator:this._orderSizeCalculator$,orderSizeCalculatorQuantityType:this._orderSizeCalculatorQuantityType$}).pipe((0,ve.distinctUntilChanged)(we.default)).subscribe((e=>{var t,i;const{units:s,controlError:r,focus:o,orderSizeCalculator:n,orderSizeCalculatorQuantityType:a}=e;const l=null!==a?null===(i=null===(t=this._availableQuantityTypeInfos)||void 0===t?void 0:t[a])||void 0===i?void 0:i.quantityMetainfo:void 0,u=5===o&&void 0!==l?(0,De.checkQtyError)(l,n,!0):void 0,d=(0,De.checkQtyError)(this.qty,s,!0),h=r.res?r.msg:(null==u?void 0:u.msg)||d.msg;this._error$.next({res:r.res||(null==u?void 0:u.res)||d.res,msg:h}),this._value$.next(r.res||(null==u?void 0:u.res)||d.res||null===o?null:s)}));e.push(t),this._subscriptions=e}unsubscribe(){this._subscriptions.map((e=>e.unsubscribe()))}getValue(){return this._value$.getValue()}setAvailableQuantityTypeInfos(e){this._availableQuantityTypeInfos=e}getAvailableQuantityTypeInfos(){return this._availableQuantityTypeInfos}_calculateQuantityValues(e){return{quantity:(0,q.applyRounding)(this._calculateQuantity(e),this.formatter),riskInCurrency:(0,q.applyRounding)(this._calculateRiskInCurrency(e),this.riskInCurrencyFormatter),riskInPercent:(0,q.applyRounding)(this._calculateRiskInPercent(e),this.riskInPercentFormatter)}}_setUnfocusedControlsValues(e,t,i,s){0!==e&&this._setQuantity(t),1!==e&&this._setRiskInCurrency(i),2!==e&&this._setRiskInPercent(s)}_quantityValuesWithFocusedControlObservable(){return this._focusedControl$.pipe((0,U.switchMap)((e=>1===e?this._riskInCurrencyObservable(e):2===e?this._riskInPercentObservable(e):this._quantityObservable(e))))}_quantityObservable(e){return this._quantity$.pipe((0,U.switchMap)((t=>J([(0,r.ensureDefined)(this._riskInCurrency$),(0,r.ensureDefined)(this._riskInPercent$)]).pipe((0,P.map)((i=>{const[s,r]=i;return{focusedControl:e,quantity:t,riskInCurrency:s,riskInPercent:r}}))))))}_riskInCurrencyObservable(e){return(0,r.ensureDefined)(this._riskInCurrency$).pipe((0,U.switchMap)((t=>J([this._quantity$,(0,r.ensureDefined)(this._riskInPercent$)]).pipe((0,P.map)((i=>{const[s,r]=i;return{focusedControl:e,quantity:s,riskInCurrency:t,riskInPercent:r}}))))))}_riskInPercentObservable(e){return(0,r.ensureDefined)(this._riskInPercent$).pipe((0,U.switchMap)((t=>J([this._quantity$,(0,r.ensureDefined)(this._riskInCurrency$)]).pipe((0,P.map)((i=>{const[s,r]=i;return{focusedControl:e,quantity:s,riskInCurrency:r,riskInPercent:t}}))))))}_calculateQuantity(e){const{focusedControl:t,pipValue:i,quantity:s,riskInCurrency:r,riskInPercent:o,stopLossPips:n,equity:a}=e;switch(t){case 0:default:return s;case 1:return null===r||null===n?null:Le(r,n,i,this.qty.step,this._lotSize);case 2:return null===o||null===n?null:Ee(o,a,n,i,this.qty.step,this._lotSize)}}_calculateRiskInCurrency(e){
const{focusedControl:t,pipValue:i,quantity:s,riskInCurrency:r,riskInPercent:o,stopLossPips:n,equity:a}=e;switch(t){case 0:return null===s||null===n?null:qe(s,n,i,this._lotSize);case 1:return r;case 2:if(null===o||null===n)return null;return qe(Ee(o,a,n,i,this.qty.step,this._lotSize),n,i,this._lotSize);default:return null===s||null===n?null:qe(s,n,i)}}_calculateRiskInPercent(e){const{focusedControl:t,pipValue:i,quantity:s,riskInCurrency:r,riskInPercent:o,stopLossPips:n,equity:a}=e,l=null===n;switch(t){case 0:default:return null===s||l?null:Re(s,n,i,a,this._lotSize);case 1:if(null===r||l)return null;return Re(Le(r,n,i,this.qty.step,this._lotSize),n,i,a,this._lotSize);case 2:return o}}}var Qe=i(797358),Ae=i(989546),ze=i(501329);class Ne{constructor({info:e,price$:t,baseCurrencyCryptoBalance$:i,quoteCurrencyCryptoBalance$:s,initialQty:r,side$:o,sideGetter:a,orderWidgetStat:l,isExistingOrder:u,orderQty:d,orderPrice:h}){this.formatter=Ae.defaultQuantityFormatter,this.onControlFocused=new Q.Delegate,this._value$=new n.BehaviorSubject(null),this._quoteCurrencyQuantity$=new n.BehaviorSubject(null),this._error$=new n.BehaviorSubject({res:!1}),this._focusedControl$=new n.BehaviorSubject(3),this._controlError$=new n.BehaviorSubject({res:!1}),this._baseCurrencyCryptoBalanceValue$=new n.BehaviorSubject(null),this._quoteCurrencyCryptoBalanceValue$=new n.BehaviorSubject(null),this._subscriptions=[],this.setControlError=e=>{this._controlError$.next({res:e})},this.getFocusedControl=()=>this._focusedControl$.getValue(),this.setFocusedControl=e=>{this._focusedControl$.next(e)},this._setBaseCurrencyQuantity=e=>{this._baseCurrencyQuantity$.next((0,q.applyRounding)(e,this.formatter))},this._setQuoteCurrencyQuantity=e=>{this._quoteCurrencyQuantity$.next((0,q.applyRounding)(e,this.formatter))},this.info=e,this.side$=o,this.getSide=a,this._price$=t,this._orderQty=d,this._orderPrice=h,this._isExistingOrder=u,this._baseCurrencyCryptoBalance$=i,this._quoteCurrencyCryptoBalance$=s,this._baseCurrencyQuantity$=new n.BehaviorSubject(null!==r?r:e.qty.default||e.qty.step),this.value$=this._value$.asObservable(),this.focusedControl$=this._focusedControl$.asObservable(),this.error$=this._error$.asObservable(),this.baseCurrencyCryptoBalanceValue$=this._baseCurrencyCryptoBalanceValue$.asObservable(),this.quoteCurrencyCryptoBalanceValue$=this._quoteCurrencyCryptoBalanceValue$.asObservable(),this.quoteCurrencyUiParams$=t.pipe((0,P.map)((t=>{const i=(0,Ce.Big)(t).mul(e.qty.step).toNumber(),s=(0,y.roundUpToPowerOf10)(i),r=(0,Ce.Big)(t).mul(e.qty.min).toNumber();return{min:(0,ze.alignToStep)(r,s),step:s}}))),this.quantity={value$:this._baseCurrencyQuantity$.asObservable(),getValue:()=>this._baseCurrencyQuantity$.getValue(),setValue:this._setBaseCurrencyQuantity,onModifiedCallback:null!==l?()=>l.setQtyControlModifiedProperty(E.QuantitySubControlType.BaseCurrency):()=>{}},this.quoteCurrencyQuantity={value$:this._quoteCurrencyQuantity$.asObservable(),getValue:()=>this._quoteCurrencyQuantity$.getValue(),setValue:this._setQuoteCurrencyQuantity,
onModifiedCallback:null!==l?()=>l.setQtyControlModifiedProperty(E.QuantitySubControlType.QuoteCurrency):()=>{}},this._quantityValuesWithFocusedControl$=this._quantityValuesWithFocusedControlObservable()}subscribe(){null!==this._baseCurrencyCryptoBalance$&&this._subscriptions.push((0,M.combineLatest)([this.side$,this._baseCurrencyCryptoBalance$]).subscribe((e=>{const[t,i]=e;this._baseCurrencyCryptoBalanceValue$.next((0,q.getCryptoBalanceValue)({side:t,balance:i,isExistingOrder:this._isExistingOrder,qty:this._orderQty,orderPrice:this._orderPrice}))}))),null!==this._quoteCurrencyCryptoBalance$&&this._subscriptions.push((0,M.combineLatest)([this.side$,this._quoteCurrencyCryptoBalance$]).subscribe((e=>{const[t,i]=e;this._quoteCurrencyCryptoBalanceValue$.next((0,q.getCryptoBalanceValue)({side:t,balance:i,isExistingOrder:this._isExistingOrder,qty:this._orderQty,orderPrice:this._orderPrice}))})));const e=(0,M.combineLatest)({price:this._price$,quantityValuesWithFocusedControl:this._quantityValuesWithFocusedControl$}).subscribe((e=>{const{price:t,quantityValuesWithFocusedControl:i}=e,{focusedControl:s,baseCurrencyQuantity:r,quoteCurrencyQuantity:o}=i,{baseCurrencyQuantity:n,quoteCurrencyQuantity:a}=this._calculateQuantityValues({focusedControl:s,price:t,baseCurrencyQuantity:r,quoteCurrencyQuantity:o});r===n&&o===a||this._setUnfocusedControlsValues(s,n,a)})),t=(0,M.combineLatest)({baseValue:this._baseCurrencyQuantity$,quoteValue:this._quoteCurrencyQuantity$,controlError:this._controlError$,focus:this._focusedControl$,side:this.side$,baseBalanceValue:this._baseCurrencyCryptoBalanceValue$,quoteBalanceValue:this._quoteCurrencyCryptoBalanceValue$}).subscribe((e=>{const{baseValue:t,quoteValue:i,controlError:s,focus:r,side:o,baseBalanceValue:n,quoteBalanceValue:a}=e,l=(0,De.checkQtyError)(this.info.qty,t),u=(0,Qe.validateBalance)({side:o,baseValue:t,baseBalanceValue:n,baseCurrency:this.info.baseCurrency,quoteValue:i,quoteBalanceValue:a,quoteCurrency:this.info.quoteCurrency});this._error$.next({res:l.res||u.res||s.res,msg:l.msg||u.msg||s.msg}),this._value$.next(l.res||u.res||s.res||null===r?null:t)}));this._subscriptions.push(e,t)}getError(){return this._error$.getValue()}unsubscribe(){this._subscriptions.forEach((e=>e&&e.unsubscribe()))}getValue(){return this._value$.getValue()}_quantityValuesWithFocusedControlObservable(){return this._focusedControl$.pipe((0,U.switchMap)((e=>{const t=3===e,i=t?this._baseCurrencyQuantity$:this._quoteCurrencyQuantity$,s=t?this._quoteCurrencyQuantity$:this._baseCurrencyQuantity$;return i.pipe((0,U.switchMap)((i=>s.pipe((0,P.map)((s=>({focusedControl:e,baseCurrencyQuantity:t?i:s,quoteCurrencyQuantity:t?s:i})))))))})))}_setUnfocusedControlsValues(e,t,i){3!==e&&this._setBaseCurrencyQuantity(t),4!==e&&this._setQuoteCurrencyQuantity(i)}_calculateQuantityValues(e){const{focusedControl:t,price:i,baseCurrencyQuantity:s,quoteCurrencyQuantity:r}=e;let o=s,n=r;switch(t){case 3:null!==s&&(n=(0,Ce.Big)(s).mul(i).toNumber());break;case 4:null!==r&&(o=(0,
Ce.Big)(r).div(i).div(this.info.qty.step).round(0,0).mul(this.info.qty.step).toNumber())}return{baseCurrencyQuantity:(0,q.applyRounding)(o,this.formatter),quoteCurrencyQuantity:(0,q.applyRounding)(n,this.formatter)}}}var We=i(759333);class je{constructor({initialDuration:e,orderType$:t,orderWidgetStat:i,orderDurations:s,symbolDurations:r,getOrderType:a}){this.onControlFocused=new Q.Delegate,this._hasError$=new n.BehaviorSubject(!1),this._stop$=new o.Subject,this.setError=e=>{this._hasError$.next(e)},this.hasError$=this._hasError$.asObservable(),this.getOrderType=a,this.durationMetaInfoList=void 0!==s?(0,q.filterDurationsBySymbolDurations)(s,r):[],this.orderType$=t;const l=this._getDurationByOrderType(e,a());this.$value=new n.BehaviorSubject(l),this.currentDuration=new We.WatchedObject(l,j.comparator),this._currentDurationSubscription=(0,j.makeSubjectFromWatchedValue)(this.currentDuration),this._currentDurationSubscription.subject.pipe(h(this._stop$)).subscribe((e=>{this.$value.next(e)})),this._orderTypeSubscription=this.orderType$.pipe(h(this._stop$)).subscribe((e=>{const t=this._getDurationByOrderType(this.getValue(),e);this.currentDuration.setValue(t)})),this.onModifiedCallback=null!==i?()=>i.setDurationControlModifiedProperty():()=>{}}isDurationsAvailable(){return null!==this._getDurationByOrderType(this.currentDuration.value(),this.getOrderType())}unsubscribe(){this._stop$.next(),this._stop$.complete(),this._currentDurationSubscription.unsubscribe(),this._orderTypeSubscription.unsubscribe()}getValue(){const e=this.$value.getValue();if(null===e)return null;const t=this.durationMetaInfoList.find((t=>e.type===t.value));if(void 0===t)return null;const i={type:e.type};return(t.hasDatePicker||t.hasTimePicker)&&(i.datetime=e.datetime),i}_getDurationByOrderType(e,t){const i=(0,q.filterDurationsByOrderType)(this.durationMetaInfoList,t);if(0===i.length)return null;return null!==e&&i.some((t=>e.type===t.value))?e:(0,q.makeInitialOrderDuration)(t,i)}}function Ue(e,t=100,i){const s=new Map,r=new Map;return function(...o){var n;const a=String(i?i.apply(null,o):o),l=Date.now();if(s.has(a)&&(null!==(n=r.get(a))&&void 0!==n?n:-1/0)>l)return s.get(a);const u=e.apply(this,o);return s.set(a,u),r.set(a,l+t),u}}var Ge=i(61121);const He=(0,p.getLogger)("Trading.LeverageViewModel");class Ke{constructor({adapterLeverageInfo:e,adapterSetLeverage:t,adapterPreviewLeverage:s,brokerName:o,symbol:a,displaySymbol:l,orderType$:u,getOrderType:d,side$:h,initialSide:c,customFieldsInputValues$:p,blocked$:_,isBlockedGetter:g,onBlockedClick:v}){this.onControlFocused=new Q.Delegate,this._leverageInfo$=new n.BehaviorSubject(null),this._leveragePreviewResult$=new n.BehaviorSubject(null),this._subscription=void 0,this._abortController=new AbortController,this.leverageInfo=()=>this._leverageInfo$.getValue(),this.leveragePreviewResult=()=>this._leveragePreviewResult$.getValue(),this.setLeverage=async e=>{try{const t=await this._adapterSetLeverage(e),i=this.leverageInfo();null!==i&&this._leverageInfo$.next({...i,leverage:t.leverage})}catch(e){
throw He.logError(`Failed to set leverage: ${(0,y.getLoggerMessage)(e)}`),new Error(b.t(null,void 0,i(252888)))}},this.previewLeverage=async e=>{try{const t=await this._adapterPreviewLeverage(e);return this._leveragePreviewResult$.next(t),t}catch(e){throw this._leveragePreviewResult$.next(null),He.logError(`Failed to preview leverage: ${(0,y.getLoggerMessage)(e)}`),new Error(b.t(null,void 0,i(48048)))}},this._updateLeverageInfo=async e=>{const t=await this.getLeverageInfo({symbol:this.symbol,orderType:this.orderType,side:this.side,customFields:this.customFields});(null==e?void 0:e.aborted)||this._leverageInfo$.next(t)},this._customFieldsInputValues$=p,this._adapterLeverageInfo=e,this._updateLeverageInfo=(0,Ge.respectLatest)(this._updateLeverageInfo),this._adapterSetLeverage=t,this._adapterPreviewLeverage=s,this.symbol=a,this.displaySymbol=l,this._orderType$=u,this._side$=h,this.brokerName=o,this.leverageInfo$=this._leverageInfo$.asObservable(),this.orderType=(0,r.ensureNotNull)(d()),this.side=c,this.blocked$=_,this.getBlocked=g,this.onBlockedClick=v,this.getLeverageInfo=Ue(this.getLeverageInfo)}async getLeverageInfo(e){try{return await this._adapterLeverageInfo(e)}catch(e){return He.logError(`Failed to get leverage info: ${(0,y.getLoggerMessage)(e)}`),null}}subscribe(){this._subscription=(0,M.combineLatest)({orderType:this._orderType$,side:this._side$,customFieldsDependencies:J(this._customFieldsInputValues$,this.blocked$).pipe((0,P.map)((([e,t])=>({customFields:e,blocked:t}))))}).subscribe((({orderType:e,side:t,customFieldsDependencies:i})=>{if(this.orderType=(0,r.ensureNotNull)(e),this.side=t,this.customFields=i.customFields,i.blocked)return this._abortController.abort(),this._abortController=new AbortController,void this._leverageInfo$.next(null);this._updateLeverageInfo(this._abortController.signal)}))}unsubscribe(){var e;null===(e=this._subscription)||void 0===e||e.unsubscribe()}}i(68212);const Ye="",Je=(e,t)=>b.t(null,void 0,i(733740)).format({qty:e,symbol:t,whitespaceNoBreak:Ye}),Xe=(e,t,s)=>b.t(null,void 0,i(925609)).format({qty:e,symbol:t,stopPrice:s,whitespaceNoBreak:Ye}),Ze=(e,t,s)=>b.t(null,void 0,i(416342)).format({qty:e,symbol:t,limitPrice:s,whitespaceNoBreak:Ye}),et=(e,t,s,r)=>b.t(null,void 0,i(991313)).format({qty:e,symbol:t,stopPrice:s,limitPrice:r,whitespaceNoBreak:Ye}),[tt,it]=b.t(null,void 0,i(419676)).split(/{line_break}/);class st{constructor(e,t){this.getValue=()=>this._value.getValue(),this.subscribe=()=>{const e=(0,r.ensureDefined)(this._props);if(e.existingOrder||this._tradingEntityType===L.TradingEntityType.Position)return;const t={status:e.status,orderType:e.orderType,orderPlacingStatus:e.orderPlacingStatus,side:e.side,quantity:e.quantity,stopPrice:e.stopPrice,limitPrice:e.limitPrice};this._orderSubscription=(0,M.combineLatest)(t).subscribe(this._orderSubscriptionValues)},this.unsubscribe=()=>{this._orderSubscription&&this._orderSubscription.unsubscribe()},this._orderSubscriptionValues=e=>{const t=(0,
r.ensureDefined)(this._props),{status:s,orderType:o,orderPlacingStatus:n,side:a,quantity:l,stopPrice:u,limitPrice:d}=e;if(s===E.OrderPanelStatus.Preview)return this._value.next({primaryText:b.t(null,void 0,i(454674))});if(s===E.OrderPanelStatus.Wait)return n===E.OrderPlacingStatus.Placed?this._value.next({primaryText:b.t(null,void 0,i(348649))}):this._value.next({primaryText:tt,secondaryText:it});const h=null!==u?t.formatter.format(u):"",c=null!==d?t.formatter.format(d):"",p=null!==l?t.quantityFormatter.format(l):"",_=1===a?b.t(null,void 0,i(169961)):b.t(null,void 0,i(168222));switch(o){case 2:return this._value.next({primaryText:_,secondaryText:Je(p,t.symbol)});case 3:return this._value.next({primaryText:_,secondaryText:Xe(p,t.symbol,h)});case 1:return this._value.next({primaryText:_,secondaryText:Ze(p,t.symbol,c)});case 4:return this._value.next({primaryText:_,secondaryText:et(p,t.symbol,h,c)})}},this._tradingEntityType=e,this._value=new n.BehaviorSubject({primaryText:""}),this.value$=this._value.asObservable(),this._props=t,this._setInitialValue()}_setInitialValue(){var e,t;const s=(null===(e=this._props)||void 0===e?void 0:e.displayMode)===E.OrderEditorDisplayMode.ResizableDrawer?b.t(null,void 0,i(561874)):b.t(null,void 0,i(224522));switch(this._tradingEntityType){case L.TradingEntityType.Order:const e=!0===(null===(t=this._props)||void 0===t?void 0:t.existingOrder)?s:"";this._value.next({primaryText:e});break;case L.TradingEntityType.Position:this._value.next({primaryText:b.t(null,void 0,i(561874))})}}}i(150335);function rt(e,t,i,s,r){return ot(e,t,i/s,r)}function ot(e,t,i,s){return e*t*i*(s||1)}class nt{constructor({marginAvailable$:e,qty$:t,currency:i,pipValue$:s,price$:r,side$:o,showTotalInsteadOfTradeValue:a,showRiskControlsAndInfo:l,info:u,tpInfo:d,slInfo:h,supportMargin:c,pipValueType$:p,leverageInfo$:_}){this._infoTableData$=new n.BehaviorSubject({rows:[]}),this._availableMargin$=new n.BehaviorSubject(0),this._usedMargin$=new n.BehaviorSubject(0),this._leverageInfo=null,this._subscriptions=[],this._tpEnabled$=null,this._tpRiskInCurrency$=null,this._tpRiskInPercent$=null,this._slEnabled$=null,this._slRiskInCurrency$=null,this._slRiskInPercent$=null,this._riskFormatter=new A.PriceFormatter({priceScale:100}),this.infoTableData$=this._infoTableData$.asObservable(),this.availableMargin$=this._availableMargin$.asObservable(),this.usedMargin$=this._usedMargin$.asObservable(),this._marginAvailable$=e,this._qty$=t,this._pipValue$=s,this._side$=o,this._type=u.type,this._pipValueType$=p,this._currency=i,this._marginRate=u.marginRate,this._hasMarginMeter=c&&(void 0!==_||void 0!==this._marginRate),this._price$=r,this._showTotalInsteadOfTradeValue=a,this._showRiskControlsAndInfo=l,this._bigPointValue=u.bigPointValue||1,this._instrumentCurrency=u.currency,this._leverageInfo$=_,this._leverage=u.leverage,this._lotSize=u.lotSize,this._symbolPipSize=u.pipSize,this._pipValueForCurrentQuantity=0,this._tradeValueInSymbolCurrency=0,this._tradeValue=0,this._priceMagnifier=u.priceMagnifier,d&&h&&(this._tpEnabled$=d.enabled,
this._tpRiskInCurrency$=d.riskInCurrency,this._tpRiskInPercent$=d.riskInPercent,this._slEnabled$=h.enabled,this._slRiskInCurrency$=h.riskInCurrency,this._slRiskInPercent$=h.riskInPercent)}subscribe(){this._subscriptions=[(0,M.combineLatest)({price:this._price$,pipValue:this._pipValue$,pipValueType:this._pipValueType$,side:this._side$,qty:this._qty$,leverageInfo:void 0!==this._leverageInfo$?this._leverageInfo$:(0,w.of)(null),tpEnabled:null!==this._tpEnabled$?this._tpEnabled$:(0,w.of)(null),tpRiskInCurrency:null!==this._tpRiskInCurrency$?this._tpRiskInCurrency$:(0,w.of)(null),tpRiskInPercent:null!==this._tpRiskInPercent$?this._tpRiskInPercent$:(0,w.of)(null),slEnabled:null!==this._slEnabled$?this._slEnabled$:(0,w.of)(null),slRiskInCurrency:null!==this._slRiskInCurrency$?this._slRiskInCurrency$:(0,w.of)(null),slRiskInPercent:null!==this._slRiskInPercent$?this._slRiskInPercent$:(0,w.of)(null)}).pipe(ye(100,void 0,{trailing:!0,leading:!0})).subscribe((e=>{const{price:t,pipValue:i,pipValueType:s,qty:r,leverageInfo:o,tpEnabled:n,tpRiskInCurrency:a,tpRiskInPercent:l,slEnabled:u,slRiskInCurrency:d,slRiskInPercent:h}=e;if(this._leverageInfo=o,this._pipValueForCurrentQuantity=(0,j.convertToBaseMonetaryUnit)((0,j.calculatePipValue)(r,i,this._lotSize),this._priceMagnifier),null===r)this._tradeValue=0,this._tradeValueInSymbolCurrency=0;else{const e="crypto"===this._type?(0,Ce.Big)(r).mul(t).toNumber():rt(r,t,i,this._symbolPipSize,this._lotSize);this._tradeValue=(0,j.convertToBaseMonetaryUnit)(e,this._priceMagnifier);const s=ot(r,t,this._bigPointValue,this._lotSize);this._tradeValueInSymbolCurrency=(0,j.convertToBaseMonetaryUnit)(s,this._priceMagnifier)}const c=[];c.push(...this._makeLotSizeInfo(),...this._makePipValueInfo(s),...this._makeTradeValueInfo(),...this._makeRewardInfo(n,a,l),...this._makeRiskInfo(u,d,h));const p=this._getMarginRate();null===o&&c.unshift(...this._makeLeverageInfo()),this._usedMargin$.next((0,j.calculateUsedMargin)(this._tradeValue,p)),this._infoTableData$.next({rows:c})}))],this._hasMarginMeter&&this._subscriptions.push((0,r.ensureNotNull)(this._marginAvailable$).subscribe((e=>this._updateAvailableMargin(e))))}unsubscribe(){this._subscriptions.map((e=>e.unsubscribe()))}title(){return b.t(null,void 0,i(330569))}getOrderInfoTableRowsCount(){return this._infoTableData$.getValue().rows.length}hasMarginMeter(){return this._hasMarginMeter}hasTradeValue(){const e=this._getMarginRate();return Boolean(this._showRiskControlsAndInfo&&Number.isFinite(this._tradeValue)&&(this._isSymbolTypeSupportTradeValue()||void 0!==e))}_getTradeValue(){var e;if(this.hasTradeValue())return(0,j.formatInfoValue)(this._tradeValue*(null!==(e=this._getMarginRate())&&void 0!==e?e:1))}_updateAvailableMargin(e){this._availableMargin$.next(e)}_makeLeverageInfo(){const e=(0,j.displayedLeverage)(this._leverage,this._marginRate);return null===e?[]:[{title:b.t(null,void 0,i(824813)),value:e}]}_makeLotSizeInfo(){return"number"==typeof this._lotSize&&Number.isFinite(this._lotSize)?[{title:b.t(null,void 0,i(574045)),value:String(this._lotSize)}]:[]
}_makePipValueInfo(e){return this._showRiskControlsAndInfo&&e!==L.PipValueType.None&&Number.isFinite(this._pipValueForCurrentQuantity)?[{title:e===L.PipValueType.Pips?b.t(null,void 0,i(207074)):b.t(null,void 0,i(414285)),value:`${(0,j.formatInfoValue)(this._pipValueForCurrentQuantity)} ${this._currency}`}]:[]}_makeTradeValueInfo(){const e=this._getTradeValue();if(void 0===e)return[];const t=this._showTotalInsteadOfTradeValue?b.t(null,void 0,i(408007)):b.t(null,void 0,i(248410)),s=this._getTradeValueInSymbolCurrency();return void 0===s?[{title:t,value:`${e} ${this._currency}`}]:[{title:t},{title:b.t(null,void 0,i(902456)),value:`${e} ${this._currency}`,listMarker:!0},{title:b.t(null,void 0,i(270743)),value:`${s} ${this._instrumentCurrency}`,listMarker:!0}]}_getTradeValueInSymbolCurrency(){var e;const t=null!==(e=this._getMarginRate())&&void 0!==e?e:1;if(void 0!==this._instrumentCurrency&&this._instrumentCurrency!==this._currency&&Number.isFinite(this._tradeValueInSymbolCurrency))return(0,j.formatInfoValue)(this._tradeValueInSymbolCurrency*t)}_getMarginRate(){return null!==this._leverageInfo?0!==this._leverageInfo.leverage?(0,Ce.Big)(1).div(this._leverageInfo.leverage).toNumber():void 0:void 0!==this._marginRate&&this._marginRate>0?this._marginRate:void 0}_isSymbolTypeSupportTradeValue(){return void 0!==this._type&&["stock","dr","right","bond","warrant","structured"].includes(this._type)}_makeRewardInfo(e,t,s){return this._showRiskControlsAndInfo&&e&&null!==t&&null!==s?[{title:b.t(null,void 0,i(65183)),value:`${this._riskFormatter.format(s)}% (${this._riskFormatter.format(t)} ${this._currency})`}]:[]}_makeRiskInfo(e,t,s){return this._showRiskControlsAndInfo&&e&&null!==t&&null!==s?[{title:b.t(null,void 0,i(663886)),value:`${this._riskFormatter.format(s)}% (${this._riskFormatter.format(t)} ${this._currency})`}]:[]}}const at=(0,p.getLogger)("PromiseWithDefault");function lt(e,t,i){return e.catch((e=>(at.logError(e),i&&i(),t)))}const ut={symbol:b.t(null,void 0,i(595481)),ask:b.t(null,void 0,i(535928)),bid:b.t(null,void 0,i(395506)),orderType:b.t(null,void 0,i(998413)),side:b.t(null,void 0,i(777630)),quantity:b.t(null,void 0,i(598721)),price:b.t(null,void 0,i(7953)),stopPrice:b.t(null,void 0,i(475299)),limitPrice:b.t(null,void 0,i(277646)),currency:b.t(null,void 0,i(381849)),stopLoss:b.t(null,void 0,i(719702)),takeProfit:b.t(null,void 0,i(255739)),buy:b.t(null,void 0,i(169961)),sell:b.t(null,void 0,i(168222)),warning:b.t(null,void 0,i(627822))};class dt{constructor(e,t,i,s,r,o,a,l){this.warnings=[],this.errors=[],this._infoTableQuotesData$=new n.BehaviorSubject({rows:[]}),this._infoTableOrderData={rows:[]},this._infoTableCustomData=[],this.order=e,this.confirmId=t.confirmId,this.onCancelClick=s,this.onPlaceClick=r,this._quotes$=i,this._currency=l,this._formatter=o,this._quantityFormatter=a,this._infoTableCustomData=t.sections,this._fillQuotesInfo(),this._fillOrderInfo(),(e.takeProfit||e.stopLoss)&&this.warnings.push(ut.warning),t.warnings&&this.warnings.push(...t.warnings),t.errors&&this.errors.push(...t.errors),
this.infoTableQuotesData$=this._infoTableQuotesData$.asObservable()}subscribe(){return this._quotes$.pipe((0,ve.distinctUntilChanged)(((e,t)=>e.ask===t.ask&&e.bid===t.bid))).subscribe((e=>this._fillQuotesInfo(e)))}infoTableOrderData(){return this._infoTableOrderData}infoTableCustomData(){return this._infoTableCustomData}_fillQuotesInfo(e){const t=[{title:ut.symbol,value:this.order.symbol},{title:ut.ask,value:e?this._formatter.format(e.ask):""},{title:ut.bid,value:e?this._formatter.format(e.bid):""}];this._infoTableQuotesData$.next({rows:t})}_fillOrderInfo(){this._infoTableOrderData.rows.push({title:ut.orderType,value:this.order.type?E.orderTypes[this.order.type]:""},{title:ut.side,value:1===this.order.side?ut.buy:ut.sell,type:1===this.order.side?0:1},{title:ut.quantity,value:this._quantityFormatter.format(this.order.qty)}),3!==this.order.type&&1!==this.order.type||this._infoTableOrderData.rows.push({title:ut.price,value:this._formatter.format(3===this.order.type?this.order.stopPrice:this.order.limitPrice)}),4===this.order.type&&this._infoTableOrderData.rows.push({title:ut.stopPrice,value:this._formatter.format(this.order.stopPrice)},{title:ut.limitPrice,value:this._formatter.format(this.order.limitPrice)}),this.order.stopLoss&&this._infoTableOrderData.rows.push({title:ut.stopLoss,value:this._formatter.format(this.order.stopLoss)}),this.order.takeProfit&&this._infoTableOrderData.rows.push({title:ut.takeProfit,value:this._formatter.format(this.order.takeProfit)}),this._currency.length>0&&this._infoTableOrderData.rows.push({title:ut.currency,value:this._currency})}}var ht=i(73359),ct=i(350146);const pt=_.enabled("order_panel_undock");function _t(e){const{pin:t,mode$:s,settings$:r,currency:o,showRelativePriceControl:n,showRiskControlsAndInfo:a,showQuantityInsteadOfAmount:l,supportBrackets:u,supportPlaceOrderPreview:d,supportModifyOrderPreview:h,isUndockAllowed:c,toggleSettings:p}=e,_=e=>()=>p(e),y=e=>r.pipe((0,P.map)((t=>!!t[e]))),g=[];if(c&&pt&&g.push({settingType:1,onLabel:b.t(null,void 0,i(702733)),offLabel:b.t(null,void 0,i(442956)),dataName:"dock-undock-order-panel-button",onIcon:ht,offIcon:ct,onClick:()=>t(),value$:s.pipe((0,P.map)((e=>e===E.OrderEditorDisplayMode.Panel)))}),n&&g.push({settingType:0,label:b.t(null,void 0,i(373447)),onClick:_("showRelativePriceControl"),value$:y("showRelativePriceControl")}),a){{const e=l?b.t(null,void 0,i(973085)):b.t(null,void 0,i(973353));g.push({settingType:0,label:e.replace("{units}",o||"Money"),onClick:_("showCurrencyRiskInQty"),value$:y("showCurrencyRiskInQty")},{settingType:0,label:e.replace("{units}","%"),onClick:_("showPercentRiskInQty"),value$:y("showPercentRiskInQty")})}if(u){const e=b.t(null,void 0,i(271854));0,g.push({settingType:0,label:e.replace("{units}",o||"Money"),onClick:_("showBracketsInCurrency"),value$:y("showBracketsInCurrency")},{settingType:0,label:e.replace("{units}","%"),onClick:_("showBracketsInPercent"),value$:y("showBracketsInPercent")})}}return(d||h)&&g.push({settingType:0,label:b.t(null,void 0,i(74600)),onClick:_("showOrderPreview"),
value$:y("showOrderPreview")}),g}const yt=(0,p.getLogger)("Trading.OrderViewModel");class bt{constructor({adapter:e,order:t,settings$:s,isTradable:r,isUndockAllowed:o,orderWidgetStat:a=null,pipValueType$:l,onNeedSelectBroker:u,displayMode$:d,getDisplayMode:h,trackEvent:c,toggleTradingWidget:p,toggleTradingPanelPopup:_,toggleMode:P,showErrorNotification:C,sendHandler:$,previewHandler:M,toggleSettings:w,getSettings:V,orderViewInputState:I,forceAbsolutePriceUpdate:O,qtySuggester:B,isVisible:D,orderDialogOptions:L,informerMessage$:R,warningMessage$:F,headerState:z,isOrderPresetsEnabled:W}){var U,G,H,K,Y;if(this.orderInfoModel=null,this.orderPreviewModel=null,this.onDoneButtonClicked=(0,g.createDeferredPromise)(),this.needSignIn=!1,this.noBroker=!1,this.symbolHasLotSize=!1,this.id=(0,x.randomHashN)(6),this.existingOrder=!1,this._onInputStateChanged=new Q.Delegate,this._onCloseButtonClicked=new Q.Delegate,this._onBackButtonClicked=new Q.Delegate,this._onFocusSubscriptions=[],this._subscriptions=[],this._orderType$=new n.BehaviorSubject(null),this._loading$=new n.BehaviorSubject(!1),this._stopLossPips$=new n.BehaviorSubject(null),this._isButtonDisabled$=new n.BehaviorSubject(!0),this._rewardRisk$=new n.BehaviorSubject(""),this._isNoQuotes$=new n.BehaviorSubject(!1),this._orderWidgetStat=null,this._existingPlacedOrder=null,this._marginAvailable$=null,this._baseCurrencyCryptoBalance$=null,this._quoteCurrencyCryptoBalance$=null,this._orderPlacingStatus=new n.BehaviorSubject(E.OrderPlacingStatus.Creating),this._destroyed=!1,this._setSolutionAccount=null,this._isBats=!1,this.doneButtonClick=async()=>{if(!this._loading$.getValue()){this.setLoading(!0);try{await this._doneButtonClick()}finally{this.setLoading(!1)}}},this.getOrderType=()=>this._orderType$.value,this.setOrderType=e=>{this._orderType$.next(e)},this.activateOrderTicket=()=>{var e;this.setStatus(this.existingOrder?E.OrderPanelStatus.Editing:E.OrderPanelStatus.Active),null===(e=this._orderTypeSubscription)||void 0===e||e.unsubscribe(),this.sideModel&&this.sideModel.onControlFocused.unsubscribe(this,this.activateOrderTicket),this.limitPriceModel&&this.limitPriceModel.onControlFocused.unsubscribe(this,this.activateOrderTicket),this.stopPriceModel&&this.stopPriceModel.onControlFocused.unsubscribe(this,this.activateOrderTicket),this.quantityModel&&this.quantityModel.onControlFocused.unsubscribe(this,this.activateOrderTicket),this.leverageModel&&this.leverageModel.onControlFocused.unsubscribe(this,this.activateOrderTicket),this.takeProfitModel&&this.takeProfitModel.onControlFocused.unsubscribe(this,this.activateOrderTicket),this.stopLossModel&&this.stopLossModel.onControlFocused.unsubscribe(this,this.activateOrderTicket),this.durationModel&&this.durationModel.onControlFocused.unsubscribe(this,this.activateOrderTicket),this._onFocusSubscriptions.forEach((e=>e.unsubscribe())),this._orderPlacingStatus.next(E.OrderPlacingStatus.Creating)},this.setLoading=e=>{this._loading$.next(e)},this.setStatus=e=>{this._status$.value!==e&&this._status$.next(e)},
this._doneButtonClick=async()=>{const e=this.preOrder();if((this.existingOrder?this.supportModifyOrderPreview:this.supportPlaceOrderPreview)&&this._getSettings().showOrderPreview&&null===this.orderPreviewModel){const t=this.supportModifyOrderPreview&&null!==this._existingPlacedOrder?{...e,id:this._existingPlacedOrder.id}:e;try{const e=await this._previewHandler(t),i=this.supportCurrencyInOrderPreview&&void 0!==this._symbolInfo.currency?this._symbolInfo.currency:"";this.orderPreviewModel=new dt(t,e,this._quotes$,this._back,this.doneButtonClick,this.formatter,this.quantityModel.formatter,i),this._subscriptions.push(this.orderPreviewModel.subscribe()),this.setStatus(E.OrderPanelStatus.Preview)}catch(e){this._isFullscreenPopup()&&this.headerModel.close(),this._showErrorNotification(b.t(null,void 0,i(204395)),(0,y.getErrorMessage)(e))}return}const t=await this._doneHandler(e,null!==this.orderPreviewModel?this.orderPreviewModel.confirmId:void 0),s=this._getDisplayMode();t?(this.onDoneButtonClicked.resolve(!0),s===E.OrderEditorDisplayMode.Popup||s===E.OrderEditorDisplayMode.ResizableDrawer?this.headerModel.close():this._cancel(),this.existingOrder||this._orderPlacingStatus.next(E.OrderPlacingStatus.Placed)):(this._isFullscreenPopup()&&this.headerModel.close(),s===E.OrderEditorDisplayMode.Panel&&null!==this.orderPreviewModel&&1===this._adapter.connectionStatus()&&this._back()),this.orderPreviewModel=null},this._noQuotesCallback=()=>{this._trackEvent("Order Ticket","No Quotes")},this._handleStatusChange=e=>{const t=e!==E.OrderPanelStatus.Preview&&this._isTradable?this._makeHeaderSettings():void 0;this._headerState.setSettings(t)},this._mergeInputStateDiff=e=>{void 0!==e.duration&&(this._currentInputState.duration=null),(0,v.default)(this._currentInputState,e)},this._back=()=>{this._cleanUp(),this._onBackButtonClicked.fire()},this._onSuggestedQtyChange=e=>{this._suggestedQty=e,!this._isOrderSizeCalculatorAvailable()&&this.quantityModel&&this.quantityModel.getValue()!==e&&(this.quantityModel.setFocusedControl(this.supportCryptoExchangeOrderTicket()?3:0),this.quantityModel.quantity.setValue(e))},this._onQtyChange=e=>{this._isOrderSizeCalculatorAvailable()||null===e||this._qtySuggester.setQty(this.symbol,e)},this._isOrderPresetsEnabled=W,this._isTradable=r.tradable,this._headerState=z,this.headerStateValue=z,this._headerState.setSettings(void 0),this._displayMode$=d,this._getDisplayMode=h,this._toggleTradingWidget=p,this._toggleTradingPanelPopup=_,this._toggleMode=P,this._toggleSettings=w,this._getSettings=V,this._onNeedSelectBroker=u,this._showErrorNotification=C,this._trackEvent=c,this._orderWidgetStat=a,this._pipValueType$=l,this._qtySuggester=B,this._informerMessage$=R,this._settings$=s,this._orderTemplate=Object.assign({},t),function(e){return e.hasOwnProperty("id")}(t)&&(this.existingOrder=!0,this._existingPlacedOrder=t),this.warningMessage$=F,this.symbol=t.symbol,this.displaySymbolName=this._getCurrentSymbolName(),this._isUndockAllowed=o,this._isVisible=D,
this._status$=new n.BehaviorSubject(this.existingOrder?E.OrderPanelStatus.Editing:E.OrderPanelStatus.Active),this._stopLossAvailable$=new n.BehaviorSubject(Boolean(null!==(G=null!==(U=t.trailingStopPips)&&void 0!==U?U:t.guaranteedStop)&&void 0!==G?G:t.stopLoss)),this.orderType$=this._orderType$.asObservable(),this.loading$=this._loading$.asObservable(),this.status$=this._status$.asObservable(),this.rewardRisk$=this._rewardRisk$.asObservable(),this.isNoQuotes$=this._isNoQuotes$.asObservable(),this.isButtonDisabled$=this._isButtonDisabled$.asObservable(),null===e)return void(this.onReady=Promise.resolve());if(this._adapter=e,this.brokerName=e.metainfo().title,!r.tradable)return void(this.onReady=this._prepareTradableSolution(r));this._sendHandler=$,this._previewHandler=M,this.existingOrder=t.hasOwnProperty("id"),this.setStatus(this.existingOrder?E.OrderPanelStatus.Editing:E.OrderPanelStatus.Active);const J=e.metainfo().configFlags;this.supportModifyOrderPrice=J.supportModifyOrderPrice,this.supportModifyQuantity=!this.existingOrder||Boolean(this.existingOrder&&J.supportEditAmount),this.showQuantityInsteadOfAmount=J.showQuantityInsteadOfAmount,this.supportModifyDuration=J.supportModifyDuration,this.supportLeverage=J.supportLeverage,this.supportLeverageButton=J.supportLeverage&&J.supportLeverageButton,this.supportPlaceOrderPreview=J.supportPlaceOrderPreview,this.supportModifyOrderPreview=J.supportModifyOrderPreview,this.supportBalances=J.supportBalances,this.supportCryptoBrackets=J.supportCryptoBrackets,this.supportStopOrdersInBothDirections=J.supportStopOrdersInBothDirections,this.supportStopLimitOrdersInBothDirections=J.supportStopLimitOrdersInBothDirections,this.supportStrictCheckingLimitOrderPrice=J.supportStrictCheckingLimitOrderPrice,this.supportCurrencyInOrderPreview=J.supportCurrencyInOrderPreview,this.supportModifyOrderType=J.supportModifyOrderType,this._orderType$.next(null!==(Y=null!==(K=null!==(H=t.type)&&void 0!==H?H:null==I?void 0:I.orderType)&&void 0!==K?K:(0,q.getDefaultOrderType)(J))&&void 0!==Y?Y:null),this.onReady=Promise.all([e.symbolInfo(t.symbol),e.getSymbolSpecificTradingOptions(t.symbol),lt(e.accountMetainfo(),{id:e.currentAccount(),name:e.metainfo().title}),lt(e.quotesSnapshot(t.symbol),{},this._noQuotesCallback),lt(e.formatter(t.symbol,!1),new A.PriceFormatter),lt(e.spreadFormatter(t.symbol),new A.PriceFormatter)]).then((async([i,s,o,n,a,l])=>{if(this._isBats=(0,q.isBatsQuotes)(n),this._supportCryptoExchangeOrderTicket=J.supportCryptoExchangeOrderTicket||J.supportSymbolSpecificCryptoOrderTicket&&"crypto"===i.type,this._symbolInfo=i,this._destroyed)return;this._supportMarketOrders=J.supportMarketOrders&&(0,q.isOrderTypeAllowed)(2,null==s?void 0:s.allowedOrderTypes),this._supportLimitOrders=J.supportLimitOrders&&(0,q.isOrderTypeAllowed)(1,null==s?void 0:s.allowedOrderTypes),this._supportStopOrders=J.supportStopOrders&&(0,q.isOrderTypeAllowed)(3,null==s?void 0:s.allowedOrderTypes),this._supportStopLimitOrders=J.supportStopLimitOrders&&(0,q.isOrderTypeAllowed)(4,null==s?void 0:s.allowedOrderTypes),
this._supportBrackets=(null==s?void 0:s.supportOrderBrackets)&&!(t.hasOwnProperty("parentId")&&t.parentId),this._supportModifyBrackets=this._supportBrackets&&J.supportModifyBrackets,this._supportAddBracketsToExistingOrder=this._supportModifyBrackets&&J.supportAddBracketsToExistingOrder,this._supportTrailingStop=this._supportBrackets&&J.supportTrailingStop,this._supportGuaranteedStop=this._supportBrackets&&J.supportGuaranteedStop,this._supportMarketBrackets=this._supportBrackets&&J.supportMarketBrackets,this._supportModifyTrailingStop=this._supportTrailingStop&&this._supportModifyBrackets&&J.supportModifyTrailingStop,this.displaySymbolName=this._getCurrentSymbolName(),this.symbolType=i.type,this.symbolSpecificWarningMessage=null==s?void 0:s.warningMessage,this.currency=(0,q.getCurrency)(o),this._currencyName=(0,q.getCurrency)(o,!0),this.formatter=a,this.symbolHasLotSize=i.hasOwnProperty("lotSize"),this.showRiskControlsAndInfo=J.supportRiskControlsAndInfo&&0!==i.pipValue,this._suggestedQty=await this._qtySuggester.getQty(this.symbol),this._initialInputState=this._getInitialInputState(t,i,I,s),this._currentInputState=Object.assign({},this._initialInputState);const u=i.variableMinTick?(0,N.makeVariableMinTickData)(i.minTick,i.variableMinTick):void 0;this._quotes$=(0,k.fromEventPattern)((i=>e.subscribeRealtime(t.symbol,i)),(i=>e.unsubscribeRealtime(t.symbol,i)),((e,t)=>(0,j.alignQuotesToMinTick)(t,i.minTick,u))).pipe((0,m.startWith)(n),(0,f.share)({connector:()=>new S.ReplaySubject(1)})),this._equity$=(0,k.fromEventPattern)((t=>e.subscribeEquity(t)),(t=>e.unsubscribeEquity(t)),((e,t)=>t)).pipe((0,m.startWith)(NaN),(0,f.share)({connector:()=>new S.ReplaySubject(1)})),this._marginAvailable$=J.supportMargin?T((0,k.fromEventPattern)((t=>e.subscribeMarginAvailable(t)),(t=>e.unsubscribeMarginAvailable(t)),((e,t)=>t))):null,this._baseCurrencyCryptoBalance$=J.supportBalances?T((0,k.fromEventPattern)((t=>e.subscribeCryptoBalance(i.baseCurrency||"",t)),(t=>e.unsubscribeCryptoBalance(i.baseCurrency||"",t)),((e,t)=>t)).pipe((0,m.startWith)({symbol:i.baseCurrency||"",total:0,available:0}))):null,this._quoteCurrencyCryptoBalance$=J.supportBalances?T((0,k.fromEventPattern)((t=>e.subscribeCryptoBalance(i.quoteCurrency||"",t)),(t=>e.unsubscribeCryptoBalance(i.quoteCurrency||"",t)),((e,t)=>t)).pipe((0,m.startWith)({symbol:i.quoteCurrency||"",total:0,available:0}))):null,this._pipValues$=T((0,k.fromEventPattern)((i=>e.subscribePipValue(t.symbol,i)),(i=>e.unsubscribePipValue(t.symbol,i)),((e,t)=>t)).pipe((0,m.startWith)({buyPipValue:i.pipValue,sellPipValue:i.pipValue}))),void 0===this._orderTemplate.limitPrice&&!1===this.existingOrder&&(this._orderTemplate.limitPrice=1===this._initialInputState.side?(0,q.getAsk)(n):(0,q.getBid)(n)),void 0===this._orderTemplate.stopPrice&&!1===this.existingOrder&&(this._orderTemplate.stopPrice=1===this._initialInputState.side?(0,q.getBid)(n):(0,q.getAsk)(n)),this._createModels({order:t,info:i,spreadFormatter:l,isTradable:r.tradable,symbolSpecificTradingOptions:s,forceAbsolutePriceUpdate:O,orderDialogOptions:L
}),this._subscribe(),this._onInputStateChanged.fire(this._getCurrentInputState()),this._headerState.setSettings(this._makeHeaderSettings())})).catch((e=>{throw yt.logError("Failed to create order model: "+e),e}))}destroy(){var e;this._destroyed=!0,this.onInputStateChanged().unsubscribe(this,this._mergeInputStateDiff),this._subscriptions.forEach((e=>e&&e.unsubscribe())),null===(e=this.orderInfoModel)||void 0===e||e.unsubscribe(),this._orderTypeSubscription&&this._orderTypeSubscription.unsubscribe(),this._onFocusSubscriptions.forEach((e=>e.unsubscribe())),this.headerModel&&(this.headerModel.unsubscribe(),this.headerModel.pinButtonClicked().unsubscribe(this,this._toggleMode),this.headerModel.closeButtonClicked().unsubscribe(this,this._closeWidget),this.headerModel.backButtonClicked().unsubscribe(this,this._back)),this.sideModel&&(this.sideModel.unsubscribe(),this.sideModel.onControlFocused.unsubscribe(this,this.activateOrderTicket)),this.limitPriceModel&&(this.limitPriceModel.unsubscribe(),this.limitPriceModel.onControlFocused.unsubscribe(this,this.activateOrderTicket)),this.stopPriceModel&&(this.stopPriceModel.unsubscribe(),this.stopPriceModel.onControlFocused.unsubscribe(this,this.activateOrderTicket)),this.priceGroupModel&&this.priceGroupModel.unsubscribe(),this.quantityConverterController&&this.quantityConverterController.destroy(),this.quantityModel&&(this.quantityModel.unsubscribe(),this.quantityModel.onControlFocused.unsubscribe(this,this.activateOrderTicket)),this.takeProfitModel&&(this.takeProfitModel.unsubscribe(),this.takeProfitModel.onControlFocused.unsubscribe(this,this.activateOrderTicket)),this.stopLossModel&&(this.stopLossModel.unsubscribe(),this.stopLossModel.onControlFocused.unsubscribe(this,this.activateOrderTicket)),this.durationModel&&(this.durationModel.unsubscribe(),this.durationModel.onControlFocused.unsubscribe(this,this.activateOrderTicket)),void 0!==this.leverageModel&&(this.leverageModel.unsubscribe(),this.leverageModel.onControlFocused.unsubscribe(this,this.activateOrderTicket)),void 0!==this.customFieldsModel&&this.customFieldsModel.unsubscribe(),void 0!==this.buttonModel&&this.buttonModel.unsubscribe(),this._adapter&&this._adapter.orderUpdate.unsubscribe(this,this._orderUpdate)}supportCryptoExchangeOrderTicket(){return Boolean(this._supportCryptoExchangeOrderTicket)}supportLimitOrders(){return Boolean(this._supportLimitOrders)}supportMarketOrders(){return Boolean(this._supportMarketOrders)}supportStopOrders(){return Boolean(this._supportStopOrders)}supportStopLimitOrders(){return Boolean(this._supportStopLimitOrders)}supportBrackets(){return Boolean(this._supportBrackets)}supportAddBracketsToExistingOrder(){return Boolean(this._supportAddBracketsToExistingOrder)}supportModifyBrackets(){return Boolean(this._supportModifyBrackets)}supportTrailingStop(){return Boolean(this._supportTrailingStop)}supportGuaranteedStop(){return Boolean(this._supportGuaranteedStop)}supportMarketBrackets(){return Boolean(this._supportMarketBrackets)}supportModifyTrailingStop(){
return Boolean(this._supportModifyTrailingStop)}onInputStateChanged(){return this._onInputStateChanged}onCloseButtonClicked(){return this._onCloseButtonClicked}onBackButtonClicked(){return this._onBackButtonClicked}side(){var e;return null===(e=this.sideModel)||void 0===e?void 0:e.getValue()}setSolutionAccount(){null!==this._setSolutionAccount&&this._setSolutionAccount()}selectBroker(){this._toggleTradingWidget().then((()=>this._onNeedSelectBroker.fire()))}orderWidgetStat(){return this._orderWidgetStat}resetOrderPanel(){this._cancel()}deactivateOrderTicket(){this.getStatus()!==E.OrderPanelStatus.Wait&&(this._resetBracketsFocus(),this.setStatus(E.OrderPanelStatus.Wait),this._orderTypeSubscription=this.orderType$.pipe((0,c.skip)(1)).subscribe(this.activateOrderTicket),this.sideModel&&this.sideModel.onControlFocused.subscribe(this,this.activateOrderTicket),this.limitPriceModel&&this.limitPriceModel.onControlFocused.subscribe(this,this.activateOrderTicket),this.stopPriceModel&&this.stopPriceModel.onControlFocused.subscribe(this,this.activateOrderTicket),this.quantityModel&&this.quantityModel.onControlFocused.subscribe(this,this.activateOrderTicket),void 0!==this.leverageModel&&this.leverageModel.onControlFocused.subscribe(this,this.activateOrderTicket),this.takeProfitModel&&(this.takeProfitModel.setEnabled(!1),this.takeProfitModel.onControlFocused.subscribe(this,this.activateOrderTicket)),this.stopLossModel&&(this.stopLossModel.setEnabled(!1),this.stopLossModel.onControlFocused.subscribe(this,this.activateOrderTicket)),this.durationModel&&this.durationModel.onControlFocused.subscribe(this,this.activateOrderTicket),this._onFocusSubscriptions.push(this.customFieldsModel.onControlFocused$.subscribe(this.activateOrderTicket)),this._setDisabledIfNeeded({status:this.getStatus(),loading:this._loading$.getValue(),quotes:null,side:this.sideModel?this.sideModel.getValue():null,limitPrice:this.limitPriceModel?this.limitPriceModel.getValue():null,stopPrice:this.stopPriceModel?this.stopPriceModel.getValue():null,quantity:this.quantityModel?this.quantityModel.getValue():null,hasStopLossError:!1,hasTakeProfitError:!1,isTakeProfitIncorrect:!!this.takeProfitModel&&this.takeProfitModel.isValueIncorrect(),isStopLossIncorrect:!!this.stopLossModel&&this.stopLossModel.isValueIncorrect(),customFields:this.customFieldsModel.getCustomFieldsInputValues(),hasDurationError:!1,hasLimitPriceError:!1,hasStopPriceError:!1,hasQuantityError:!1}))}preOrder(){var e,t,i,s;const o={symbol:this.symbol,type:(0,r.ensureNotNull)(this._orderType$.value,"Make pre-order: Order type value"),qty:(0,r.ensureNotNull)(this.quantityModel.getValue(),"Make pre-order: Quantity model value"),side:this.sideModel.getValue(),seenPrice:this._calculateSeenPrice(),currentQuotes:this._getCurrentQuotes(),source:this._orderTemplate.source};4===this._orderType$.value?(o.stopPrice=null!==(e=this.stopPriceModel.getValue())&&void 0!==e?e:void 0,
o.limitPrice=null!==(t=this.limitPriceModel.getValue())&&void 0!==t?t:void 0):3===this._orderType$.value?o.stopPrice=null!==(i=this.stopPriceModel.getValue())&&void 0!==i?i:void 0:1===this._orderType$.value&&(o.limitPrice=null!==(s=this.limitPriceModel.getValue())&&void 0!==s?s:void 0);const n=this.durationModel.getValue();return null!==n&&(o.duration=n),this.stopLossModel&&(this.stopLossModel.getBracketType()===L.BracketType.StopLoss&&(o.stopLoss=this.stopLossModel.getEnabled()?(0,r.ensureNotNull)(this.stopLossModel.price.getValue(),"Make pre-order: StopLoss Model price value"):void 0,o.trailingStopPips=void 0,o.guaranteedStop=void 0,o.stopType=D.StopType.StopLoss),this.stopLossModel.getBracketType()===L.BracketType.TrailingStop&&(o.trailingStopPips=this.stopLossModel.getEnabled()?(0,r.ensureNotNull)(this.stopLossModel.pips.getValue(),"Make pre-order: StopLoss Model value"):void 0,o.stopLoss=void 0!==o.trailingStopPips?void 0:o.stopLoss,o.guaranteedStop=void 0,o.stopType=D.StopType.TrailingStop),this.stopLossModel.getBracketType()===L.BracketType.GuaranteedStop&&(o.guaranteedStop=this.stopLossModel.getEnabled()?(0,r.ensureNotNull)(this.stopLossModel.price.getValue(),"Make pre-order: StopLoss Model price value"):void 0,o.stopLoss=void 0!==o.guaranteedStop?void 0:o.stopLoss,o.trailingStopPips=void 0,o.stopType=D.StopType.GuaranteedStop)),this.takeProfitModel&&(o.takeProfit=this.takeProfitModel.getEnabled()?(0,r.ensureNotNull)(this.takeProfitModel.price.getValue(),"Make pre-order: Take Profit Model price value"):void 0),this.customFieldsModel.getCustomFieldsModels()&&(o.customFields=this.customFieldsModel.getCustomFieldsInputValues()),o}getStatus(){return this._status$.getValue()}isButtonDisabled(){return this._isButtonDisabled$.getValue()}_isFullscreenPopup(){return window.matchMedia(F.DialogBreakpoints.TabletSmall).matches&&this._getDisplayMode()===E.OrderEditorDisplayMode.Popup}_createSimpleDialog(e){var t;this._orderType$.next(null),this.setStatus(E.OrderPanelStatus.Wait),this.headerModel=new se({displaySymbolName:this.displaySymbolName,symbol:this.symbol,brokerName:e?e.metainfo().title:"",mode$:this._displayMode$,status$:this._status$,parentType:1,isExistingOrder:!1,isTradable:!1,quotes$:this._quotes$,data:void 0,formatter:void 0,isBats:this._isBats,informerMessage$:this._informerMessage$,isOrderPresetsEnabled:this._isOrderPresetsEnabled,headerState:this._headerState,brokerId:null===(t=this._adapter)||void 0===t?void 0:t.metainfo().id}),this.headerModel.closeButtonClicked().subscribe(this,this._closeWidget)}_createModels(e){var t,i,s,o,n,a;const{order:l,info:u,spreadFormatter:d,isTradable:h,symbolSpecificTradingOptions:c,forceAbsolutePriceUpdate:p,orderDialogOptions:_}=e,y=this.supportCryptoExchangeOrderTicket();this.sideModel=new be({initialSide:this._initialInputState.side,quotes$:this._quotes$,priceFormatter:this.formatter,spreadFormatter:d,baseCurrency:y&&"crypto"===u.type&&u.baseCurrency||null}),this._pipValue$=(0,M.combineLatest)([this._pipValues$,this.sideModel.value$]).pipe((0,
P.map)((([e,t])=>1===t?e.buyPipValue:e.sellPipValue)));const{orderRules:b=[],title:g}=this._adapter.metainfo();let v=[],k=[];this.supportStopOrdersInBothDirections&&this.supportStopLimitOrdersInBothDirections||(v=null!==(t=(0,R.extractLimitValidationRules)(this._adapter,this.symbol))&&void 0!==t?t:[],k=null!==(i=(0,R.extractStopValidationRules)(this._adapter,this.symbol))&&void 0!==i?i:[]),this.stopPriceModel=new Se({priceType:2,quotes$:this._quotes$,side$:this.sideModel.value$,info:u,status$:this._status$,formatter:this.formatter,orderType$:this.orderType$,settings$:this._settings$,brokerTitle:g,orderWidgetStat:this._orderWidgetStat,initialPrice:this._orderTemplate.stopPrice,orderRules:[...b,...k],forceAbsolutePriceUpdate:p,supportStopOrdersInBothDirections:this.supportStopOrdersInBothDirections,supportStopLimitOrdersInBothDirections:this.supportStopLimitOrdersInBothDirections,getSettings:this._getSettings}),this.limitPriceModel=new Se({priceType:1,quotes$:this._quotes$,side$:this.sideModel.value$,info:u,status$:this._status$,formatter:this.formatter,orderType$:this.orderType$,settings$:this._settings$,brokerTitle:g,orderWidgetStat:this._orderWidgetStat,getSettings:this._getSettings,initialPrice:this._orderTemplate.limitPrice,orderRules:[...b,...v],forceAbsolutePriceUpdate:p,stopPriceControlData$:this.stopPriceModel.priceControlData$,supportStrictCheckingLimitOrderPrice:this.supportStrictCheckingLimitOrderPrice}),this.priceGroupModel=new Me({stopPriceModel:this.stopPriceModel,limitPriceModel:this.limitPriceModel,orderType$:this.orderType$,side$:this.sideModel.value$,quotes$:this._quotes$}),this.quantityModel=y?new Ne({info:u,price$:this.priceGroupModel.price$,baseCurrencyCryptoBalance$:this._baseCurrencyCryptoBalance$,quoteCurrencyCryptoBalance$:this._quoteCurrencyCryptoBalance$,initialQty:this._initialInputState.quantity,side$:this.sideModel.value$,sideGetter:this.sideModel.getValue,orderWidgetStat:this._orderWidgetStat,isExistingOrder:this.existingOrder,orderQty:l.qty,orderPrice:1===l.type?l.limitPrice:l.stopPrice}):new xe({stopLossAvailable$:this._stopLossAvailable$,stopLossPips$:this._stopLossPips$,equity$:this._equity$,pipValue$:this._pipValue$,info:u,currency:null!==(s=this.currency)&&void 0!==s?s:"",initialQty:this._initialInputState.quantity,initialOrderSizeCalculatorValue:this._initialInputState.orderSizeCalculatorValue,initialOrderSizeCalculatorQuantityType:this._initialInputState.orderSizeCalculatorQuantityType,initialLastRiskQuantityType:this._initialInputState.lastRiskQuantityType,initialLastUsedQuantityType:this._initialInputState.lastUsedQuantityType,stopLossAvailableGetter:()=>this._stopLossAvailable$.getValue(),settings$:this._settings$,orderWidgetStat:this._orderWidgetStat,showRiskControlsAndInfo:this.showRiskControlsAndInfo});const m=this.supportBrackets();(m||this.supportCryptoBrackets)&&this._createBracketsModels(l,u,(0,r.ensureDefined)(this.currency)),this.headerModel=new se({displaySymbolName:this.displaySymbolName,symbol:this.symbol,brokerName:this._adapter.metainfo().title,
mode$:this._displayMode$,status$:this._status$,parentType:1,isExistingOrder:this.existingOrder,isTradable:h,quotes$:this._quotes$,data:l,formatter:this.formatter,isBats:this._isBats,informerMessage$:this._informerMessage$,headerState:this._headerState,isOrderPresetsEnabled:this._isOrderPresetsEnabled,brokerId:null===(o=this._adapter)||void 0===o?void 0:o.metainfo().id}),this.customFieldsModel=new W.CustomFieldsViewModel({existingOrder:this.existingOrder,initialInputState:null!==(n=this._initialInputState.customFields)&&void 0!==n?n:void 0,customFields:null==_?void 0:_.customFields,orderType$:this.orderType$}),this.supportLeverage&&(this.leverageModel=new Ke({adapterLeverageInfo:this._adapter.leverageInfo,adapterSetLeverage:this._adapter.setLeverage,adapterPreviewLeverage:this._adapter.previewLeverage,brokerName:this._adapter.metainfo().title,symbol:this.symbol,displaySymbol:this.displaySymbolName,orderType$:this.orderType$,side$:this.sideModel.value$,initialSide:this.sideModel.getValue(),customFieldsInputValues$:this.customFieldsModel.customFieldsInputValues$,blocked$:this.customFieldsModel.isCustomFieldsNotSelected$,isBlockedGetter:()=>this.customFieldsModel.getIsCustomFieldsNotSelected(),onBlockedClick:()=>this.customFieldsModel.setIsEmptyRequiredCustomFieldsHighlighted(!0),getOrderType:this.getOrderType})),y||(this.orderInfoModel=new nt({marginAvailable$:this._marginAvailable$,qty$:this.quantityModel.value$,currency:(0,r.ensureDefined)(this._currencyName),pipValue$:this._pipValue$,price$:this.priceGroupModel.price$,side$:this.sideModel.value$,showTotalInsteadOfTradeValue:(0,j.shouldShowTotal)(_),showRiskControlsAndInfo:this.showRiskControlsAndInfo,info:u,tpInfo:m&&this.takeProfitModel?{enabled:this.takeProfitModel.enabled$,riskInCurrency:this.takeProfitModel.riskInCurrency.value$,riskInPercent:this.takeProfitModel.riskInPercent.value$}:null,slInfo:m&&this.stopLossModel?{enabled:this.stopLossModel.enabled$,riskInCurrency:this.stopLossModel.riskInCurrency.value$,riskInPercent:this.stopLossModel.riskInPercent.value$}:null,supportMargin:this._adapter.metainfo().configFlags.supportMargin||!1,pipValueType$:this._pipValueType$,leverageInfo$:null===(a=this.leverageModel)||void 0===a?void 0:a.leverageInfo$})),this.durationModel=new je({initialDuration:this._initialInputState.duration,orderType$:this.orderType$,orderWidgetStat:this._orderWidgetStat,orderDurations:this._adapter.metainfo().durations,symbolDurations:null==c?void 0:c.allowedDurations,getOrderType:this.getOrderType});const f={orderType:this.orderType$,side:this.sideModel.value$,quantity:this.quantityModel.value$,symbol:this.displaySymbolName,stopPrice:this.stopPriceModel.value$,limitPrice:this.limitPriceModel.value$,formatter:this.formatter,quantityFormatter:this.quantityModel.formatter,orderPlacingStatus:this._orderPlacingStatus.asObservable(),status:this._status$,existingOrder:this.existingOrder,displayMode:this._getDisplayMode()};this.buttonModel=new st(L.TradingEntityType.Order,f)}_getUnitsTitle(){
return this._symbolInfo.units?this._symbolInfo.units:this.symbolHasLotSize?b.t(null,void 0,i(833526)):"stock"===this._symbolInfo.type?b.t(null,void 0,i(288368)):b.t(null,void 0,i(715432))}_getAvailableQuantityTypeInfos(){}_createQuantityConverterController(){}_createQuantityConverters(e){return{}}_resetBracketsFocus(){var e,t;null===(e=this.takeProfitModel)||void 0===e||e.setFocusedControl(0),null===(t=this.stopLossModel)||void 0===t||t.setFocusedControl(0)}_createBracketsModels(e,t,i){const s={[L.BracketType.TakeProfit]:(0,R.extractTakeProfitValidationRules)(this._adapter,this.symbol),[L.BracketType.StopLoss]:(0,R.extractStopLossValidationRules)(this._adapter,this.symbol),[L.BracketType.GuaranteedStop]:(0,R.extractGuaranteedStopValidationRules)(this._adapter,this.symbol),[L.BracketType.TrailingStop]:(0,R.extractStopLossValidationRules)(this._adapter,this.symbol)},r=this.supportModifyBrackets(),o=this.supportModifyTrailingStop(),n=this.supportAddBracketsToExistingOrder();this.takeProfitModel=new ie({initialPrice:e.takeProfit||null,initialEnabled:Boolean(e.takeProfit),initialBracketType:L.BracketType.TakeProfit,formatter:this.formatter,equity$:this._equity$,quotes$:this._quotes$,info:t,pipValue$:this._pipValue$,side$:this.sideModel.value$,amount$:this.quantityModel.value$,parentPrice$:this.priceGroupModel.price$,orderType$:this.orderType$,currency:i,parentType:1,savedPips:this._currentInputState.takeProfitPips,settings$:this._settings$,orderWidgetStat:this._orderWidgetStat,showRiskControlsAndInfo:this.showRiskControlsAndInfo,status:this.getStatus(),supportTrailingStop:this.supportTrailingStop(),supportGuaranteedStop:this.supportGuaranteedStop(),supportCryptoBrackets:this.supportCryptoBrackets,validationRulesByType:s,supportModifyBrackets:r,supportModifyTrailingStop:o,supportAddBracketsToExistingOrder:n});const{makeInitialPrice:a,makeInitialEnabled:l,makeInitialBracketType:u}=ee,d=e.stopLoss,h=e.trailingStopPips,c=e.guaranteedStop,p=Boolean(h),_=u({stopLoss:d,trailingStopPips:h,guaranteedStop:c,stopType:e.stopType});this.stopLossModel=new ie({initialPrice:a({stopLoss:d,trailingStopPips:h,guaranteedStop:c}),initialEnabled:l({stopLoss:d,trailingStopPips:h,guaranteedStop:c}),initialBracketType:_,formatter:this.formatter,equity$:this._equity$,quotes$:this._quotes$,info:t,pipValue$:this._pipValue$,side$:this.sideModel.value$,amount$:this.quantityModel.value$,parentPrice$:this.priceGroupModel.price$,orderType$:this.orderType$,currency:i,parentType:1,savedPips:(p?e.trailingStopPips:this._currentInputState.stopLossPips)||null,settings$:this._settings$,orderWidgetStat:this._orderWidgetStat,showRiskControlsAndInfo:this.showRiskControlsAndInfo,status:this.getStatus(),supportCryptoBrackets:this.supportCryptoBrackets,hasTrailingStopBracket:e.hasTrailingStopBracket,supportTrailingStop:this._supportTrailingStop,supportGuaranteedStop:this._supportGuaranteedStop,validationRulesByType:s,supportModifyBrackets:r,supportModifyTrailingStop:o,supportAddBracketsToExistingOrder:n})}_makeHeaderSettings(){return _t({
pin:()=>this.headerModel.pin(),toggleSettings:this._toggleSettings,mode$:this._displayMode$,settings$:this._settings$,currency:this.currency,showRelativePriceControl:!this.limitPriceModel.isRelativePriceControlHidden&&!this.stopPriceModel.isRelativePriceControlHidden,showRiskControlsAndInfo:this.showRiskControlsAndInfo,showQuantityInsteadOfAmount:this.showQuantityInsteadOfAmount,supportBrackets:this.supportBrackets(),supportPlaceOrderPreview:this.supportPlaceOrderPreview,supportModifyOrderPreview:this.supportModifyOrderPreview,isUndockAllowed:this._isUndockAllowed})}_subscribe(){var e,t,i,s,r,o,n,a,l,u,d,h,p,_,y,b;this._getDisplayMode()===E.OrderEditorDisplayMode.Popup&&this.getStatus()!==E.OrderPanelStatus.Preview&&this.activateOrderTicket();const g=this.status$.subscribe(this._handleStatusChange);this.onInputStateChanged().subscribe(this,this._mergeInputStateDiff),this.headerModel.pinButtonClicked().subscribe(this,this._toggleMode),this.headerModel.closeButtonClicked().subscribe(this,this._closeWidget),this.headerModel.backButtonClicked().subscribe(this,this._back);const v=(0,M.combineLatest)({orderType:this.orderType$,status:this.status$,side:this.sideModel.value$,loading:this._loading$,quotes:this._quotes$,limitPrice:this.limitPriceModel.value$,hasLimitPriceError:(0,w.of)(!1),stopPrice:this.stopPriceModel.value$,hasStopPriceError:(0,w.of)(!1),hasStopLossError:(0,w.of)(!1),hasTakeProfitError:(0,w.of)(!1),quantity:this.quantityModel.value$,hasQuantityError:(0,w.of)(!1),orderSizeCalculatorQuantityType:this.quantityModel instanceof xe?this.quantityModel.orderSizeCalculatorQuantityType$:(0,w.of)(null),lastRiskQuantityType:this.quantityModel instanceof xe?this.quantityModel.lastRiskQuantityType$:(0,w.of)(null),lastUsedQuantityType:this.quantityModel instanceof xe?this.quantityModel.lastUsedQuantityType$:(0,w.of)(null),orderSizeCalculatorValue:this.quantityModel instanceof xe?this.quantityModel.orderSizeCalculator.value$:(0,w.of)(null),takeProfitPips:null!==(t=null===(e=this.takeProfitModel)||void 0===e?void 0:e.value$)&&void 0!==t?t:(0,w.of)(null),takeProfitPrice:null!==(s=null===(i=this.takeProfitModel)||void 0===i?void 0:i.price.value$)&&void 0!==s?s:(0,w.of)(null),stopLossPips:null!==(o=null===(r=this.stopLossModel)||void 0===r?void 0:r.value$)&&void 0!==o?o:(0,w.of)(null),stopLossPrice:null!==(a=null===(n=this.stopLossModel)||void 0===n?void 0:n.price.value$)&&void 0!==a?a:(0,w.of)(null),takeProfitEnabled:null!==(u=null===(l=this.takeProfitModel)||void 0===l?void 0:l.enabled$)&&void 0!==u?u:(0,w.of)(!1),stopLossEnabled:null!==(h=null===(d=this.stopLossModel)||void 0===d?void 0:d.enabled$)&&void 0!==h?h:(0,w.of)(!1),duration:this.durationModel.$value,customFields:this.customFieldsModel.customFieldsInputValues$,hasDurationError:this.durationModel.hasError$,bracketType:null!==(_=null===(p=this.stopLossModel)||void 0===p?void 0:p.bracketType$)&&void 0!==_?_:(0,w.of)(null)}).subscribe((e=>{
const{orderType:t,status:i,side:s,loading:r,quotes:o,limitPrice:n,hasLimitPriceError:a,stopPrice:l,hasStopPriceError:u,hasStopLossError:d,hasTakeProfitError:h,quantity:c,hasQuantityError:p,orderSizeCalculatorQuantityType:_,orderSizeCalculatorValue:y,lastRiskQuantityType:b,lastUsedQuantityType:g,takeProfitPips:v,takeProfitPrice:P,stopLossPips:k,stopLossPrice:m,takeProfitEnabled:f,stopLossEnabled:S,duration:C,customFields:$,hasDurationError:T,bracketType:M}=e;this._setDisabledIfNeeded({status:i,loading:r,quotes:o,side:s,limitPrice:n,stopPrice:l,quantity:c,hasQuantityError:p,hasStopLossError:d,hasTakeProfitError:h,isTakeProfitIncorrect:f&&null===v,isStopLossIncorrect:S&&null===k,customFields:$,hasDurationError:T,hasLimitPriceError:a,hasStopPriceError:u}),this._compareInputStates({orderType:t,side:s,limitPrice:n,stopPrice:l,quantity:c,orderSizeCalculatorQuantityType:_,lastRiskQuantityType:b,lastUsedQuantityType:g,takeProfitPips:v,takeProfitPrice:P,stopLossPips:k,stopLossPrice:m,duration:C,customFields:$,bracketType:M,orderSizeCalculatorValue:y})}));this._waitQuotesTimeout=setTimeout((()=>this._isNoQuotes$.next(!0)),5e3);const P=(0,M.combineLatest)([this._quotes$,this.sideModel.value$]).subscribe((([e,t])=>{const i=1===t?(0,q.getAsk)(e):(0,q.getBid)(e);this._initialInputState.limitPrice=i,this._initialInputState.stopPrice=i})),k=this._quotes$.subscribe((e=>{this._isNoQuotes$.next((0,q.isNoQuotes)(e)),clearTimeout(this._waitQuotesTimeout)}));if(this._subscriptions=[...this.sideModel.subscribe(),this._qtySuggester.suggestedQtyChanged(this.symbol).pipe((0,c.skip)(1)).subscribe(this._onSuggestedQtyChange),this.quantityModel.value$.subscribe(this._onQtyChange)],this.customFieldsModel.subscribe(),null===(y=this.leverageModel)||void 0===y||y.subscribe(),this.limitPriceModel.subscribe(),this.stopPriceModel.subscribe(),this.priceGroupModel.subscribe(),this.quantityModel.subscribe(),null===(b=this.orderInfoModel)||void 0===b||b.subscribe(),this.buttonModel&&this.buttonModel.subscribe(),void 0!==this.takeProfitModel&&this._subscriptions.push(...this.takeProfitModel.subscribe()),void 0!==this.stopLossModel){if(!this.supportCryptoExchangeOrderTicket()){const e=(0,M.combineLatest)({value:this.stopLossModel.value$,enabled:this.stopLossModel.enabled$}).subscribe((({value:e,enabled:t})=>{this._stopLossAvailable$.next(t),t&&this._stopLossPips$.next(e)})),t=this.stopLossModel.focusedControl$.pipe(B(this.quantityModel.focusedControl$,this.quantityModel instanceof xe?this.quantityModel.orderSizeCalculatorQuantityType$:(0,w.of)(null),this.quantityConverterController?this.quantityConverterController.convertedValues$:(0,w.of)(null))).subscribe((([e,t,i,s])=>{this._shouldChangeControlFocus(e,t,i)&&this.quantityModel.setFocusedControl(0)})),i=(0,M.combineLatest)({quantityControl:this.quantityModel.focusedControl$,orderSizeCalculatorQuantityType:this.quantityModel instanceof xe?this.quantityModel.orderSizeCalculatorQuantityType$:(0,w.of)(null)}).pipe(B(this.stopLossModel.focusedControl$)).subscribe((([e,t])=>{var i
;const{quantityControl:s,orderSizeCalculatorQuantityType:r}=e;this._shouldChangeControlFocus(t,s,r)&&(null===(i=this.stopLossModel)||void 0===i||i.setFocusedControl(0))}));this._subscriptions.push(e,t,i)}this._subscriptions.push(...this.stopLossModel.subscribe())}if(void 0!==this.takeProfitModel&&void 0!==this.stopLossModel){const e=(0,M.combineLatest)([this.takeProfitModel.value$,this.stopLossModel.value$]).subscribe((([e,t])=>{this._rewardRisk$.next((0,j.formatRiskReward)(e,t))}));this._subscriptions.push(e)}this._subscriptions.push(g,v,P,k,this._pipValues$.connect()),null!==this._marginAvailable$&&this._subscriptions.push(this._marginAvailable$.connect()),null!==this._baseCurrencyCryptoBalance$&&this._subscriptions.push(this._baseCurrencyCryptoBalance$.connect()),null!==this._quoteCurrencyCryptoBalance$&&this._subscriptions.push(this._quoteCurrencyCryptoBalance$.connect()),this._adapter.orderUpdate.subscribe(this,this._orderUpdate)}_orderUpdate(e){this._isVisible()&&!this._loading$.getValue()&&this.existingOrder&&e.id===this._orderTemplate.id&&6!==e.status&&(this._getDisplayMode()===E.OrderEditorDisplayMode.Popup?this.headerModel.close():this._back())}async _doneHandler(e,t){await this._getAndSendStatistics(e),null!==this._orderWidgetStat&&this._orderWidgetStat.clear();const i=this._sendHandler;if(this._isHandlerPlacedOrder(i)){const s=Object.assign({},this._existingPlacedOrder,e);return[2,1].includes(s.type)&&delete s.stopPrice,[2,3].includes(s.type)&&delete s.limitPrice,i(s,t)}return i(e,t)}_isHandlerPlacedOrder(e){return this.existingOrder}async _getAndSendStatistics(e){var t,i;const s=this._isBracketStopTypeEnabled(L.BracketType.StopLoss),o=this.takeProfitModel&&this.takeProfitModel.getEnabled(),n=this._supportTrailingStop&&this._isBracketStopTypeEnabled(L.BracketType.TrailingStop),a=this._supportGuaranteedStop&&this._isBracketStopTypeEnabled(L.BracketType.GuaranteedStop),l=1===e.side?"Buy":"Sell",u=["Price","Pips"],d=["Units","RiskInCurrency","RiskInPercent","BaseCurrencyQuantity","QuoteCurrencyQuantity","OrderSizeCalculator"],h=this.quantityModel.getFocusedControl(),c=["Pips","Price","RiskInCurrency","RiskInPercent"],p=["Limit","Market","Stop","StopLimit"][e.type-1],_=this.durationModel.getValue(),y=this.leverageModel?this.leverageModel.leverageInfo():null,b=4===e.type,g=3===e.type||b,v=1===e.type||b,P=Object.assign({},this._getSettings()),k=this.limitPriceModel&&!this.limitPriceModel.isRelativePriceControlHidden||this.stopPriceModel&&!this.stopPriceModel.isRelativePriceControlHidden,m=Boolean(this.supportBrackets);function f(e,t){return t[null!==e?e:0]}P.showRelativePriceControl=P.showRelativePriceControl&&k,P.showCurrencyRiskInQty=P.showCurrencyRiskInQty&&m,P.showPercentRiskInQty=P.showPercentRiskInQty&&m,P.showBracketsInCurrency=P.showBracketsInCurrency&&m,P.showBracketsInPercent=P.showBracketsInPercent&&m,P.showOrderPreview=P.showOrderPreview&&Boolean(this.supportPlaceOrderPreview||this.supportModifyOrderPreview),null!==this._orderWidgetStat&&(this._orderWidgetStat.setStaticSnowplowEventDataProperty({
userId:window.user.id,accountType:this._adapter.currentAccountType(),brokerId:this._adapter.metainfo().id,orderTicketMode:this._getDisplayMode(),source:null!==(t=this._orderTemplate.source)&&void 0!==t?t:null,side:l,orderType:p,leverageInfo:y,symbolType:void 0!==this._symbolInfo.type?this._symbolInfo.type:null,operation:this.existingOrder?"Modify":"Place",stopLoss:s?(0,r.ensureDefined)(this.stopLossModel).getValue():null,takeProfit:o?(0,r.ensureDefined)(this.takeProfitModel).getValue():null,trailingStop:n?(0,r.ensureDefined)(this.stopLossModel).getValue():null,guaranteedStop:a?(0,r.ensureDefined)(this.stopLossModel).getValue():null,focusedTPField:o?f((0,r.ensureDefined)(this.takeProfitModel).getFocusedControl(),c):null,focusedSLField:s?f((0,r.ensureDefined)(this.stopLossModel).getFocusedControl(),c):null,focusedQtyField:null!==(i=d[null!==h?h:0])&&void 0!==i?i:null,focusedLimitPriceField:v||b&&this.limitPriceModel?f(this.limitPriceModel.getFocusedControl(),u):null,focusedStopPriceField:g&&this.stopPriceModel?u[this.stopPriceModel.getFocusedControl()]:null,duration:null!==_?_.type:null,isDefaultDuration:null!==_?_.type===this._getDefaultDuration().value:null,showBracketsInCurrency:P.showBracketsInCurrency,showBracketsInPercent:P.showBracketsInPercent,showCurrencyRiskInQty:P.showCurrencyRiskInQty,showOrderPreview:P.showOrderPreview,showPercentRiskInQty:P.showPercentRiskInQty,showRelativePriceControl:P.showRelativePriceControl}),await this._orderWidgetStat.trackStat())}_isBracketStopTypeEnabled(e){return void 0!==this.stopLossModel&&this.stopLossModel.getEnabled()&&this.stopLossModel.getBracketType()===e}_getInitialInputState(e,t,i,s){var r,o,n,a,l,u,d,h,c,p;const _=void 0!==e.customFields?{...e.customFields}:void 0;return{symbol:this.symbol,orderType:this._orderType$.value,side:null!==(o=null!==(r=e.side)&&void 0!==r?r:null==i?void 0:i.side)&&void 0!==o?o:1,limitPrice:e.limitPrice||e.price||e.stopPrice||null,stopPrice:e.stopPrice||e.price||e.limitPrice||null,quantity:e.qty||this._suggestedQty||(null==i?void 0:i.quantity)||t.qty.min,orderSizeCalculatorQuantityType:null!==(n=null==i?void 0:i.orderSizeCalculatorQuantityType)&&void 0!==n?n:null,lastRiskQuantityType:null!==(a=null==i?void 0:i.lastRiskQuantityType)&&void 0!==a?a:"riskInPercent",lastUsedQuantityType:null!==(l=null==i?void 0:i.lastUsedQuantityType)&&void 0!==l?l:"units",orderSizeCalculatorValue:null!==(u=null==i?void 0:i.orderSizeCalculatorValue)&&void 0!==u?u:null,takeProfitPips:null!==(d=null==i?void 0:i.takeProfitPips)&&void 0!==d?d:E.BracketDefaultPips.TakeProfit,takeProfitPrice:null,stopLossPips:null!==(h=null==i?void 0:i.stopLossPips)&&void 0!==h?h:E.BracketDefaultPips.StopLoss,stopLossPrice:null,customFields:null!==(c=null!=_?_:null==i?void 0:i.customFields)&&void 0!==c?c:{},bracketType:null,duration:(0,q.getOrderDuration)({orderDuration:e.duration,orderType:this._orderType$.value,savedDuration:null!==(p=null==i?void 0:i.duration)&&void 0!==p?p:null,orderDurations:this._adapter.metainfo().durations,symbolDurations:null==s?void 0:s.allowedDurations})}}
_compareInputStates(e){const{orderType:t,side:i,limitPrice:s,stopPrice:r,quantity:o,orderSizeCalculatorQuantityType:n,lastRiskQuantityType:a,lastUsedQuantityType:l,orderSizeCalculatorValue:u,takeProfitPips:d,takeProfitPrice:h,stopLossPips:c,stopLossPrice:p,duration:_,customFields:y,bracketType:b}=e,g={};let v=null===s;if(null!==s){const e=this.formatter.format(s),i=null!==this._currentInputState.limitPrice?this.formatter.format(this._currentInputState.limitPrice):null;v=3!==t&&e!==i}t!==this._currentInputState.orderType&&(g.orderType=t),v&&(g.limitPrice=s);let P=null!==r;if(null!==r){const e=this.formatter.format(r),i=null!==this._currentInputState.stopPrice?this.formatter.format(this._currentInputState.stopPrice):null;P=(3===t||4===t)&&e!==i}P&&(g.stopPrice=r),null!==o&&this._currentInputState.quantity!==o&&(g.quantity=o),this._currentInputState.orderSizeCalculatorQuantityType!==n&&(g.orderSizeCalculatorQuantityType=n),this._currentInputState.lastRiskQuantityType!==a&&(g.lastRiskQuantityType=a),this._currentInputState.lastUsedQuantityType!==l&&(g.lastUsedQuantityType=l),this._currentInputState.orderSizeCalculatorValue!==u&&(g.orderSizeCalculatorValue=u),this._currentInputState.takeProfitPips!==d&&(g.takeProfitPips=d),this._currentInputState.takeProfitPrice!==h&&(g.takeProfitPrice=h),this._currentInputState.stopLossPips!==c&&(g.stopLossPips=c),this._currentInputState.stopLossPrice!==p&&(g.stopLossPrice=p),null===_||null===this._currentInputState.duration||this._currentInputState.duration.type===_.type&&this._currentInputState.duration.datetime===_.datetime||(g.duration=_),null!==i&&this._currentInputState.side!==i&&(g.side=i),null!==t&&this._currentInputState.orderType!==t&&(g.orderType=t),this._currentInputState.symbol!==this.symbol&&(g.symbol=this.symbol),0===Object.keys(y).length||(0,z.deepEquals)(this._currentInputState.customFields,y)[0]||(g.customFields=y),b!==this._currentInputState.bracketType&&(g.bracketType=b),0!==Object.keys(g).length&&this._onInputStateChanged.fire(g)}_getCurrentInputState(){var e,t;return{symbol:this.symbol,orderType:this._orderType$.value,side:this.sideModel.getValue(),limitPrice:this.limitPriceModel.getValue(),stopPrice:this.stopPriceModel.getValue(),quantity:this.quantityModel.getValue(),orderSizeCalculatorQuantityType:this.quantityModel instanceof xe?this.quantityModel.getOrderSizeCalculatorQuantityType():null,orderSizeCalculatorValue:this.quantityModel instanceof xe?this.quantityModel.orderSizeCalculator.getValue():null,lastRiskQuantityType:this.quantityModel instanceof xe?this.quantityModel.getLastRiskQuantityType():null,lastUsedQuantityType:this.quantityModel instanceof xe?this.quantityModel.getLastUsedQuantityType():null,takeProfitPips:this.takeProfitModel?this.takeProfitModel.pips.getValue():null,takeProfitPrice:this.takeProfitModel?this.takeProfitModel.price.getValue():null,stopLossPips:this.stopLossModel?this.stopLossModel.pips.getValue():null,stopLossPrice:this.stopLossModel?this.stopLossModel.price.getValue():null,duration:this.durationModel.getValue(),
customFields:this.customFieldsModel.getCustomFieldsInputValues(),bracketType:null!==(t=null===(e=this.stopLossModel)||void 0===e?void 0:e.getBracketType())&&void 0!==t?t:null}}_setDisabledIfNeeded({status:e,loading:t,quotes:i,side:s,limitPrice:r,stopPrice:o,quantity:n,isTakeProfitIncorrect:a,isStopLossIncorrect:l,customFields:u,hasDurationError:d,hasLimitPriceError:h,hasStopPriceError:c,hasQuantityError:p,hasStopLossError:_,hasTakeProfitError:y}){this._isButtonDisabled$.next(this._getDisplayMode()===E.OrderEditorDisplayMode.Panel&&e===E.OrderPanelStatus.Wait||t||(0,q.isNoQuotes)(i)||null===s||(0,j.checkPriceByOrderType)(this._orderType$.value,r,o)||null===n||_||y||a||l||d||h||c||p||Object.values(u).some((e=>void 0===e))||this.customFieldsModel.getCustomFieldsModels().some((e=>!e.isValid())))}_closeWidget(){this._cleanUp(),this._onCloseButtonClicked.fire()}_cancel(){this._cleanUp(),this.deactivateOrderTicket(),this._currentInputState=Object.assign({},this._initialInputState),this.limitPriceModel&&this.limitPriceModel.resetPrice(),this.stopPriceModel&&this.stopPriceModel.resetPrice(),this.takeProfitModel&&this.takeProfitModel.setEnabled(!1),this.stopLossModel&&this.stopLossModel.setEnabled(!1),this._orderPlacingStatus.next(E.OrderPlacingStatus.Creating),this.existingOrder&&this._back()}_cleanUp(){this.orderPreviewModel=null,this.onDoneButtonClicked.resolve(!1)}_getDefaultDuration(){const e=(0,r.ensureDefined)(this._adapter.metainfo().durations);return e.find((e=>Boolean(e.default)))||e[0]}async _prepareTradableSolution(e){this.tradableSolution=await(0,j.prepareTradableSolution)(e,this._adapter),this._createSimpleDialog(this._adapter),this.notTradableText=e.reason}_isOrderSizeCalculatorAvailable(){return!1}_calculateSeenPrice(){var e;const t=this.sideModel.currentQuotes();return null!==(e=1===this.sideModel.getValue()?t.ask:t.bid)&&void 0!==e?e:0}_getCurrentQuotes(){const e=this.sideModel.currentQuotes();if(void 0!==e.ask&&void 0!==e.bid)return{ask:e.ask,bid:e.bid}}_shouldChangeControlFocus(e,t,i){return(2===e||3===e)&&(5===t&&null!==i&&("riskInCurrency"===i||"riskInPercent"===i)||1===t||2===t)}_getCurrentSymbolName(){var e,t,i;return null!==(i=null!==(t=null===(e=this._symbolInfo)||void 0===e?void 0:e.brokerSymbol)&&void 0!==t?t:"brokerSymbol"in this._orderTemplate?this._orderTemplate.brokerSymbol:null)&&void 0!==i?i:(0,q.safeSplitSymbol)(this._orderTemplate.symbol)[1]}}class gt{constructor({qty:e,currency:t,positionPrice:i,showTotalInsteadOfTradeValue:s,info:r,pipValueType$:o,tpInfo:a,slInfo:l,showRiskControlsAndInfo:u}){this._infoTableData$=new n.BehaviorSubject({rows:[]}),this._riskFormatter=new A.PriceFormatter({priceScale:100}),this._tpEnabled$=null,this._tpRiskInCurrency$=null,this._tpRiskInPercent$=null,this._slEnabled$=null,this._slRiskInCurrency$=null,this._slRiskInPercent$=null,this.infoTableData$=this._infoTableData$.asObservable(),this._currency=t,this._showTotalInsteadOfTradeValue=s,this._showRiskControlsAndInfo=u,this._type=r.type,this._leverage=r.leverage,this._marginRate=r.marginRate,
this._lotSize=r.lotSize,this._pipValue=(0,j.calculatePipValue)(e,r.pipValue,this._lotSize),this._pipValueType$=o,null===e?this._tradeValue=0:"crypto"===this._type?this._tradeValue=e*i:this._tradeValue=rt(e,i,r.pipValue,r.pipSize,this._lotSize),a&&l&&(this._tpEnabled$=a.enabled,this._tpRiskInCurrency$=a.riskInCurrency,this._tpRiskInPercent$=a.riskInPercent,this._slEnabled$=l.enabled,this._slRiskInCurrency$=l.riskInCurrency,this._slRiskInPercent$=l.riskInPercent)}subscribe(){this._subscription=(0,M.combineLatest)({tpEnabled:null!==this._tpEnabled$?this._tpEnabled$:(0,w.of)(null),tpRiskInCurrency:null!==this._tpRiskInCurrency$?this._tpRiskInCurrency$:(0,w.of)(null),tpRiskInPercent:null!==this._tpRiskInPercent$?this._tpRiskInPercent$:(0,w.of)(null),slEnabled:null!==this._slEnabled$?this._slEnabled$:(0,w.of)(null),slRiskInCurrency:null!==this._slRiskInCurrency$?this._slRiskInCurrency$:(0,w.of)(null),slRiskInPercent:null!==this._slRiskInPercent$?this._slRiskInPercent$:(0,w.of)(null),pipValueType:this._pipValueType$}).subscribe((e=>{const{tpEnabled:t,tpRiskInCurrency:i,tpRiskInPercent:s,slEnabled:r,slRiskInCurrency:o,slRiskInPercent:n,pipValueType:a}=e,l=[];l.push(...this._makeLeverageInfo(),...this._makeLotSizeInfo(),...this._makePipValueInfo(a),...this._makeTradeValueInfo(),...this._makeRewardInfo(t,i,s),...this._makeRiskInfo(r,o,n)),this._infoTableData$.next({rows:l})}))}unsubscribe(){var e;null===(e=this._subscription)||void 0===e||e.unsubscribe()}title(){return b.t(null,void 0,i(798565))}infoTableData(){return this._infoTableData$.asObservable()}getOrderInfoTableRowsCount(){return this._infoTableData$.getValue().rows.length}_getTradeValue(){const e=this._getMarginRate();if(this._showRiskControlsAndInfo&&Number.isFinite(this._tradeValue)&&(this._isSymbolTypeSupportTradeValue()||void 0!==e))return(0,j.formatInfoValue)(this._tradeValue*(null!=e?e:1))}_makeLeverageInfo(){const e=(0,j.displayedLeverage)(this._leverage,this._marginRate);return null===e?[]:[{title:b.t(null,void 0,i(824813)),value:e}]}_makeLotSizeInfo(){return"number"==typeof this._lotSize&&Number.isFinite(this._lotSize)?[{title:b.t(null,void 0,i(574045)),value:String(this._lotSize)}]:[]}_makePipValueInfo(e){return this._showRiskControlsAndInfo&&e!==L.PipValueType.None&&Number.isFinite(this._pipValue)?[{title:e===L.PipValueType.Pips?b.t(null,void 0,i(207074)):b.t(null,void 0,i(414285)),value:`${(0,j.formatInfoValue)(this._pipValue)} ${this._currency}`}]:[]}_makeTradeValueInfo(){const e=this._getTradeValue();if(void 0===e)return[];return[{title:this._showTotalInsteadOfTradeValue?b.t(null,void 0,i(408007)):b.t(null,void 0,i(248410)),value:`${e} ${this._currency}`}]}_getMarginRate(){return void 0!==this._marginRate&&this._marginRate>0?this._marginRate:void 0}_isSymbolTypeSupportTradeValue(){return void 0!==this._type&&["stock","dr","right","bond","warrant","structured"].includes(this._type)}_makeRewardInfo(e,t,s){return this._showRiskControlsAndInfo&&e&&null!==t&&null!==s?[{title:b.t(null,void 0,i(65183)),
value:`${this._riskFormatter.format(s)}% (${this._riskFormatter.format(t)} ${this._currency})`}]:[]}_makeRiskInfo(e,t,s){return this._showRiskControlsAndInfo&&e&&null!==t&&null!==s?[{title:b.t(null,void 0,i(663886)),value:`${this._riskFormatter.format(s)}% (${this._riskFormatter.format(t)} ${this._currency})`}]:[]}}var vt;!function(e){e[e.Position=0]="Position",e[e.IndividualPosition=1]="IndividualPosition"}(vt||(vt={}));class Pt{constructor({adapter:e,position:t,brackets:i,settings$:s,realtimeProvider:r,isUndockAllowed:o,isVisible:a,toggleMode:l,getDisplayMode:u,toggleSettings:d,displayMode$:h,getSettings:c,viewType:p,pipValueType$:_,handler:y,trackEvent:b,orderDialogOptions:v,headerState:f}){this.positionInfoModel=null,this.id=(0,x.randomHashN)(6),this.onDoneButtonClicked=(0,g.createDeferredPromise)(),this.orderType$=new n.BehaviorSubject(null),this._onBackButtonClicked=new Q.Delegate,this._onCloseButtonClicked=new Q.Delegate,this._loading$=new n.BehaviorSubject(!1),this._rewardRisk$=new n.BehaviorSubject(""),this._isButtonDisabled$=new n.BehaviorSubject(!1),this._status$=new n.BehaviorSubject(E.OrderPanelStatus.Active),this._warning$=new n.BehaviorSubject(void 0),this._headerState=f,this.headerStateValue=f,this._headerState.setSettings(void 0),this._position=t,this._adapter=e,this._pipValueType$=_,this.position=t,this.symbol=t.symbol,this.brackets=i,this._handler=y,this._isUndockAllowed=o,this._isVisible=a,this._toggleMode=l,this._getDisplayMode=u,this._displayMode$=h,this._toggleSettings=d,this._getSettings=c,this._settings$=s,this.rewardRisk$=this._rewardRisk$.asObservable(),this.loading$=this._loading$.asObservable(),this.status$=this._status$.asObservable(),this.warning$=this._warning$.asObservable(),this.isButtonDisabled$=this._isButtonDisabled$.asObservable();const S=this._adapter.metainfo().configFlags;this.supportPositions=p===vt.Position&&S.supportPositions,this.supportIndividualPositions=p===vt.IndividualPosition&&S.supportPositionNetting,this.supportOnlyPairPositionBrackets=S.supportOnlyPairPositionBrackets,this.supportCryptoExchangeOrderTicket=S.supportCryptoExchangeOrderTicket,this._adapter.orders().then((e=>{var i;const s=e.filter((e=>2===e.parentType&&e.parentId===t.id)),r=null===(i=s[0])||void 0===i?void 0:i.customFields,o=this._adapter.getPositionDialogOptions();this.customFieldsModel=new W.CustomFieldsViewModel({existingOrder:Boolean(s.length),customFields:null==o?void 0:o.customFields,initialInputState:r,orderType$:(0,w.of)(null)}),this.supportOnlyPairPositionBrackets&&this._updateWarning()})),this._trackEvent=b,this.onReady=Promise.all([e.symbolInfo(t.symbol),e.getSymbolSpecificTradingOptions(t.symbol),lt(e.accountMetainfo(),{id:e.metainfo().id,name:e.metainfo().title}),lt(e.formatter(t.symbol,!1),new A.PriceFormatter)]).then((([s,o,n,a])=>{this.showRiskControlsAndInfo=S.supportRiskControlsAndInfo&&0!==s.pipValue,this.currency=(0,q.getCurrency)(n),this.symbolType=s.type,this.brokerSymbol=(0,q.getSymbolNameOverFullname)(s.brokerSymbol||t.brokerSymbol||this.symbol),
this._supportBrackets=p===vt.IndividualPosition?null==o?void 0:o.supportIndividualPositionBrackets:null==o?void 0:o.supportPositionBrackets,this._supportModifyBrackets=this._supportBrackets&&S.supportModifyBrackets,this._supportTrailingStop=this._supportBrackets&&S.supportTrailingStop,this._supportGuaranteedStop=this._supportBrackets&&S.supportGuaranteedStop,this._supportModifyTrailingStop=this._supportTrailingStop&&this._supportModifyBrackets&&S.supportModifyTrailingStop,this._quotes$=T((0,k.fromEventPattern)((e=>r.subscribeRealtime(t.symbol,e)),(e=>r.unsubscribeRealtime(t.symbol,e)),((e,t)=>t))),this._equity$=T((0,k.fromEventPattern)((t=>e.subscribeEquity(t)),(t=>e.unsubscribeEquity(t)),((e,t)=>t))),this._pipValues$=T((0,k.fromEventPattern)((i=>e.subscribePipValue(t.symbol,i)),(i=>e.unsubscribePipValue(t.symbol,i)),((e,t)=>t)).pipe((0,m.startWith)({buyPipValue:s.pipValue,sellPipValue:s.pipValue}))),this._pipValue$=this._pipValues$.pipe((0,P.map)((e=>1===t.side?e.buyPipValue:e.sellPipValue))),this._createModels(i,s,n,a,v),this._subscribe(),this._headerState.setSettings(_t({pin:()=>this.headerModel.pin(),toggleSettings:this._toggleSettings,mode$:this._displayMode$,settings$:this._settings$,currency:this.currency,showRiskControlsAndInfo:!0,supportBrackets:!0,isUndockAllowed:this._isUndockAllowed}))}))}destroy(){this._subscriptions&&this._subscriptions.forEach((e=>e.unsubscribe())),this.headerModel&&(this.headerModel.unsubscribe(),this.headerModel.pinButtonClicked().unsubscribe(this,this._toggleMode),this.headerModel.backButtonClicked().unsubscribe(this,this._back),this.headerModel.closeButtonClicked().unsubscribe(this,this._closeWidget)),null!==this.positionInfoModel&&this.positionInfoModel.unsubscribe(),this.supportPositions&&this._adapter.positionUpdate.unsubscribe(this,this._positionOrIndividualPositionUpdate),this.supportIndividualPositions&&this._adapter.individualPositionUpdate.unsubscribe(this,this._positionOrIndividualPositionUpdate),this.supportOnlyPairPositionBrackets&&this._adapter.orderUpdate.unsubscribe(this,this._updateWarning)}side(){return this._position.side}doneButtonClick(){this._loading$.next(!0),this._doneHandler().then((e=>{if(e){this.onDoneButtonClicked.resolve(!0);const e=this._getDisplayMode();e===E.OrderEditorDisplayMode.Popup||e===E.OrderEditorDisplayMode.ResizableDrawer?this.headerModel.close():this._back(),this._trackEvent("Position Ticket","Modify Position",this._getDisplayMode()===E.OrderEditorDisplayMode.Panel?"Panel":"Popup")}this._loading$.next(!1)}))}onBackButtonClicked(){return this._onBackButtonClicked}onCloseButtonClicked(){return this._onCloseButtonClicked}supportBrackets(){return Boolean(this._supportBrackets)}supportTrailingStop(){return Boolean(this._supportTrailingStop)}supportGuaranteedStop(){return Boolean(this._supportGuaranteedStop)}supportModifyTrailingStop(){return Boolean(this._supportModifyTrailingStop)}getStatus(){return this._status$.getValue()}isButtonDisabled(){return this._isButtonDisabled$.getValue()}_createModels(e,t,i,s,r){var o,a,l;const u={
[L.BracketType.TakeProfit]:(0,R.extractTakeProfitValidationRules)(this._adapter,this.symbol),[L.BracketType.StopLoss]:(0,R.extractStopLossValidationRules)(this._adapter,this.symbol),[L.BracketType.GuaranteedStop]:(0,R.extractGuaranteedStopValidationRules)(this._adapter,this.symbol),[L.BracketType.TrailingStop]:(0,R.extractStopLossValidationRules)(this._adapter,this.symbol)},d=(0,q.getCurrency)(i)||"$",h=new n.BehaviorSubject(this._position.side||-1);this.headerModel=new se({displaySymbolName:this.brokerSymbol,symbol:this.symbol,brokerName:" ",mode$:this._displayMode$,quotes$:this._quotes$,status$:this._status$,parentType:2,isExistingOrder:!0,isTradable:!0,data:this._position,formatter:this._position.priceFormatter?this._position.priceFormatter:s,headerState:this._headerState,brokerId:null===(o=this._adapter)||void 0===o?void 0:o.metainfo().id});const c=this.supportModifyTrailingStop();this.takeProfitModel=new ie({initialPrice:e.takeProfit||this._position.takeProfit||null,initialEnabled:Boolean(e.takeProfit||this._position.takeProfit),initialBracketType:L.BracketType.TakeProfit,formatter:s,equity$:this._equity$,quotes$:this._quotes$,info:t,pipValue$:this._pipValue$,side$:h,amount$:new n.BehaviorSubject(this._position.qty),parentPrice$:new n.BehaviorSubject(null!==(a=this._position.avgPrice)&&void 0!==a?a:this._position.price),orderType$:this.orderType$,currency:d,parentType:2,savedPips:null,settings$:this._settings$,orderWidgetStat:null,showRiskControlsAndInfo:this.showRiskControlsAndInfo,status:this._status$.getValue(),supportTrailingStop:this.supportTrailingStop(),supportGuaranteedStop:this.supportGuaranteedStop(),supportModifyBrackets:this._supportModifyBrackets,validationRulesByType:u,supportModifyTrailingStop:c});const p=Boolean(this._position.trailingStopPips),_=e.trailingStopPips||this._position.trailingStopPips,y=e.stopLoss||this._position.stopLoss,b=null!==(l=e.guaranteedStop)&&void 0!==l?l:this._position.guaranteedStop,{makeInitialPrice:g,makeInitialEnabled:v,makeInitialBracketType:P}=ee;this.stopLossModel=new ie({initialPrice:g({stopLoss:y,trailingStopPips:_,guaranteedStop:b}),initialEnabled:v({stopLoss:y,trailingStopPips:_,guaranteedStop:b}),initialBracketType:P({stopLoss:y,trailingStopPips:_,guaranteedStop:b}),formatter:s,equity$:this._equity$,quotes$:this._quotes$,info:t,pipValue$:this._pipValue$,side$:h,amount$:new n.BehaviorSubject(this._position.qty),parentPrice$:new n.BehaviorSubject(this._position.avgPrice),orderType$:this.orderType$,currency:d,parentType:2,savedPips:_||null,settings$:this._settings$,orderWidgetStat:null,showRiskControlsAndInfo:this.showRiskControlsAndInfo,status:this._status$.getValue(),supportTrailingStop:this._supportTrailingStop,supportGuaranteedStop:this._supportGuaranteedStop,supportModifyBrackets:this._supportModifyBrackets,validationRulesByType:u,supportModifyTrailingStop:c,hasTrailingStopBracket:p});const k=(0,j.shouldShowTotal)(r),m=this.supportBrackets();this.supportCryptoExchangeOrderTicket||(this.positionInfoModel=new gt({qty:this._position.qty,currency:(0,
q.getCurrency)(i),positionPrice:this._position.avgPrice,showTotalInsteadOfTradeValue:k,info:t,pipValueType$:this._pipValueType$,tpInfo:m&&this.takeProfitModel?{enabled:this.takeProfitModel.enabled$,riskInCurrency:this.takeProfitModel.riskInCurrency.value$,riskInPercent:this.takeProfitModel.riskInPercent.value$}:null,slInfo:m&&this.stopLossModel?{enabled:this.stopLossModel.enabled$,riskInCurrency:this.stopLossModel.riskInCurrency.value$,riskInPercent:this.stopLossModel.riskInPercent.value$}:null,showRiskControlsAndInfo:this.showRiskControlsAndInfo})),this.buttonModel=new st(L.TradingEntityType.Position)}_updateWarning(){this._adapter.orders().then((e=>{const t=e.find((e=>e.symbol===this._position.symbol&&e.side!==this._position.side&&(6===e.status&&void 0===e.parentId||3===e.status)));this._warning$.next(t?b.t(null,void 0,i(913064)):void 0)}))}_subscribe(){if(this.headerModel.pinButtonClicked().subscribe(this,this._toggleMode),this.headerModel.backButtonClicked().subscribe(this,this._back),this.headerModel.closeButtonClicked().subscribe(this,this._closeWidget),this._buttonDataSubscription=(0,M.combineLatest)({loading:this._loading$,quotes:this._quotes$,takeProfit:this.takeProfitModel.value$,stopLoss:this.stopLossModel.value$,takeProfitEnabled:this.takeProfitModel.enabled$,stopLossEnabled:this.stopLossModel.enabled$}).subscribe((e=>{const{loading:t,quotes:i,takeProfit:s,stopLoss:r,takeProfitEnabled:o,stopLossEnabled:n}=e;this._isButtonDisabled$.next(t||(0,q.isNoQuotes)(i)||o&&null===s||n&&null===r)})),this._rewardRiskSubscription=(0,M.combineLatest)([this.takeProfitModel.value$,this.stopLossModel.value$]).subscribe((([e,t])=>{this._rewardRisk$.next((0,j.formatRiskReward)(e,t))})),this.customFieldsModel.subscribe(),this._subscriptions=[...this.takeProfitModel.subscribe(),...this.stopLossModel.subscribe(),this._rewardRiskSubscription,this._buttonDataSubscription,this._equity$.connect(),this._quotes$.connect(),this._pipValues$.connect()],null!==this.positionInfoModel&&this.positionInfoModel.subscribe(),this.supportPositions&&this._adapter.positionUpdate.subscribe(this,this._positionOrIndividualPositionUpdate),this.supportIndividualPositions&&this._adapter.individualPositionUpdate.subscribe(this,this._positionOrIndividualPositionUpdate),this.supportOnlyPairPositionBrackets){this._adapter.orderUpdate.subscribe(this,this._updateWarning);const e=this.stopLossModel.enabled$.pipe(B(this.takeProfitModel.enabled$)).subscribe((e=>{const[t,i]=e;i!==t&&this.takeProfitModel.setEnabled(t)})),t=this.takeProfitModel.enabled$.pipe(B(this.stopLossModel.enabled$)).subscribe((e=>{const[t,i]=e;i!==t&&this.stopLossModel.setEnabled(t)}));this._subscriptions.push(t,e)}}_doneHandler(){const e=null!==this.stopLossModel.getValue()?this.stopLossModel.price.getValue():null,t=this.stopLossModel.getValue(),i=null!==this.takeProfitModel.getValue()?this.takeProfitModel.price.getValue():null,s={};if(null!==t&&null!==e&&(this.stopLossModel.getBracketType()===L.BracketType.StopLoss&&(s.stopLoss=e),
this.stopLossModel.getBracketType()===L.BracketType.TrailingStop&&(s.trailingStopPips=t),this.stopLossModel.getBracketType()===L.BracketType.GuaranteedStop&&(s.guaranteedStop=e)),null!==i&&(s.takeProfit=i),this.customFieldsModel.getCustomFieldsModels().length>0){const e=this.customFieldsModel.getCustomFieldsInputValues();return this._getAndSendStatistics(),this._handler(this.position.id,s,e)}return this._getAndSendStatistics(),this._handler(this.position.id,s)}_getAndSendStatistics(){const e=this.stopLossModel.getEnabled(),t=this.stopLossModel.getFocusedControl(),i=this.takeProfitModel.getEnabled(),s=this.takeProfitModel.getFocusedControl(),r=this.stopLossModel&&this.stopLossModel.getBracketType(),o=["Pips","Price","RiskInCurrency","RiskInPercent"],n=[" Disabled"," Active"],a=["StopLoss","TakeProfit","TrailingStop"],l={SL:{active:n[+e],mode:o[t]},TP:{active:n[+i],mode:o[s]}};this.supportTrailingStop()&&(l.SLType={active:n[+e],mode:a[r]});const u=this._getSettings();Object.keys(u).filter((e=>["showBracketsInCurrency","showBracketsInPercent"].includes(e))).forEach((e=>{this._trackEvent("Order Ticket",e,u[e]?"on":"off")})),Object.keys(l).forEach((e=>{l[e].active&&this._trackEvent("Position Ticket",e,l[e].mode)}))}_positionOrIndividualPositionUpdate(e){!this._isVisible()||this._loading$.getValue()||e.id!==this.position.id||0!==e.qty&&this.position.side===e.side||(this._getDisplayMode()===E.OrderEditorDisplayMode.Popup?this.headerModel.close():this._back())}_closeWidget(){this.onDoneButtonClicked.resolve(!1),this._onCloseButtonClicked.fire()}_back(){this.onDoneButtonClicked.resolve(!1),this._onBackButtonClicked.fire()}}var kt=i(148296);class mt{constructor(e){this._brokerId="",this._settingsAdapter=e}setBrokerId(e){this._brokerId=e}saveSettings(e){this._settingsAdapter.setValue(this._makeKey(kt.settingsKeys.ORDER_PANEL_SETTINGS,this._brokerId),JSON.stringify(e))}getSettings(){const e=this._settingsAdapter.getValue(this._makeKey(kt.settingsKeys.ORDER_PANEL_SETTINGS,this._brokerId));try{return JSON.parse(e)}catch(e){return null}}setWidgetMode(e){this._settingsAdapter.setValue(kt.settingsKeys.ORDER_WIDGET_MODE,e)}widgetMode(){const e=this._settingsAdapter.getValue(kt.settingsKeys.ORDER_WIDGET_MODE);return e||null}_makeKey(e,t,i){return e+t+("string"==typeof i?"."+i:"")}}var ft,St=i(932100),Ct=i(145367),$t=i(895318),Tt=i(403933),Mt=i(804748),wt=i(240534);!function(e){let t=0;const i=new wt.WatchedValue(!1);e.value=i.readonly(),e.wrap=function(e){return async(...s)=>{i.setValue(!0),t++;try{return await e(...s)}finally{t--,i.setValue(0!==t)}}}}(ft||(ft={}));const Vt={[Ct.PlaceOrEditContextType.PlaceOrder]:E.OrderPanelStatus.Active,[Ct.PlaceOrEditContextType.EditOrder]:E.OrderPanelStatus.Editing,[Ct.PlaceOrEditContextType.EditPosition]:E.OrderPanelStatus.Editing,[Ct.PlaceOrEditContextType.EditIndividualPosition]:E.OrderPanelStatus.Editing},It=(0,p.getLogger)("Trading.OrderViewController");function Ot(){
return Promise.all([i.e(3689),i.e(6625),i.e(4392),i.e(8077),i.e(4447),i.e(8065),i.e(4593),i.e(6955),i.e(7530),i.e(1259),i.e(889),i.e(3925),i.e(1020),i.e(2829),i.e(101),i.e(9803),i.e(7199),i.e(3905),i.e(5581),i.e(9222),i.e(182),i.e(1553),i.e(7125),i.e(5260),i.e(3427),i.e(4226),i.e(199),i.e(158),i.e(7502)]).then(i.bind(i,496876))}function Bt(){return Promise.all([i.e(4620),i.e(6625),i.e(4392),i.e(4447),i.e(8065),i.e(4593),i.e(6955),i.e(1020),i.e(101),i.e(3905),i.e(5385),i.e(1553),i.e(7125),i.e(3427),i.e(199),i.e(8751)]).then(i.bind(i,562152))}const Dt="order-ticket";function Lt(e){if(0===e.length)return null;const t=new Set(e.flatMap((e=>e.saveToSettings?e.id:[])));return 0!==t.size?t:null}class Et{constructor(e){this._orderViewModel=null,this._positionViewModel=null,this._dialogVisibility=new Mt.DialogVisibility,this._orderWidgetStat=null,this._stopSubscriptions$=new o.Subject,this._isOrderSizeCalculatorEnabled=!1,this._settings$=new n.BehaviorSubject($t.defaultSettings),this._mode$=new n.BehaviorSubject(E.OrderEditorDisplayMode.Panel),this.openPanel=async()=>{var e;try{this._unsubscribeViewModels(),await this._closeOrderDialog(),await this._closePositionDialog(),this._setDisplayMode(E.OrderEditorDisplayMode.Panel),this._openTradingPanelPage(St.TradingPage.OrderPanel);const t=void 0!==this._tradedContextLinking?null===(e=this._tradedContextLinking.context())||void 0===e?void 0:e.data():void 0;await this._recreateOrderViewModel(null,t),await this._openOrderPanel(this._getDefaultOrderTicketFocus())}catch(e){It.logWarn(`Failed to open panel: ${(0,y.getLoggerMessage)(e)}`),this.closePanel()}},this.closePanel=()=>{null!==this._positionViewModel&&(this._positionViewModel.onDoneButtonClicked.resolve(!1),this._unmountPositionPanel(),this._unsubscribePositionViewModel()),null!==this._orderViewModel&&(this._orderViewModel.existingOrder&&this._orderViewModel.onDoneButtonClicked.resolve(!1),this._unmountOrderPanel(),this._unsubscribeOrderViewModel()),this._closeTradingPanel()},this.getDisplayMode=()=>this._mode$.getValue(),this._onActiveTradingPanelChanged=e=>{e!==St.TradingPage.OrderPanel&&(null!==this._positionViewModel&&(this._unmountPositionPanel(),this._unsubscribePositionViewModel()),null!==this._orderViewModel&&this.getDisplayMode()===E.OrderEditorDisplayMode.Panel&&(this._orderViewModel.existingOrder&&this._orderViewModel.onDoneButtonClicked.resolve(!1),this._unmountOrderPanel(),this._unsubscribeOrderViewModel()))},this._onStatusChanged=async e=>{try{const t=this._state,i=this._makeState();i.symbol===t.symbol&&i.broker===t.broker&&i.accountId===t.accountId&&i.isAuthenticated===t.isAuthenticated||(this._unsubscribeViewModels(),this._state=i,this._setSettings(),await this._closeOrderDialog(),await this._closePositionDialog(),!(null==e?void 0:e.aborted)&&this._isTradingPanelOpened.value()&&this.getDisplayMode()===E.OrderEditorDisplayMode.Panel&&this._tradingPanelActivePage.value()===St.TradingPage.OrderPanel&&(await this._recreateOrderViewModel(e),this._deactivateOrderTicket(),this._openOrderPanel()))}catch(e){
It.logWarn(`Failed to change status: ${(0,y.getLoggerMessage)(e)}`)}},this._recreateOrderViewModel=async(e,t)=>{var i,s,o,n,a;this._unsubscribeViewModels(),this._orderStub=null!=t?t:this._createOrderStub();const{broker:l,symbol:u,side:d}=this._state;let h=null;if(null===l)h=new bt({...this._commonOrderViewModelProps(),adapter:l,isTradable:{tradable:!1},sendHandler:()=>Promise.resolve(!0),previewHandler:async()=>({sections:[]})});else{const a=await(0,Ge.respectAbort)(e,l.isTradable(u));let c=l.placeOrder.bind(l);void 0!==this._tradedContextLinking&&(c=async(e,t)=>{const i=(0,r.ensureDefined)(this._tradedContextLinking,"Recreate order view model: Trade context linking");return(0,r.ensureNotNull)(i.context(),"Recreate order view model: Place order handler trade context").send(t).finally((()=>i.clear()))});const p=this._orderStub.hasOwnProperty("id")?l.modifyOrder.bind(l):c,_=async e=>{var t;const i=null===(t=this._tradedContextLinking)||void 0===t?void 0:t.context();return(null==i?void 0:i.type)===Ct.PlaceOrEditContextType.PlaceOrder?i.preview():l.previewOrder(e)};let y=null;a.tradable&&(y=null!==(n=null!==(o=null!==(i=null==t?void 0:t.type)&&void 0!==i?i:null===(s=this._getTradingSettingsStorage())||void 0===s?void 0:s.orderType(u))&&void 0!==o?o:(0,q.getDefaultOrderType)(l.config))&&void 0!==n?n:null);const b=await(0,Ge.respectAbort)(e,l.getOrderDialogOptions(u)),g=void 0!==(null==b?void 0:b.customFields)?Lt(b.customFields):null;this._setState({orderType:y,savableCustomFields:g});const v=this._makeOrderViewInputState(u,y,d,g);h=new bt({...this._commonOrderViewModelProps(),adapter:l,isTradable:a,sendHandler:p,previewHandler:_,orderViewInputState:v,forceAbsolutePriceUpdate:!0,orderDialogOptions:b})}if(this._orderViewModel=h,this._subscribeOrderViewModel(),await(0,Ge.respectAbort)(e,h.onReady),this._orderViewModel!==h)return this._unsubscribeViewModels(),Promise.reject("OrderViewModel was recreated during the initialization");null===(a=this._placeOrderAbortController)||void 0===a||a.abort(),this._placeOrderAbortController=new AbortController,this._updateTradedContextLinking(this._placeOrderAbortController.signal)},this._updateTradedContextLinking=async e=>{if(!(null===this._state.broker||void 0===this._tradedContextLinking||null===this._orderViewModel||this._orderViewModel.existingOrder||this._orderViewModel.getStatus()===E.OrderPanelStatus.Wait||void 0===this._orderViewModel.side()||null===this._orderViewModel.quantityModel.getValue()||void 0===this._orderViewModel.preOrder().limitPrice&&void 0===this._orderViewModel.preOrder().stopPrice&&2!==this._orderViewModel.preOrder().type))try{if(this._orderViewModel.getStatus()===E.OrderPanelStatus.Wait)return;const t=await(0,Ge.respectAbort)(e,this._state.broker.createPlaceOrderContext({order:this._orderViewModel.preOrder(),source:Dt}));this._tradedContextLinking.setContext(t)}catch(e){(0,Ge.skipAbortError)(e)}},this._updateOrderValues=e=>{if(null===this._orderViewModel)return
;const{duration:t,limitPrice:i,type:s,qty:r,side:o,stopPrice:n,stopLoss:a,takeProfit:l,stopType:u,trailingStopPips:d,guaranteedStop:h}=e;void 0!==i&&this._orderViewModel.limitPriceModel.setPriceValue(i),void 0!==n&&this._orderViewModel.stopPriceModel.setPriceValue(n),this._orderViewModel.sideModel.getValue()!==o&&this._orderViewModel.sideModel.setValue(o),this._orderViewModel.getOrderType()!==s&&this._orderViewModel.setOrderType(s),this._orderViewModel.quantityModel.quantity.getValue()!==r&&this._orderViewModel.quantityModel.quantity.setValue(r),this._orderViewModel.durationModel.currentDuration.setValue(null!=t?t:null),void 0!==this._orderViewModel.stopLossModel&&this._updateStopLossValues({stopLossModel:this._orderViewModel.stopLossModel,stopLoss:a,trailingStopPips:d,guaranteedStop:h,stopType:u}),void 0!==this._orderViewModel.takeProfitModel&&this._updateTakeProfitValues(this._orderViewModel.takeProfitModel,l)},this._onOrderWidgetModeChanged=async e=>{const t=this._getDefaultOrderTicketFocus();e===E.OrderEditorDisplayMode.Panel?(await this._closeOrderDialog(),await this._openOrderPanel(t)):e===E.OrderEditorDisplayMode.Popup?(await this._closeOrderPanel(),this._activateOrderTicket(),await this._showOrderDialog(t)):await this._showOrderDrawer(t),this._saveWidgetMode(e)},this._onOrderWidgetInputStateChanged=e=>{var t,i;this._updateTradedContextLinking(null!==(i=null===(t=this._placeOrderAbortController)||void 0===t?void 0:t.signal)&&void 0!==i?i:null);const{symbol:o,orderType:n}=this._state;if((0,q.isDefined)(e.side)&&this._setState({side:e.side}),!(0,q.isDefined)(n))return;const a=this._getTradingSettingsStorage();if(null===a)return;const l=(0,r.ensureNotNull)(this._orderViewModel,"Order View Model").existingOrder;if((0,q.isDefined)(e.quantity)&&a.setSymbolQty(o,e.quantity),this._isOrderSizeCalculatorEnabled&&!l&&(0,q.isDefined)(e.orderSizeCalculatorQuantityType)&&a.setOrderSizeCalculatorQuantityType(o,e.orderSizeCalculatorQuantityType),this._isOrderSizeCalculatorEnabled&&(0,q.isDefined)(e.lastRiskQuantityType)&&s.setValue(kt.settingsKeys.LAST_RISK_QUANTITY_TYPE,e.lastRiskQuantityType),this._isOrderSizeCalculatorEnabled&&(0,q.isDefined)(e.lastUsedQuantityType)&&a.setLastUsedQuantityType(o,e.lastUsedQuantityType),this._isOrderSizeCalculatorEnabled&&(0,q.isDefined)(e.orderSizeCalculatorValue)&&a.setOrderSizeCalculatorValue(o,e.orderSizeCalculatorValue),(0,q.isDefined)(e.takeProfitPips)&&a.setTakeProfitPips(o,e.takeProfitPips,E.BracketDefaultPips.TakeProfit),(0,q.isDefined)(e.stopLossPips)&&a.setStopLossPips(o,e.stopLossPips,E.BracketDefaultPips.StopLoss),(0,q.isDefined)(e.orderType)&&a.setOrderType(o,e.orderType),(0,q.isDefined)(e.duration)){const t=this._state.broker&&this._state.broker.metainfo().durations,i=t&&(t.find((e=>e.default))||t[0]),s=i&&i.name===e.duration.type?null:e.duration;a.setDuration(this._state.symbol,n,s)}if((0,q.isDefined)(e.customFields)&&null!==this._state.savableCustomFields){const t=function(e,t){const i={...e};if(void 0===t)return i;for(const e of Object.keys(i))t.has(e)||delete i[e];return i
}(e.customFields,this._state.savableCustomFields);a.setCustomFields(o,n,t)}},this._onOrderWidgetCloseButtonClicked=()=>{this.getDisplayMode()===E.OrderEditorDisplayMode.Panel?this.closePanel():(this._closeOrderDialog(),this._unsubscribeViewModels())},this._onOrderWidgetStatusChanged=e=>{var t,i;const s=e===E.OrderPanelStatus.Editing&&null!==(null===(t=this._tradedContextLinking)||void 0===t?void 0:t.context());(e===E.OrderPanelStatus.Wait||s)&&(this._updateTradedContextLinking(null),null===(i=this._tradedContextLinking)||void 0===i||i.setContext(null)),e===E.OrderPanelStatus.Active&&void 0!==this._placeOrderAbortController&&this._updateTradedContextLinking(this._placeOrderAbortController.signal)},this._onOrderWidgetBackButtonClicked=()=>{if(this._orderViewModel&&this._orderViewModel.getStatus()===E.OrderPanelStatus.Preview){this._activateOrderTicket();const e=this._getDefaultOrderTicketFocus();this.getDisplayMode()===E.OrderEditorDisplayMode.Panel?this._openOrderPanel(e):this.getDisplayMode()===E.OrderEditorDisplayMode.Popup?this._showOrderDialog(e):this._showOrderDrawer(e)}else this.showOrderView({order:this._createOrderStub(),isDeactivated:!0})},this._onPositionWidgetModeChanged=async e=>{e===E.OrderEditorDisplayMode.ResizableDrawer?await this._showPositionDrawer():e===E.OrderEditorDisplayMode.Panel?(await this._closePositionDialog(),await this._openPositionPanel()):(await this._closePositionPanel(),this._activateOrderTicket(),await this._showPositionDialog()),this._saveWidgetMode(e)},this._onPositionWidgetBackButtonClicked=()=>{this._unmountPositionPanel(),this._unsubscribePositionViewModel(),this.showOrderView({order:this._createOrderStub(),isDeactivated:!0})},this._onPositionWidgetCloseButtonClicked=()=>{this.getDisplayMode()===E.OrderEditorDisplayMode.Panel?this.closePanel():(this._closePositionDialog(),this._unsubscribeViewModels())},this._isVisible=()=>this.getDisplayMode()===E.OrderEditorDisplayMode.Panel?this._isTradingPanelOpened.value():this._dialogVisibility.getValue().isVisible,this._onOrderTypeChanged=e=>{this._setState({orderType:e})},this._toggleMode=()=>{this._setDisplayMode(this.getDisplayMode()===E.OrderEditorDisplayMode.Panel?E.OrderEditorDisplayMode.Popup:E.OrderEditorDisplayMode.Panel)},this._getSettings=()=>this._settings$.getValue(),this._toggleSettings=e=>{const t=this._getSettings();this._settings$.next({...t,[e]:!t[e]})},this._handleSymbolChange=()=>{this._symbolChangePromise=this._onStatusChanged(null)},this._unsubscribeViewModels=()=>{null!==this._positionViewModel&&(this._positionViewModel.onDoneButtonClicked.resolve(!1),this._unsubscribePositionViewModel()),null!==this._orderViewModel&&(this._orderViewModel.existingOrder&&this._orderViewModel.onDoneButtonClicked.resolve(!1),this._unsubscribeOrderViewModel())};const{tradingCommands:t,tradingPanelCommands:i,qtySuggester:a,tradingLinking:l,orderViewHeaderState:u,tradedContextLinking:d}=e;if(this._orderViewHeaderState=u,this._updateTradedContextLinking=(0,Ge.respectLatest)(this._updateTradedContextLinking),this._tradingCommands=t,
this._trackEvent=t.trackEvent,this._realtimeProvider=t.realtimeProvider,this._orderViewDataStorage=new mt(s),this._tradingPanelContainer=i.container,this._isOpeningTradingPanelAvailable=i.isOpeningAvailable,this._isTradingPanelOpened=i.isOpened,this._qtySuggester=a,this._tradingLinking=l,this._tradingPanelActivePage=i.activePage,this._closeTradingPanel=i.close,this._openTradingPanelPage=i.openPage,this._getTradingSettingsStorage=t.getTradingSettingsStorage,this.dialogVisibility=this._dialogVisibility.value$,window.matchMedia(Tt.TradingLayoutBreakpoint.Mobile).matches)this._setDisplayMode(E.OrderEditorDisplayMode.Popup);else if(_.enabled("order_panel")){const e=this._orderViewDataStorage.widgetMode();this._setDisplayMode(null!=e?e:E.OrderEditorDisplayMode.Panel)}else this._setDisplayMode(E.OrderEditorDisplayMode.Popup);i.isOpeningAvailable.subscribe((e=>{e||this.getDisplayMode()!==E.OrderEditorDisplayMode.Panel||this._setDisplayMode(E.OrderEditorDisplayMode.Popup)})),this._state=this._makeState(),this.stateChanging=ft.value,this._onStatusChanged=(0,Ge.respectLatest)(this._onStatusChanged),this._recreateOrderViewModel=ft.wrap((0,Ge.respectLatest)(this._recreateOrderViewModel)),this.openPanel=ft.wrap(this.openPanel),this._realtimeProvider.onStatusChanged.subscribe(null,(()=>this._onStatusChanged(null))),this._tradingLinking.valueObservable().subscribe(this._handleSymbolChange),window.loginStateChange&&window.loginStateChange.subscribe(this,(()=>this._onStatusChanged(null))),i.activePage.subscribe(this._onActiveTradingPanelChanged),this._tradedContextLinking=d}async showOrderView(e){try{const{order:t,focus:i,forceOrderDialog:s,isDeactivated:o=!1}=e;this._unsubscribeViewModels(),await this._closeOrderDialog(),await this._closePositionDialog(),s&&this._setDisplayMode(E.OrderEditorDisplayMode.Popup);const n=Object.assign(this._createOrderStub(),t);t.symbol!==this._state.symbol&&this._setState({symbol:t.symbol}),await this._recreateOrderViewModel(null,n),o&&this._deactivateOrderTicket();const a=null!=i?i:this._getDefaultOrderTicketFocus();return this.getDisplayMode()===E.OrderEditorDisplayMode.Panel?this._openOrderPanel(a):this.getDisplayMode()===E.OrderEditorDisplayMode.Popup?this._showOrderDialog(a):this._showOrderDrawer(a),await(0,r.ensureNotNull)(this._orderViewModel).onDoneButtonClicked.promise}catch(e){return It.logWarn(`Failed to show order view: ${(0,y.getLoggerMessage)(e)}`),!1}}async showPositionView(e,t,i){try{return await this._symbolChangePromise,await this._createAndShowPositionViewModel({position:e,viewType:vt.Position,brackets:t,focus:i})}catch(e){return It.logWarn(`Failed to show position view: ${(0,y.getLoggerMessage)(e)}`),!1}}async showIndividualPositionView(e,t,i){try{return await this._symbolChangePromise,await this._createAndShowPositionViewModel({position:e,viewType:vt.IndividualPosition,brackets:t,focus:i})}catch(e){return It.logWarn(`Failed to show individual position view: ${(0,y.getLoggerMessage)(e)}`),!1}}orderTicketSettings(){return this._settings$.value}setOrderTicketSetting(e){
this._orderViewDataStorage.saveSettings(e),this._setSettings()}_setState(e){this._state={...this._state,...e}}_setDisplayMode(e){this._mode$.next(e),this._saveWidgetMode(e)}_makeState(){var e,t,i,s;const r=window.is_authenticated,o=this._tradingLinking.value().symbol||"",n=this._realtimeProvider.activeBroker(),a=null==n?void 0:n.metainfo().configFlags,l=void 0!==a?(0,q.getDefaultOrderType)(a):null,u=null!==(i=null!==(t=null===(e=this._orderViewModel)||void 0===e?void 0:e.getOrderType())&&void 0!==t?t:l)&&void 0!==i?i:null,d=null!==(s=null==n?void 0:n.currentAccount())&&void 0!==s?s:null,h=n?n.metainfo().id:"";return this._orderViewDataStorage.setBrokerId(h),{isAuthenticated:r,broker:n,symbol:o,accountId:d,side:1,orderType:u,savableCustomFields:null}}async _createAndShowPositionViewModel({position:e,viewType:t,brackets:i,focus:s}){this._unsubscribeViewModels(),await this._closeOrderDialog(),await this._closePositionDialog(),e.symbol!==this._state.symbol&&this._setState({symbol:e.symbol});const{broker:r,symbol:o}=this._state,n=r?await r.isTradable(o):null;if(null===r||null===n||!n.tradable)return await this.showOrderView({order:this._createOrderStub()}),!1;const a=await r.getOrderDialogOptions(o),l=void 0!==(null==a?void 0:a.customFields)?Lt(a.customFields):void 0;this._setState({savableCustomFields:l});const u=t===vt.Position?r.editPositionBrackets.bind(r):r.editIndividualPositionBrackets.bind(r),d=new Pt({adapter:r,position:e,brackets:i,settings$:this._settings$,displayMode$:this._mode$,realtimeProvider:this._tradingCommands.realtimeProvider,isUndockAllowed:this._isOpeningTradingPanelAvailable.value(),isVisible:this._isVisible,toggleMode:this._toggleMode,getDisplayMode:this.getDisplayMode,toggleSettings:this._toggleSettings,getSettings:this._getSettings,viewType:t,pipValueType$:this._tradingCommands.pipValueType$,handler:u,trackEvent:this._tradingCommands.trackEvent,orderDialogOptions:a,headerState:this._orderViewHeaderState});return this._positionViewModel=d,await this._positionViewModel.onReady,this._positionViewModel!==d?Promise.reject("PositionViewModel was recreated during the initialization"):(this._subscribePositionViewModel(),this.getDisplayMode()===E.OrderEditorDisplayMode.ResizableDrawer?this._showPositionDrawer():this.getDisplayMode()===E.OrderEditorDisplayMode.Panel?this._openPositionPanel(s):this._showPositionDialog(s),this._positionViewModel.onDoneButtonClicked.promise)}_setSettings(){var e;if(null===this._state.broker)return;null===(e=this._settingsSubscription)||void 0===e||e.unsubscribe();let t=Object.assign({},$t.defaultSettings,this._orderViewDataStorage.getSettings());this._state.broker.metainfo().configFlags.supportCryptoBrackets&&(t=Object.assign({},$t.defaultCryptoBracketsSettings,t)),this._settings$.next(t),this._settingsSubscription=this._settings$.subscribe((e=>this._orderViewDataStorage.saveSettings(e)))}_createOrderStub(){return{limitPrice:void 0,stopPrice:void 0,qty:0,side:void 0,symbol:this._state.symbol,type:void 0,takeProfit:void 0,stopLoss:void 0}}_activateOrderTicket(){var e
;null===(e=this._orderViewModel)||void 0===e||e.activateOrderTicket()}_deactivateOrderTicket(){var e;null===(e=this._orderViewModel)||void 0===e||e.deactivateOrderTicket()}_handleTradedContextChange(e){null!==this._orderViewModel&&(null!==e?(this._setErrorsState(e.errors()),e.source()!==Dt&&(this._orderViewModel.setLoading(e.status()===Ct.PlaceOrEditContextStatus.Loading),this._orderViewModel.setStatus(Vt[e.type]),this._updateOrderValues(e.data()))):this._orderViewModel.getStatus()!==E.OrderPanelStatus.Editing&&this._orderViewModel.resetOrderPanel())}_setErrorsState(e){var t,i,s,r;if(null===this._orderViewModel)return;const o=e.stopLoss||e.trailingStopPips||e.guaranteedStop;e.limitPrice?this._orderViewModel.limitPriceModel.setControlError(!0,(0,y.getErrorMessage)(e.limitPrice)):this._orderViewModel.limitPriceModel.setControlError(!1),void 0!==e.stopPrice?this._orderViewModel.stopPriceModel.setControlError(!0,(0,y.getErrorMessage)(e.stopPrice)):this._orderViewModel.stopPriceModel.setControlError(!1),void 0!==e.qty?this._orderViewModel.quantityModel.setControlError(!0,(0,y.getErrorMessage)(e.qty)):this._orderViewModel.quantityModel.setControlError(!1),o?null===(t=this._orderViewModel.stopLossModel)||void 0===t||t.setControlError(!0,(0,y.getErrorMessage)(o)):null===(i=this._orderViewModel.stopLossModel)||void 0===i||i.setControlError(!1),e.takeProfit?null===(s=this._orderViewModel.takeProfitModel)||void 0===s||s.setControlError(!0,(0,y.getErrorMessage)(e.takeProfit)):null===(r=this._orderViewModel.takeProfitModel)||void 0===r||r.setControlError(!1)}_updateTakeProfitValues(e,t){const i=void 0!==t;e.getEnabled()!==i&&e.setEnabled(void 0!==t),i&&1!==e.getFocusedControl()&&e.setFocusedControl(1);const s=null!=t?t:null;i&&e.price.getValue()!==s&&e.price.setValue(s)}_updateStopLossValues(e){const{stopLossModel:t,stopLoss:i,trailingStopPips:s,guaranteedStop:r,stopType:o}=e,n=void 0!==i||void 0!==s||void 0!==r;t.getEnabled()!==n&&t.setEnabled(n),void 0!==o&&t.getBracketType()!==(0,q.getBracketTypeByStopType)(o)&&t.setBracketType((0,q.getBracketTypeByStopType)(o));const a=void 0!==s?0:1;n&&t.getFocusedControl()!==a&&t.setFocusedControl(a),void 0!==i&&t.price.getValue()!==i&&t.price.setValue(i),void 0!==r&&t.price.getValue()!==r&&t.price.setValue(r),void 0!==s&&t.pips.getValue()!==s&&t.pips.setValue(s)}async _openOrderPanel(e){await this._mountOrderPanel(e),this._openTradingPanelPage(St.TradingPage.OrderPanel)}async _mountOrderPanel(e){const{mountOrderPanel:t}=await Ot();null!==this._orderViewModel&&t({viewModel:this._orderViewModel,settings$:this._settings$,mode:this.getDisplayMode(),resizerBridgeElement:this._tradingPanelContainer,focus:e,trackEvent:this._trackEvent})}async _closeOrderPanel(){await this._unmountOrderPanel(),this._closeTradingPanel()}async _unmountOrderPanel(){const{unmountOrderPanel:e}=await Ot();e((0,r.ensureNotNull)(this._tradingPanelContainer))}async _showOrderDialog(e){const{showOrderDialog:t}=await Ot();null!==this._orderViewModel&&t({viewModel:this._orderViewModel,settings$:this._settings$,
mode:this.getDisplayMode(),focus:e,trackEvent:this._trackEvent,onOpen:e=>{this._dialogVisibility.setValue({isVisible:!0,isFullScreen:e})},onClose:()=>{var e;this._dialogVisibility.setValue({isVisible:!1}),null===(e=this._orderViewModel)||void 0===e||e.onDoneButtonClicked.resolve(!1),this._unsubscribeViewModels()}})}async _closeOrderDialog(){const{closeOrderDialog:e}=await Ot();e((()=>this._dialogVisibility.setValue({isVisible:!1})))}async _showOrderDrawer(e){const{showOrderDrawer:t}=await Ot();null!==this._orderViewModel&&t({viewModel:this._orderViewModel,settings$:this._settings$,mode:this.getDisplayMode(),focus:null!=e?e:this._getDefaultOrderTicketFocus(),trackEvent:this._trackEvent,onOpen:e=>{this._dialogVisibility.setValue({isVisible:!0,isFullScreen:e})},onClose:()=>{var e;this._dialogVisibility.setValue({isVisible:!1}),null===(e=this._orderViewModel)||void 0===e||e.onDoneButtonClicked.resolve(!1),this._unsubscribeViewModels()}})}_subscribeOrderViewModel(){var e;this._stopSubscriptions$=new o.Subject,null===(e=this._tradedContextLinking)||void 0===e||e.onContextChanged().subscribe(this,this._handleTradedContextChange),(0,r.ensureNotNull)(this._orderViewModel).onInputStateChanged().subscribe(this,this._onOrderWidgetInputStateChanged),(0,r.ensureNotNull)(this._orderViewModel).onCloseButtonClicked().subscribe(this,this._onOrderWidgetCloseButtonClicked),(0,r.ensureNotNull)(this._orderViewModel).onBackButtonClicked().subscribe(this,this._onOrderWidgetBackButtonClicked),(0,r.ensureNotNull)(this._orderViewModel).orderType$.pipe(h(this._stopSubscriptions$)).subscribe(this._onOrderTypeChanged),(0,r.ensureNotNull)(this._orderViewModel).status$.pipe(h(this._stopSubscriptions$)).subscribe(this._onOrderWidgetStatusChanged),this._mode$.pipe(h(this._stopSubscriptions$),(0,c.skip)(1)).subscribe(this._onOrderWidgetModeChanged)}_unsubscribeOrderViewModel(){var e;null===(e=this._tradedContextLinking)||void 0===e||e.onContextChanged().unsubscribe(this,this._handleTradedContextChange),this._stopSubscriptions$.next(),this._stopSubscriptions$.complete(),(0,r.ensureNotNull)(this._orderViewModel).onInputStateChanged().unsubscribe(this,this._onOrderWidgetInputStateChanged),(0,r.ensureNotNull)(this._orderViewModel).onCloseButtonClicked().unsubscribe(this,this._onOrderWidgetCloseButtonClicked),(0,r.ensureNotNull)(this._orderViewModel).onBackButtonClicked().unsubscribe(this,this._onOrderWidgetBackButtonClicked),(0,r.ensureNotNull)(this._orderViewModel).destroy(),this._orderViewModel=null}_getDefaultOrderTicketFocus(){var e;switch(null===(e=this._orderViewModel)||void 0===e?void 0:e.getOrderType()){case 2:return 5;case 1:case 4:return 1;case 3:return 2;default:return}}async _openPositionPanel(e){await this._mountPositionPanel(e),this._openTradingPanelPage(St.TradingPage.OrderPanel)}async _mountPositionPanel(e){const{mountPositionPanel:t}=await Bt();if(null!==this._positionViewModel)return t(this._positionViewModel,this._settings$,this.getDisplayMode(),this._tradingPanelContainer,e)}async _closePositionPanel(){
await this._unmountPositionPanel(),this._closeTradingPanel()}async _unmountPositionPanel(){const{unmountPositionPanel:e}=await Bt();e(this._tradingPanelContainer)}async _showPositionDialog(e){const{showPositionDialog:t}=await Bt();null!==this._positionViewModel&&t({viewModel:this._positionViewModel,settings$:this._settings$,mode:this.getDisplayMode(),focus:e,onOpen:e=>{this._dialogVisibility.setValue({isVisible:!0,isFullScreen:e})},onClose:()=>{var e;this._dialogVisibility.setValue({isVisible:!1}),null===(e=this._positionViewModel)||void 0===e||e.onDoneButtonClicked.resolve(!1),this._unsubscribeViewModels()}})}async _closePositionDialog(){const{closePositionDialog:e}=await Bt();e((()=>this._dialogVisibility.setValue({isVisible:!1})))}async _showPositionDrawer(e){const{showPositionDrawer:t}=await Bt();null!==this._positionViewModel&&t({viewModel:this._positionViewModel,settings$:this._settings$,mode:this.getDisplayMode(),focus:e,onOpen:e=>{this._dialogVisibility.setValue({isVisible:!0,isFullScreen:e})},onClose:()=>{var e;this._dialogVisibility.setValue({isVisible:!1}),null===(e=this._positionViewModel)||void 0===e||e.onDoneButtonClicked.resolve(!1),this._unsubscribeViewModels()}})}_subscribePositionViewModel(){this._stopSubscriptions$=new o.Subject,(0,r.ensureNotNull)(this._positionViewModel).onBackButtonClicked().subscribe(this,this._onPositionWidgetBackButtonClicked),(0,r.ensureNotNull)(this._positionViewModel).onCloseButtonClicked().subscribe(this,this._onPositionWidgetCloseButtonClicked),this._mode$.pipe(h(this._stopSubscriptions$),(0,c.skip)(1)).subscribe(this._onPositionWidgetModeChanged)}_unsubscribePositionViewModel(){this._stopSubscriptions$.next(),this._stopSubscriptions$.complete(),(0,r.ensureNotNull)(this._positionViewModel).onBackButtonClicked().unsubscribe(this,this._onPositionWidgetBackButtonClicked),(0,r.ensureNotNull)(this._positionViewModel).onCloseButtonClicked().unsubscribe(this,this._onPositionWidgetCloseButtonClicked),(0,r.ensureNotNull)(this._positionViewModel).onDoneButtonClicked.resolve(!1),(0,r.ensureNotNull)(this._positionViewModel).destroy(),this._positionViewModel=null}_makeOrderViewInputState(e,t,i,r){var o,n,a,l,u,d,h,c,p;const _=null!==r&&null!==t?null===(o=this._getTradingSettingsStorage())||void 0===o?void 0:o.customFields(e,t,Array.from(r)):null,y=null!==t?null===(n=this._getTradingSettingsStorage())||void 0===n?void 0:n.duration(e,t):null;return{symbol:e,side:i,orderType:t,limitPrice:null,stopPrice:null,quantity:(null===(a=this._getTradingSettingsStorage())||void 0===a?void 0:a.symbolQty(e))||null,orderSizeCalculatorQuantityType:this._isOrderSizeCalculatorEnabled&&(null===(l=this._getTradingSettingsStorage())||void 0===l?void 0:l.orderSizeCalculatorQuantityType(e))||null,lastRiskQuantityType:this._isOrderSizeCalculatorEnabled&&null!==(u=s.getValue(kt.settingsKeys.LAST_RISK_QUANTITY_TYPE))&&void 0!==u?u:null,lastUsedQuantityType:this._isOrderSizeCalculatorEnabled&&(null===(d=this._getTradingSettingsStorage())||void 0===d?void 0:d.lastUsedQuantityType(e))||null,
orderSizeCalculatorValue:this._isOrderSizeCalculatorEnabled&&(null===(h=this._getTradingSettingsStorage())||void 0===h?void 0:h.orderSizeCalculatorValue(e))||null,takeProfitPips:(null===(c=this._getTradingSettingsStorage())||void 0===c?void 0:c.takeProfitPips(e))||null,takeProfitPrice:null,stopLossPips:(null===(p=this._getTradingSettingsStorage())||void 0===p?void 0:p.stopLossPips(e))||null,stopLossPrice:null,duration:y||null,customFields:_||null,bracketType:null}}_commonOrderViewModelProps(){return{order:this._orderStub,settings$:this._settings$,displayMode$:this._mode$,orderWidgetStat:this._orderWidgetStat,isUndockAllowed:this._isOpeningTradingPanelAvailable.value(),pipValueType$:this._tradingCommands.pipValueType$,onNeedSelectBroker:this._tradingCommands.onNeedSelectBroker,trackEvent:this._tradingCommands.trackEvent,toggleTradingWidget:this._tradingCommands.toggleTradingWidget,toggleTradingPanelPopup:this._tradingCommands.toggleTradingPanelPopup,toggleMode:this._toggleMode,getDisplayMode:this.getDisplayMode,toggleSettings:this._toggleSettings,getSettings:this._getSettings,showErrorNotification:this._tradingCommands.showErrorNotification,qtySuggester:this._qtySuggester,isVisible:this._isVisible,headerState:this._orderViewHeaderState,isOrderPresetsEnabled:false}}_saveWidgetMode(e){e!==E.OrderEditorDisplayMode.ResizableDrawer&&this._orderViewDataStorage.setWidgetMode(e)}}},466479:(e,t,i)=>{"use strict";i.d(t,{CustomFieldsViewModel:()=>u});var s=i(947488),r=i(233064),o=i(323002),n=i(275734),a=i(586639),l=i(328810);class u{constructor({existingOrder:e,customFields:t,initialInputState:i,orderType$:a}){this._isEmptyRequiredCustomFieldsHighlighted$=new s.BehaviorSubject(!1),this._customFieldModels$=new s.BehaviorSubject([]),this._isCustomFieldsNotSelected$=new s.BehaviorSubject(!1),this._customFieldsInputValues$=new s.BehaviorSubject({}),this._subscriptions=[],this.getCustomFieldsInputValues=()=>this._customFieldsInputValues$.getValue(),this.isCustomFieldsNotSelected$=this._isCustomFieldsNotSelected$.asObservable(),this.customFieldsInputValues$=this._customFieldsInputValues$.asObservable(),this._orderType$=a,this._customFieldsModelOptions={modifyMode:e,existedValues:i,tradingDialogCustomFields:t,alwaysShowAttachedErrors$:this._isEmptyRequiredCustomFieldsHighlighted$.asObservable()},this.onControlFocused$=this._customFieldModels$.pipe((0,r.switchMap)((e=>(0,o.merge)(...e.map((e=>(0,n.fromEventPattern)((t=>e.onControlFocused.subscribe(null,t)),(t=>e.onControlFocused.unsubscribe(null,t)))))))))}subscribe(){const e=this._anyCustomFieldValueChangeObservable().subscribe((()=>{this._calculateCustomFieldsInputValues(),this._checkIsCustomFieldsNotSelected()})),t=this._orderType$.subscribe((e=>this._customFieldModels$.next((0,l.createCustomFieldModels)({...this._customFieldsModelOptions,currentOrderType:e}))));this._subscriptions.push(e,t)}unsubscribe(){this._subscriptions.forEach((e=>null==e?void 0:e.unsubscribe())),this._subscriptions=[],this._customFieldModels$.getValue().forEach((e=>e.destroy()))}
setIsEmptyRequiredCustomFieldsHighlighted(e){this._isEmptyRequiredCustomFieldsHighlighted$.next(e)}getIsCustomFieldsNotSelected(){return this._isCustomFieldsNotSelected$.getValue()}getCustomFieldsModels(){return this._customFieldModels$.getValue()}_checkIsCustomFieldsNotSelected(){const e=this._customFieldModels$.getValue().flatMap((e=>"ComboBox"===e.type&&void 0===e.getSelectedItem()?e:[]));this._isCustomFieldsNotSelected$.next(0!==e.length)}_anyCustomFieldValueChangeObservable(){return this._customFieldModels$.pipe((0,r.switchMap)((e=>(0,o.merge)(...e.map((e=>"TextWithCheckBox"===e.type?(0,o.merge)(e.checked$,e.text$):"TextField"===e.type?e.text$:"Checkbox"===e.type?e.checked$:"ComboBox"===e.type?e.selectedItem$:(0,a.of)(void 0)))))))}_calculateCustomFieldsInputValues(){const e=this._customFieldModels$.getValue(),t=this._getCustomFieldsInputValues(e);this._customFieldsInputValues$.next(t)}_getCustomFieldsInputValues(e){const t={};return e.forEach((e=>{"TextWithCheckBox"===e.type&&(t[e.id]={text:e.getText().replace(/&quote;/g,'"'),checked:e.getChecked()}),"TextField"===e.type&&(t[e.id]=e.getText()),"Checkbox"===e.type&&(t[e.id]=e.getChecked()),"ComboBox"===e.type&&(t[e.id]=e.getSelectedItem())})),t}}},73359:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M9 6h11v.5c0 1.115-.442 2.004-1.273 2.593-.7.498-1.637.755-2.727.814v2.267c2.867.677 5 3.252 5 6.326v.5h-6v4h-1v-4H8v-.5a6.502 6.502 0 0 1 5-6.326V9.907c-1.09-.059-2.027-.316-2.727-.814C9.443 8.503 9 7.615 9 6.5V6zm1.043 1c.102.56.383.976.809 1.278.57.405 1.452.642 2.648.642h.5V13.006l-.417.07A5.503 5.503 0 0 0 9.023 18h10.955a5.503 5.503 0 0 0-4.56-4.924l-.418-.07V8.92h.5c1.196 0 2.078-.237 2.648-.642A1.93 1.93 0 0 0 18.958 7h-8.915z"/></svg>'},350146:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M16.621 4.6l.354.354 7.07 7.071.354.354-.353.353c-.789.789-1.73 1.104-2.734.934-.847-.144-1.691-.624-2.504-1.353l-1.603 1.603a6.502 6.502 0 0 1-.937 8.008l-.354.354-.354-.354-3.889-3.889-2.828 2.829-.707-.707 2.828-2.829-3.889-3.889-.353-.353.353-.354a6.502 6.502 0 0 1 8.009-.937l1.603-1.604c-.73-.812-1.21-1.656-1.353-2.503-.17-1.005.145-1.945.934-2.734l.353-.354zm.03 1.445a1.93 1.93 0 0 0-.331 1.476c.117.689.573 1.48 1.418 2.326l.354.354-.354.353-2.236 2.237-.3.299-.344-.246a5.503 5.503 0 0 0-6.706.258l3.873 3.873 3.873 3.873a5.503 5.503 0 0 0 .257-6.706l-.245-.345.299-.3 2.236-2.236.354-.353.354.353c.845.846 1.637 1.302 2.326 1.419a1.93 1.93 0 0 0 1.476-.332l-6.303-6.303z"/></svg>'}}]);